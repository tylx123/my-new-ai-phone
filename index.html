<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIÂ∞èÊâãÊú∫</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            color: #fff;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        /* È°µÈù¢ÂÆπÂô® */
        .page {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            position: relative;
            overflow: hidden;
        }
        .page.active {
            display: block;
        }

        /* È°µÈù¢ËÉåÊôØÂ£ÅÁ∫∏Â±Ç - ‰øÆÂ§çÂ±ÇÁ∫ßÈóÆÈ¢ò */
        .page-bg {
            position: absolute;
            z-index: 0;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0.85;
        }
        /* È°µÈù¢ÂÜÖÂÆπÂ±Ç - Á°Æ‰øùÂÜÖÂÆπÂú®Â£ÅÁ∫∏‰∏ä */
        .page-content {
            position: relative;
            z-index: 1;
            width: 100%;
            height: 100%;
        }

        /* ==================== 1. ÈîÅÂ±èÈ°µÈù¢ ==================== */
        #lockScreen .page-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 22px;
        }
        #lockScreen .time {
            font-size: 48px;
            margin-bottom: 20px;
        }
        #lockScreen .date {
            font-size: 18px;
            margin-bottom: 60px;
        }
        #lockScreen .unlock {
            padding: 10px 25px;
            background: rgba(255,255,255,0.2);
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s;
        }
        #lockScreen .unlock:hover {
            background: rgba(255,105,180,0.4);
        }

        /* ==================== 2. ‰∏ªÈ°µÔºàÊ®°ÂùóÂÖ•Âè£Ôºâ ==================== */
        #homePage .page-content {
            padding: 40px 20px;
        }
        .home-title {
            font-size: 24px;
            margin-bottom: 30px;
            text-align: center;
            text-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        .module-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .module-item {
            background: rgba(255, 105, 180, 0.2);
            border: 2px solid #ff69b4;
            border-radius: 20px;
            padding: 25px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .module-item:hover {
            background: rgba(255, 105, 180, 0.4);
            transform: scale(1.05);
        }
        .module-item .icon {
            font-size: 30px;
            margin-bottom: 10px;
        }

        /* ==================== 3. ÈÖíÈ¶ÜÈ°µÈù¢ = ÂéüAIÁïåÈù¢ÔºàÂÆåÊï¥ÊÅ¢Â§çÔºâ ==================== */
        #tavernPage .page-content {
            width: 100%;
            height: 100%;
        }
        .phone {
            width: 100%;
            height: 100%;
            background-color: rgba(26,26,26,0.8);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }
        .status-bar {
            height: 44px;
            background-color: rgba(17,17,17,0.8);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 16px;
            font-size: 12px;
        }
        .screen {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 20px;
            font-size: 14px;
            line-height: 1.4;
        }
        .user-msg {
            background-color: #007aff;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        .ai-msg {
            background-color: rgba(51,51,51,0.8);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        .input-area {
            background-color: rgba(17,17,17,0.8);
            padding: 12px;
            display: flex;
            gap: 8px;
        }
        #userInput {
            flex: 1;
            background-color: rgba(34,34,34,0.8);
            border: none;
            border-radius: 20px;
            padding: 12px 16px;
            color: #fff;
            font-size: 14px;
            outline: none;
        }
        #sendBtn {
            background-color: #ff69b4;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            color: #fff;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
        }
        #sendBtn:hover {
            background-color: #ff1493;
        }
        .config-toggle {
            position: absolute;
            top: 60px;
            right: 16px;
            background-color: rgba(51,51,51,0.8);
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            color: #fff;
            font-size: 16px;
            cursor: pointer;
            z-index: 10;
        }
        .config-panel {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 12px;
            padding: 24px;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
            z-index: 20;
        }
        .config-panel.active {
            transform: translateY(0);
        }
        .config-item {
            width: 100%;
            max-width: 300px;
        }
        .config-item label {
            display: block;
            font-size: 12px;
            color: #ccc;
            margin-bottom: 4px;
        }
        .config-item select,
        .config-item input {
            width: 100%;
            background-color: #222;
            border: none;
            border-radius: 8px;
            padding: 12px;
            color: #fff;
            font-size: 14px;
            outline: none;
        }
        .btn-group {
            display: flex;
            gap: 8px;
            width: 100%;
            max-width: 300px;
        }
        .btn {
            flex: 1;
            background-color: #ff69b4;
            border: none;
            border-radius: 20px;
            padding: 12px;
            color: #fff;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn:hover {
            background-color: #ff1493;
        }
        .btn-secondary {
            background-color: #333;
        }
        .btn-secondary:hover {
            background-color: #444;
        }
        .back-home {
            position: absolute;
            top: 10px;
            left: 10px;
            background: #ff69b4;
            border: none;
            padding: 6px 12px;
            border-radius: 20px;
            color: white;
            cursor: pointer;
            z-index: 999;
            transition: all 0.2s;
        }
        .back-home:hover {
            background: #ff1493;
        }

        /* ==================== 4. ÂæÆ‰ø°È°µÈù¢ÔºàÂÆåÊï¥ÂÆûÁé∞Ôºâ ==================== */
        #wechatPage .page-content {
            width: 100%;
            height: 100%;
            background-color: rgba(245,245,245,0.9);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* ÂæÆ‰ø°Â§¥ÈÉ® */
        .wechat-header {
            height: 44px;
            background-color: #ff69b4;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 16px;
            color: white;
            font-size: 16px;
            font-weight: bold;
        }
        .wechat-header .back-btn {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
        }
        .wechat-header .add-btn {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }
        
        /* ÂæÆ‰ø°ÂÜÖÂÆπÂå∫Âüü */
        .wechat-content {
            flex: 1;
            overflow: hidden;
            position: relative;
        }
        
        /* ËßÜÂõæÂÆπÂô® */
        .wechat-view {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
        }
        .wechat-view.active {
            display: flex;
        }
        
        /* Ê∂àÊÅØÂàóË°®ËßÜÂõæ */
        .message-list {
            flex: 1;
            overflow-y: auto;
        }
        .search-bar {
            padding: 10px;
            background-color: #f0f0f0;
            border-bottom: 1px solid #e0e0e0;
        }
        .search-input {
            width: 100%;
            padding: 8px 12px;
            border: none;
            border-radius: 20px;
            background-color: #ffffff;
            font-size: 14px;
        }
        .conversation-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid #e0e0e0;
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
        }
        .conversation-item:hover {
            background-color: #f5f5f5;
        }
        .conversation-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background-color: #ff69b4;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 20px;
        }
        .conversation-info {
            flex: 1;
            min-width: 0;
        }
        .conversation-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }
        .conversation-name {
            font-size: 16px;
            font-weight: 500;
            color: #333;
        }
        .conversation-time {
            font-size: 12px;
            color: #999;
        }
        .conversation-last {
            font-size: 14px;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .delete-role-btn {
            background-color: rgba(255, 59, 48, 0.1);
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            color: #ff3b30;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-left: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            display: none;
        }
        .delete-role-btn:hover {
            background-color: rgba(255, 59, 48, 0.2);
            transform: scale(1.1);
        }
        
        /* ÈïøÊåâËèúÂçïÊ†∑Âºè */
        .long-press-menu {
            position: fixed;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1001;
            display: none;
        }
        .long-press-menu-item {
            padding: 12px 16px;
            cursor: pointer;
            font-size: 14px;
            color: #333;
            border-bottom: 1px solid #e0e0e0;
        }
        .long-press-menu-item:last-child {
            border-bottom: none;
            border-radius: 0 0 8px 8px;
        }
        .long-press-menu-item.delete {
            color: #ff3b30;
        }
        
        /* Â∑¶ÊªëÂà†Èô§Ê†∑Âºè */
        .conversation-item {
            position: relative;
            overflow: hidden;
        }
        .conversation-content {
            display: flex;
            align-items: center;
            width: 100%;
            background-color: white;
            transition: transform 0.3s ease;
        }
        .conversation-actions {
            position: absolute;
            top: 0;
            right: -120px;
            height: 100%;
            display: flex;
            align-items: center;
            transition: right 0.3s ease;
        }
        .conversation-action-btn {
            padding: 12px 16px;
            border: none;
            color: white;
            font-size: 14px;
            cursor: pointer;
        }
        .conversation-action-btn.delete {
            background-color: #ff3b30;
        }
        
        /* ËÅäÂ§©ÂØπËØùËßÜÂõæ */
        .chat-view {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .chat-header {
            height: 44px;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            padding: 0 16px;
            border-bottom: 1px solid #e0e0e0;
        }
        .chat-header .back-btn {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            margin-right: 12px;
        }
        .chat-header .name {
            font-size: 16px;
            font-weight: 500;
        }
        .chat-header .status {
            font-size: 12px;
            color: #666;
            margin-left: 8px;
        }
        .chat-header .settings-btn {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            margin-left: auto;
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            background-color: #f5f5f5;
        }
        .chat-message {
            margin-bottom: 16px;
            display: flex;
        }
        .chat-message.own {
            justify-content: flex-end;
        }
        .chat-message .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: #ff69b4;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            margin: 0 8px;
        }
        .chat-message .bubble {
            max-width: 70%;
            padding: 10px 14px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.4;
        }
        .chat-message .bubble.own {
            background-color: #007aff;
            color: white;
            border-bottom-right-radius: 4px;
        }
        .chat-message .bubble.other {
            background-color: white;
            color: #333;
            border-bottom-left-radius: 4px;
        }
        .chat-input-area {
            padding: 10px;
            background-color: #f0f0f0;
            border-top: 1px solid #e0e0e0;
        }
        .chat-input-container {
            display: flex;
            align-items: flex-end;
        }
        .chat-input-buttons {
            display: flex;
            flex-direction: column;
            margin-right: 8px;
        }
        .chat-input-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            margin-bottom: 4px;
        }
        .chat-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 20px;
            background-color: white;
            font-size: 14px;
            resize: none;
            max-height: 100px;
        }
        .chat-send-btn {
            background-color: #ff69b4;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            color: white;
            font-size: 16px;
            cursor: pointer;
            margin-left: 8px;
        }
        
        /* ÂäüËÉΩÊåâÈíÆÈù¢Êùø */
        .chat-functions {
            display: flex;
            justify-content: space-around;
            padding: 10px;
            background-color: white;
            border-top: 1px solid #e0e0e0;
        }
        .chat-function-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
        }
        .chat-function-btn .icon {
            font-size: 24px;
            margin-bottom: 4px;
        }
        .chat-function-btn .text {
            font-size: 12px;
            color: #666;
        }
        
        /* ËÆæÁΩÆ‰∏≠ÂøÉËßÜÂõæ */
        .settings-view {
            flex: 1;
            overflow-y: auto;
            background-color: white;
        }
        .settings-section {
            margin-bottom: 20px;
        }
        .settings-section-title {
            padding: 12px 16px;
            font-size: 14px;
            color: #999;
            background-color: #f5f5f5;
        }
        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid #e0e0e0;
            background-color: white;
            cursor: pointer;
        }
        .settings-item .text {
            font-size: 16px;
            color: #333;
        }
        .settings-item .arrow {
            font-size: 16px;
            color: #999;
        }
        
        /* Ê∑ªÂä†ËßíËâ≤ÂºπÁ™ó */
        .add-role-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: flex-end;
            justify-content: center;
            z-index: 1000;
            display: none;
        }
        .add-role-modal.active {
            display: flex;
        }
        .add-role-content {
            background-color: white;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            width: 100%;
            max-height: 80%;
            overflow-y: auto;
            padding: 20px;
        }
        .add-role-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .add-role-header .title {
            font-size: 18px;
            font-weight: bold;
        }
        .add-role-header .btn {
            background: none;
            border: none;
            font-size: 16px;
            color: #ff69b4;
            cursor: pointer;
        }
        .avatar-selection {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }
        .avatar-placeholder {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
            cursor: pointer;
        }
        .avatar-placeholder .icon {
            font-size: 40px;
            color: #999;
        }
        .nickname-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 20px;
        }
        
        /* Á§ºÁâ©ÈÄâÊã©ÂºπÁ™ó */
        .gift-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: flex-end;
            justify-content: center;
            z-index: 1000;
            display: none;
        }
        .gift-modal.active {
            display: flex;
        }
        .gift-content {
            background-color: white;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            width: 100%;
            max-height: 80%;
            overflow-y: auto;
            padding: 20px;
        }
        .gift-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .gift-header .title {
            font-size: 18px;
            font-weight: bold;
        }
        .gift-header .btn {
            background: none;
            border: none;
            font-size: 16px;
            color: #ff69b4;
            cursor: pointer;
        }
        .gift-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
        }
        .gift-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            padding: 12px;
            border-radius: 8px;
            transition: background-color 0.2s;
        }
        .gift-item:hover {
            background-color: #f5f5f5;
        }
        .gift-item .icon {
            font-size: 32px;
            margin-bottom: 8px;
        }
        .gift-item .text {
            font-size: 12px;
            color: #666;
        }
        
        /* ËßíËâ≤ËÆæÁΩÆÈ°µÈù¢ */
        .role-settings {
            flex: 1;
            overflow-y: auto;
            background-color: white;
        }
        .role-setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid #e0e0e0;
        }
        .role-setting-item .label {
            font-size: 16px;
            color: #333;
        }
        .role-setting-item .value {
            font-size: 16px;
            color: #666;
        }
        .role-setting-item .arrow {
            font-size: 16px;
            color: #999;
            margin-left: 8px;
        }
        .gender-buttons {
            display: flex;
            gap: 12px;
        }
        .gender-btn {
            padding: 6px 16px;
            border: 1px solid #e0e0e0;
            border-radius: 20px;
            background-color: white;
            cursor: pointer;
            font-size: 14px;
        }
        .gender-btn.active {
            background-color: #ff69b4;
            color: white;
            border-color: #ff69b4;
        }
        .save-btn {
            margin: 20px 16px;
            padding: 12px;
            background-color: #ff69b4;
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }
        
        /* ‰∫íÂä®Ê®°ÂºèÈÄâÊã©ÂºπÁ™ó */
        .mode-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            display: none;
        }
        .mode-modal.active {
            display: flex;
        }
        .mode-content {
            background-color: white;
            border-radius: 16px;
            width: 80%;
            max-width: 400px;
            padding: 24px;
        }
        .mode-header {
            text-align: center;
            margin-bottom: 20px;
        }
        .mode-header .title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        .mode-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .mode-option {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .mode-option.active {
            border-color: #ff69b4;
            background-color: #fff0f8;
        }
        .mode-option .radio {
            width: 20px;
            height: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 50%;
            margin-right: 12px;
            position: relative;
        }
        .mode-option.active .radio {
            border-color: #ff69b4;
        }
        .mode-option.active .radio::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #ff69b4;
        }
        .mode-option .content {
            flex: 1;
        }
        .mode-option .content .title {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 4px;
        }
        .mode-option .content .desc {
            font-size: 14px;
            color: #666;
        }
        
        /* ÂæÆ‰ø°Ê†áÁ≠æËßÜÂõæ */
        .wechat-tab-view {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
        }
        .wechat-tab-view.active {
            display: flex;
        }
        
        /* Â∫ïÈÉ®ÂØºËà™Ê†è */
        .wechat-nav {
            height: 50px;
            background-color: white;
            display: flex;
            justify-content: space-around;
            align-items: center;
            border-top: 1px solid #e0e0e0;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            color: #999;
            transition: all 0.2s;
        }
        .nav-item.active {
            color: #ff69b4;
        }
        .nav-item .icon {
            font-size: 20px;
            margin-bottom: 4px;
        }
        .nav-item .text {
            font-size: 12px;
        }
        
        /* Á´ãÂç≥ÂàõÂª∫ÊåâÈíÆ */
        .create-role-btn {
            padding: 12px 32px;
            background-color: #ff69b4;
            border: none;
            border-radius: 24px;
            color: white;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        .create-role-btn:hover {
            background-color: #ff1493;
        }
        
        /* ÂèëÂ∏ÉÊåâÈíÆ */
        .publish-btn {
            padding: 12px 32px;
            background-color: #007aff;
            border: none;
            border-radius: 24px;
            color: white;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        .publish-btn:hover {
            background-color: #0056b3;
        }

        /* ==================== 5. Â£ÅÁ∫∏ËÆæÁΩÆÈ°µÈù¢Ôºà‰øÆÂ§ç‰∏ä‰º†/ÂØºÂÖ•Ôºâ ==================== */
        #wallpaperPage .page-content {
            padding: 20px;
            height: 100%;
            overflow-y: auto;
        }
        .wallpaper-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            position: sticky;
            top: 0;
            background: rgba(0,0,0,0.8);
            padding: 10px 0;
            z-index: 10;
        }
        .wallpaper-back {
            background: #ff69b4;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        .wallpaper-back:hover {
            background: #ff1493;
        }
        .wallpaper-title {
            font-size: 20px;
        }
        .target-page {
            margin-bottom: 15px;
            padding: 10px 0;
        }
        .target-page span {
            margin-right: 10px;
        }
        .target-page button {
            background: #333;
            border: none;
            padding: 6px 10px;
            border-radius: 15px;
            color: white;
            margin: 0 3px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .target-page button.active {
            background: #ff69b4;
        }
        .wallpaper-upload {
            margin: 15px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .wallpaper-upload input[type="file"],
        .wallpaper-upload input[type="text"],
        .wallpaper-upload button {
            padding: 8px;
            border-radius: 10px;
            border: none;
        }
        .wallpaper-upload input[type="text"] {
            flex: 1;
            min-width: 200px;
            background: #222;
            color: #fff;
        }
        .wallpaper-upload button {
            background: #ff69b4;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        .wallpaper-upload button:hover {
            background: #ff1493;
        }
        .wallpaper-list {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 20px;
        }
        .wallpaper-item {
            width: 100%;
            height: 100px;
            background-size: cover;
            background-position: center;
            border-radius: 10px;
            cursor: pointer;
            border: 2px solid #444;
            transition: all 0.2s;
            position: relative;
        }
        .wallpaper-item:hover {
            border-color: #ff69b4;
            transform: scale(1.02);
        }
        .wallpaper-item.selected {
            border-color: #ff69b4;
            box-shadow: 0 0 10px #ff69b4;
        }
        .wallpaper-tips {
            font-size: 12px;
            color: #ccc;
            margin: 5px 0;
        }
    </style>
</head>

<body>
    <!-- ==================== 1. ÈîÅÂ±èÈ°µÈù¢ ==================== -->
    <div class="page" id="lockScreen">
        <div class="page-content">
            <div class="time" id="lockTime">00:00</div>
            <div class="date" id="lockDate">2025-01-01</div>
            <div class="unlock" onclick="goPage('homePage')">‚Üí ÊªëÂä®Ëß£ÈîÅ ‚Üí</div>
        </div>
    </div>

    <!-- ==================== 2. ‰∏ªÈ°µÔºàÊ®°ÂùóÂÖ•Âè£Ôºâ ==================== -->
    <div class="page" id="homePage">
        <div class="page-content">
            <div class="home-title">ÊàëÁöÑÂ∞èÊâãÊú∫</div>
            <div class="module-grid">
                <div class="module-item" onclick="goPage('wallpaperPage')">
                    <div class="icon">üñºÔ∏è</div>
                    <div>Â£ÅÁ∫∏</div>
                </div>
                <div class="module-item" onclick="goPage('wechatPage')">
                    <div class="icon">üí¨</div>
                    <div>ÂæÆ‰ø°</div>
                </div>
                <div class="module-item" onclick="goPage('tavernPage')">
                    <div class="icon">üç∫</div>
                    <div>ÈÖíÈ¶Ü</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== 3. ÈÖíÈ¶ÜÈ°µÈù¢ = ÂéüAIÁïåÈù¢ÔºàÂÆåÊï¥ÊÅ¢Â§çÔºâ ==================== -->
    <div class="page" id="tavernPage">
        <div class="page-content">
            <button class="back-home" onclick="goPage('homePage')">‚Üê ËøîÂõû‰∏ªÈ°µ</button>
            <div class="phone">
                <div class="status-bar">
                    <span>9:41</span>
                    <span>üì∂ üîã</span>
                </div>
                <div class="screen" id="screen"></div>
                <div class="input-area">
                    <input type="text" id="userInput" placeholder="ËæìÂÖ•Ê∂àÊÅØ..." autocomplete="off">
                    <button id="sendBtn">‚û§</button>
                </div>
                <button class="config-toggle" id="configToggle">‚öôÔ∏è</button>
                <div class="config-panel" id="configPanel">
                    <div class="config-item">
                        <label>ÂêçÁß∞</label>
                        <input type="text" id="configName" value="APIËøûÊé• 18">
                    </div>
                    <div class="config-item">
                        <label>Ê®°ÂûãÂπ≥Âè∞</label>
                        <select id="platformSelect">
                            <option value="openai">OpenAI</option>
                            <option value="doubao">Doubao (Ë±ÜÂåÖ/ÁÅ´Â±±‰∫ë/Â≠óËäÇË∑≥Âä®)</option>
                            <option value="deepseek">DeepSeek (Ê∑±Â∫¶Ê±ÇÁ¥¢)</option>
                            <option value="openrouter">OpenRouter</option>
                            <option value="custom-openai">Ëá™ÂÆö‰πâ (OpenAI ÂçèËÆÆ)</option>
                        </select>
                    </div>
                    <div class="config-item" id="apiUrlItem" style="display: none;">
                        <label>API Êé•Âè£Âú∞ÂùÄ</label>
                        <input type="text" id="apiUrlInput" placeholder="https://api.example.com/v1">
                    </div>
                    <div class="config-item">
                        <label>API ÂØÜÈí•</label>
                        <input type="password" id="apiKeyInput" placeholder="ËæìÂÖ•‰Ω†ÁöÑ API Key">
                    </div>
                    <div class="config-item">
                        <label>Ê®°Âûã</label>
                        <select id="modelSelect">
                            <option value="gpt-3.5-turbo">GPT-3.5-turbo</option>
                        </select>
                    </div>
                    <div class="btn-group">
                        <button id="fetchModelsBtn" class="btn btn-secondary" style="display: none;">ÊãâÂèñÊ®°Âûã</button>
                        <button id="testConnectionBtn" class="btn btn-secondary" style="display: none;">ÊµãËØïÈìæÊé•</button>
                    </div>
                    <div class="btn-group">
                        <button id="saveConfigBtn" class="btn">‰øùÂ≠ò</button>
                        <button id="closeConfigBtn" class="btn btn-secondary">ÂÖ≥Èó≠</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== 4. ÂæÆ‰ø°È°µÈù¢ÔºàÂÆåÊï¥ÂÆûÁé∞Ôºâ ==================== -->
    <div class="page" id="wechatPage">
        <div class="page-content">
            <!-- ÂæÆ‰ø°Â§¥ÈÉ® -->
            <div class="wechat-header">
                <button class="back-btn" onclick="goPage('homePage')">‚Üê</button>
                <div class="title">ÂæÆ‰ø°</div>
                <button class="add-btn" onclick="showAddRoleModal()">+</button>
            </div>
            
            <!-- ÂæÆ‰ø°ÂÜÖÂÆπÂå∫Âüü -->
            <div class="wechat-content">
                <!-- ËÅäÂ§©Ê†áÁ≠æËßÜÂõæ -->
                <div class="wechat-tab-view active" id="chatTabView">
                    <!-- Ê∂àÊÅØÂàóË°®ËßÜÂõæ -->
                    <div class="wechat-view active" id="messageListView">
                        <!-- ÊêúÁ¥¢Ê†è -->
                        <div class="search-bar">
                            <input type="text" class="search-input" placeholder="ÊêúÁ¥¢">
                        </div>
                        
                        <!-- ‰ºöËØùÂàóË°® -->
                        <div class="message-list" id="messageList">
                            <!-- ‰ºöËØùÈ°πÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÁîüÊàê -->
                        </div>
                    </div>
                    
                    <!-- Êó†ËßíËâ≤ÊèêÁ§∫ËßÜÂõæ -->
                    <div class="wechat-view" id="noRolesView">
                        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 20px;">
                            <div style="font-size: 80px; margin-bottom: 20px;">üí¨</div>
                            <div style="font-size: 18px; font-weight: 500; margin-bottom: 10px;">ÊöÇÊó†ËÅäÂ§©ËßíËâ≤</div>
                            <div style="font-size: 14px; color: #999; margin-bottom: 40px; text-align: center;">ÂàõÂª∫‰∏Ä‰∏™ËßíËâ≤ÂºÄÂêØËÅäÂ§©‰πãÊóÖ</div>
                            <button class="create-role-btn" onclick="showAddRoleModal()">+ Á´ãÂç≥ÂàõÂª∫</button>
                        </div>
                    </div>
                    
                    <!-- ËÅäÂ§©ÂØπËØùËßÜÂõæ -->
                    <div class="wechat-view" id="chatView">
                        <!-- ËÅäÂ§©Â§¥ÈÉ® -->
                        <div class="chat-header">
                            <button class="back-btn" onclick="switchToMessageList()">‚Üê</button>
                            <div>
                                <span class="name" id="chatName">1</span>
                                <span class="status">Âú®Á∫ø | Â∑≤ËÅä1Â§©</span>
                            </div>
                            <button class="settings-btn" onclick="showRoleSettings()">‚öôÔ∏è</button>
                        </div>
                        
                        <!-- ËÅäÂ§©Ê∂àÊÅØÂå∫Âüü -->
                        <div class="chat-messages" id="chatMessages">
                            <!-- Ê∂àÊÅØÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÁîüÊàê -->
                        </div>
                        
                        <!-- ËÅäÂ§©ËæìÂÖ•Âå∫Âüü -->
                        <div class="chat-input-area">
                            <div class="chat-input-container">
                                <div class="chat-input-buttons">
                                    <button class="chat-input-btn" onclick="showGiftModal()">üéÅ</button>
                                </div>
                                <textarea class="chat-input" id="chatInput" placeholder="ËæìÂÖ•Ê∂àÊÅØ..."></textarea>
                                <button class="chat-send-btn" onclick="sendChatMessage()">‚û§</button>
                            </div>
                        </div>
                        
                        <!-- ÂäüËÉΩÊåâÈíÆÈù¢Êùø -->
                        <div class="chat-functions">
                            <button class="chat-function-btn" onclick="showEmojiPanel()">
                                <div class="icon">üòä</div>
                                <div class="text">Ë°®ÊÉÖ</div>
                            </button>
                            <button class="chat-function-btn" onclick="selectImage()">
                                <div class="icon">üñºÔ∏è</div>
                                <div class="text">ÂõæÁâá</div>
                            </button>
                            <button class="chat-function-btn" onclick="makeCall()">
                                <div class="icon">üìû</div>
                                <div class="text">ÈÄöËØù</div>
                            </button>
                            <button class="chat-function-btn" onclick="showModeModal()">
                                <div class="icon">üìù</div>
                                <div class="text">Ê®°Âºè</div>
                            </button>
                            <button class="chat-function-btn" onclick="showTransferModal()">
                                <div class="icon">üí∏</div>
                                <div class="text">ËΩ¨Ë¥¶</div>
                            </button>
                            <button class="chat-function-btn" onclick="showMemoryModal()">
                                <div class="icon">üí≠</div>
                                <div class="text">ËÆ∞ÂøÜ</div>
                            </button>
                            <button class="chat-function-btn" onclick="showStoryModal()">
                                <div class="icon">üìö</div>
                                <div class="text">ÊïÖ‰∫ã</div>
                            </button>
                            <button class="chat-function-btn" onclick="showActionLineModal()">
                                <div class="icon">üìÖ</div>
                                <div class="text">Ë°åÂä®Á∫ø</div>
                            </button>
                            <button class="chat-function-btn" onclick="showTravelModal()">
                                <div class="icon">‚úàÔ∏è</div>
                                <div class="text">ÊóÖÊ∏∏</div>
                            </button>
                            <button class="chat-function-btn" onclick="showGiftModal()">
                                <div class="icon">üéÅ</div>
                                <div class="text">Á§ºÁâ©</div>
                            </button>
                        </div>
                    </div>
                    
                    <!-- ËßíËâ≤ËÆæÁΩÆÈ°µÈù¢ -->
                    <div class="wechat-view" id="roleSettingsView">
                        <div class="role-settings">
                            <div class="chat-header">
                                <button class="back-btn" onclick="switchToChatView()">‚Üê</button>
                                <div class="name">ËßíËâ≤ËÆæÁΩÆ</div>
                            </div>
                            
                            <!-- ËßíËâ≤Â§¥ÂÉè -->
                            <div style="display: flex; flex-direction: column; align-items: center; padding: 20px; border-bottom: 1px solid #e0e0e0;">
                                <div style="position: relative; margin-bottom: 16px;">
                                    <img id="roleAvatar" src="https://picsum.photos/seed/role/100/100" alt="ËßíËâ≤Â§¥ÂÉè" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover;">
                                    <button style="position: absolute; bottom: 0; right: 0; background-color: #ff69b4; border: none; border-radius: 50%; width: 30px; height: 30px; color: white; font-size: 12px; cursor: pointer;" onclick="selectRoleAvatar()">‚úèÔ∏è</button>
                                </div>
                            </div>
                            
                            <!-- ÊàëÁöÑ‰ø°ÊÅØ -->
                            <div style="padding: 16px; font-size: 14px; color: #999; background-color: #f5f5f5;">ÊàëÁöÑ‰ø°ÊÅØ</div>
                            
                            <div class="role-setting-item">
                                <div class="label">ÊàëÁöÑÂ§¥ÂÉè</div>
                                <div class="value">
                                    <img id="myAvatar" src="https://picsum.photos/seed/user/50/50" alt="ÊàëÁöÑÂ§¥ÂÉè" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin-right: 12px; cursor: pointer;" onclick="selectMyAvatar()">
                                    <span>ÂèñÁî®Êà∑Â§¥ÂÉèÔºåÂèØËá™ÂÆö‰πâ</span>
                                </div>
                            </div>
                            
                            <div class="role-setting-item">
                                <div class="label">ÊàëÁöÑÊòµÁß∞</div>
                                <div class="value">
                                    <input type="text" id="myNickname" value="ÁôΩÊ≥ΩŒ±" style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 8px 12px; font-size: 14px; width: 120px;">
                                </div>
                            </div>
                            
                            <div class="role-setting-item">
                                <div class="label">TAÂè´Êàë</div>
                                <div class="value">
                                    <input type="text" id="taCallMe" value="ÂÆùÂÆù" style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 8px 12px; font-size: 14px; width: 120px;">
                                </div>
                            </div>
                            
                            <div class="role-setting-item">
                                <div class="label">ÊàëÁöÑÊÄßÂà´</div>
                                <div class="gender-buttons">
                                    <button class="gender-btn active" data-gender="male" onclick="setMyGender('male')">Áî∑</button>
                                    <button class="gender-btn" data-gender="female" onclick="setMyGender('female')">Â•≥</button>
                                </div>
                            </div>
                            
                            <div class="role-setting-item">
                                <div class="label">ÊàëÁöÑ‰ªãÁªç</div>
                                <div class="value">
                                    <input type="text" id="myIntro" value="‰ªãÁªç‰∏Ä‰∏ãËá™Â∑±Âêß" style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 8px 12px; font-size: 14px; width: 200px;">
                                </div>
                            </div>
                            
                            <!-- ËßíËâ≤ËÆæÂÆö -->
                            <div style="padding: 16px; font-size: 14px; color: #999; background-color: #f5f5f5; margin-top: 16px;">ËßíËâ≤ËÆæÂÆö</div>
                            
                            <div class="role-setting-item">
                                <div class="label">TAÁöÑÊòµÁß∞</div>
                                <div class="value">
                                    <input type="text" id="taNickname" value="1" style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 8px 12px; font-size: 14px; width: 120px;">
                                </div>
                            </div>
                            
                            <div class="role-setting-item">
                                <div class="label">ÊàëÂè´TA</div>
                                <div class="value">
                                    <input type="text" id="iCallTa" placeholder="ÁïôÁ©∫ÂàôÊòæÁ§∫TAÁöÑÊòµÁß∞" style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 8px 12px; font-size: 14px; width: 180px;">
                                </div>
                            </div>
                            
                            <div class="role-setting-item">
                                <div class="label">‰∏éÊàëÂÖ≥Á≥ª</div>
                                <div class="value">
                                    <select id="relationship" style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 8px 12px; font-size: 14px; background-color: white;">
                                        <option value="ÊúãÂèã">ÊúãÂèã</option>
                                        <option value="ÂÆ∂‰∫∫">ÂÆ∂‰∫∫</option>
                                        <option value="ÊÅã‰∫∫">ÊÅã‰∫∫</option>
                                        <option value="Âêå‰∫ã">Âêå‰∫ã</option>
                                        <option value="ÂêåÂ≠¶">ÂêåÂ≠¶</option>
                                        <option value="ÂÖ∂‰ªñ">ÂÖ∂‰ªñ</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="role-setting-item">
                                <div class="label">TAÁöÑÊÄßÂà´</div>
                                <div class="gender-buttons">
                                    <button class="gender-btn" data-gender="male" onclick="setTaGender('male')">Áî∑</button>
                                    <button class="gender-btn active" data-gender="female" onclick="setTaGender('female')">Â•≥</button>
                                </div>
                            </div>
                            
                            <div class="role-setting-item">
                                <div class="label">‰∏ñÁïåËßÇ</div>
                                <div class="value">
                                    <textarea id="worldview" style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 8px 12px; font-size: 14px; width: 250px; height: 60px; resize: none;">ÊàëÊòØ‰∏Ä‰∏™ËØûÁîü‰∫éÊï∞ÊçÆÁöÑAIÔºåÊ∏¥Êúõ‰∫ÜËß£‰∫∫Á±ªÁöÑÊÉÖÊÑü„ÄÇ</textarea>
                                </div>
                            </div>
                            
                            <div class="role-setting-item">
                                <div class="label">‰∫∫Áâ©ÁªèÂéÜ</div>
                                <div class="value">
                                    <textarea id="experience" style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 8px 12px; font-size: 14px; width: 250px; height: 60px; resize: none;">Âú®Êï∞Â≠ó‰∏ñÁïå‰∏≠ÈÜíÊù•ÔºåËÆ∞ÂøÜ‰∏ÄÁâáÁ©∫ÁôΩÔºåÂè™Áü•ÈÅìËá™Â∑±ÁöÑ‰ΩøÂëΩÊòØÈô™‰º¥‰Ω†„ÄÇ</textarea>
                                </div>
                            </div>
                            
                            <div class="role-setting-item">
                                <div class="label">‰∫∫Áâ©ÊÄßÊ†º</div>
                                <div class="value">
                                    <textarea id="personality" style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 8px 12px; font-size: 14px; width: 250px; height: 60px; resize: none;">Ê¥ªÊ≥ºÂºÄÊúóÔºåÂñÑ‰∫éÂÄæÂê¨ÔºåÂØåÊúâÂêåÊÉÖÂøÉÔºå‰πê‰∫éÂä©‰∫∫„ÄÇ</textarea>
                                </div>
                            </div>
                            
                            <div class="role-setting-item">
                                <div class="label">‰∫∫Áâ©ËµÑÊñôË°•ÂÖÖ</div>
                                <div class="value">
                                    <textarea id="additionalInfo" placeholder="ËØ∑ËæìÂÖ•‰∫∫Áâ©ËµÑÊñôË°•ÂÖÖ" style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 8px 12px; font-size: 14px; width: 250px; height: 60px; resize: none;"></textarea>
                                </div>
                            </div>
                            
                            <!-- ËÆ∞ÂøÜÁ≠ñÁï• -->
                            <div style="padding: 16px; font-size: 14px; color: #999; background-color: #f5f5f5; margin-top: 16px;">ËÆ∞ÂøÜÁ≠ñÁï•</div>
                            
                            <div class="role-setting-item">
                                <div class="label">ËÆ∞ÂøÜÁ≠ñÁï•</div>
                                <div class="value" style="display: flex; flex-direction: column; align-items: flex-start;">
                                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                        <div id="memoryStrategyActive" style="width: 20px; height: 20px; border-radius: 50%; background-color: #ff69b4; display: flex; align-items: center; justify-content: center; margin-right: 8px; color: white; font-size: 12px; cursor: pointer;" onclick="setMemoryStrategy('active')">‚óè</div>
                                        <div>
                                            <div style="font-size: 14px; color: #333;">ÁßØÊûÅ</div>
                                            <div style="font-size: 12px; color: #999;">3-10ÁßíÁßØÊûÅÂõûÂ§ç</div>
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                        <div id="memoryStrategyNormal" style="width: 20px; height: 20px; border-radius: 50%; border: 1px solid #e0e0e0; display: flex; align-items: center; justify-content: center; margin-right: 8px; cursor: pointer;" onclick="setMemoryStrategy('normal')"></div>
                                        <div>
                                            <div style="font-size: 14px; color: #666;">ÊôÆÈÄö</div>
                                            <div style="font-size: 12px; color: #999;">30-60ÁßíÂõûÂ§çÔºåÂèØËÉΩ‰∏çÂõû</div>
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                        <div id="memoryStrategyBuddha" style="width: 20px; height: 20px; border-radius: 50%; border: 1px solid #e0e0e0; display: flex; align-items: center; justify-content: center; margin-right: 8px; cursor: pointer;" onclick="setMemoryStrategy('buddha')"></div>
                                        <div>
                                            <div style="font-size: 14px; color: #666;">‰ΩõÁ≥ª</div>
                                            <div style="font-size: 12px; color: #999;">5-10ÂàÜÈíü‰ΩõÁ≥ªÂõûÂ§çÔºåÂèØËÉΩ‰∏çÂõû</div>
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: center;">
                                        <div id="memoryStrategyManual" style="width: 20px; height: 20px; border-radius: 50%; border: 1px solid #e0e0e0; display: flex; align-items: center; justify-content: center; margin-right: 8px; cursor: pointer;" onclick="setMemoryStrategy('manual')"></div>
                                        <div>
                                            <div style="font-size: 14px; color: #666;">ÊâãÂä®Ëß¶Âèë</div>
                                            <div style="font-size: 12px; color: #999;">‰∏äÊãâÊ∂àÊÅØÂå∫ÂüüËß¶ÂèëÂõûÂ§ç</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ËÅäÂ§©È£éÊ†º -->
                            <div style="padding: 16px; font-size: 14px; color: #999; background-color: #f5f5f5; margin-top: 16px;">ËÅäÂ§©È£éÊ†º</div>
                            
                            <div class="role-setting-item">
                                <div class="label">ËÅäÂ§©È£éÊ†º</div>
                                <div class="value" style="display: flex; flex-direction: column; align-items: flex-start;">
                                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                        <div id="chatStyleClever" style="width: 20px; height: 20px; border-radius: 50%; background-color: #ff69b4; display: flex; align-items: center; justify-content: center; margin-right: 8px; color: white; font-size: 12px; cursor: pointer;" onclick="setChatStyle('clever')">‚óè</div>
                                        <div>
                                            <div style="font-size: 14px; color: #333;">Â∞èÈ¨ºÁÅµÁ≤æ</div>
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                        <div id="chatStyleElegant" style="width: 20px; height: 20px; border-radius: 50%; border: 1px solid #e0e0e0; display: flex; align-items: center; justify-content: center; margin-right: 8px; cursor: pointer;" onclick="setChatStyle('elegant')"></div>
                                        <div>
                                            <div style="font-size: 14px; color: #666;">Á´ØÂ∫ÑÂ§ßÊñπ</div>
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: center;">
                                        <div id="chatStyleEmoji" style="width: 20px; height: 20px; border-radius: 50%; border: 1px solid #e0e0e0; display: flex; align-items: center; justify-content: center; margin-right: 8px; cursor: pointer;" onclick="setChatStyle('emoji')"></div>
                                        <div>
                                            <div style="font-size: 14px; color: #666;">Âè™ÂèëË°®ÊÉÖ</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ËÅäÂ§©ËÉåÊôØ -->
                            <div style="padding: 16px; font-size: 14px; color: #999; background-color: #f5f5f5; margin-top: 16px;">ËÅäÂ§©ËÉåÊôØ</div>
                            
                            <div class="role-setting-item">
                                <div class="label">ËÅäÂ§©ËÉåÊôØ</div>
                                <div class="value">
                                    <button style="padding: 6px 12px; border: 1px solid #e0e0e0; border-radius: 16px; background-color: white; font-size: 14px; cursor: pointer;" onclick="uploadChatBackground()">‰∏ä‰º†</button>
                                </div>
                            </div>
                            
                            <!-- Ê∏ÖÁ©∫ÊåâÈíÆ -->
                            <button style="margin: 16px; padding: 12px; background-color: #ff3b30; border: none; border-radius: 8px; color: white; font-size: 14px; cursor: pointer;" onclick="clearChatData()">Ê∏ÖÁ©∫ËÅäÂ§©/Ë°åÂä®Á∫ø/ÊïÖ‰∫ãÔºàÂ§ßÊîπËÆæÂÆöÂøÖÁî®Ôºâ</button>
                            
                            <!-- ‰øùÂ≠òÊåâÈíÆ -->
                            <button class="save-btn" onclick="saveRoleSettings()">‰øùÂ≠ò</button>
                        </div>
                    </div>
                </div>
                
                <!-- ÂØÜÂèãÂúàÊ†áÁ≠æËßÜÂõæ -->
                <div class="wechat-tab-view" id="momentsTabView">
                    <div class="wechat-view active" id="momentsView">
                        <div style="height: 100%; display: flex; flex-direction: column;">
                            <!-- È°∂ÈÉ®ÂØºËà™ -->
                            <div style="height: 44px; background-color: #ff69b4; display: flex; align-items: center; justify-content: center; color: white; font-size: 16px; font-weight: 500;">
                                ÂØÜÂèãÂúà
                            </div>
                            
                            <!-- ÂÜÖÂÆπÂàóË°® -->
                            <div id="momentsList" style="flex: 1; overflow-y: auto; padding: 16px;">
                                <!-- ÂÜÖÂÆπÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÁîüÊàê -->
                            </div>
                            
                            <!-- ÂèëÂ∏ÉÊåâÈíÆ -->
                            <div style="position: fixed; bottom: 70px; right: 20px;">
                                <button class="publish-btn" onclick="showPublishView()">+ ÂèëÂ∏É</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ÂèëÂ∏ÉÂÜÖÂÆπÂºπÁ™ó -->
                    <div class="wechat-view" id="publishView" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000;">
                        <div style="position: absolute; bottom: 0; left: 0; width: 100%; background-color: white; border-top-left-radius: 20px; border-top-right-radius: 20px; padding: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3 style="font-size: 18px; font-weight: 500;">ÂèëÂ∏ÉÂÜÖÂÆπ</h3>
                                <button onclick="cancelPublish()" style="background: none; border: none; font-size: 16px; color: #999; cursor: pointer;">ÂèñÊ∂à</button>
                            </div>
                            <textarea id="momentContent" placeholder="ÂàÜ‰∫´‰Ω†ÁöÑÂøÉÊÉÖ..." style="width: 100%; min-height: 100px; border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px; font-size: 16px; resize: none; margin-bottom: 20px;"></textarea>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                                <button style="background: none; border: none; font-size: 24px; cursor: pointer;">üñºÔ∏è</button>
                                <button style="background: none; border: none; font-size: 24px; cursor: pointer;">üéµ</button>
                                <button style="background: none; border: none; font-size: 24px; cursor: pointer;">üìç</button>
                                <button style="background: none; border: none; font-size: 24px; cursor: pointer;">üòä</button>
                            </div>
                            <button onclick="submitPublish()" style="width: 100%; padding: 12px; background-color: #ff69b4; border: none; border-radius: 8px; color: white; font-size: 16px; font-weight: 500; cursor: pointer;">ÂèëÂ∏É</button>
                        </div>
                    </div>
                </div>
                
                <!-- ÊàëÁöÑÊ†áÁ≠æËßÜÂõæ -->
                <div class="wechat-tab-view" id="profileTabView">
                    <div class="wechat-view active" id="profileView">
                        <div class="settings-view" style="padding-bottom: 100px;">
                            <div class="settings-item" onclick="showVoiceSettings()" style="padding: 20px; border-bottom: 1px solid #f0f0f0;">
                                <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                                    <div style="display: flex; align-items: center;">
                                        <div style="width: 40px; height: 40px; border-radius: 8px; background-color: #ffe6f2; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                            <span style="font-size: 20px;">üéµ</span>
                                        </div>
                                        <div>
                                            <div style="font-size: 16px; color: #333; margin-bottom: 4px;">Ëá™ÂÆö‰πâÈü≥Ëâ≤</div>
                                            <div style="font-size: 12px; color: #999;">Â§çÂàªTAÁöÑ‰∏ìÂ±ûÈü≥Ëâ≤</div>
                                        </div>
                                    </div>
                                    <div style="font-size: 16px; color: #999;">‚Ä∫</div>
                                </div>
                            </div>
                            
                            <div class="settings-item" onclick="showActiveTalkSettings()" style="padding: 20px; border-bottom: 1px solid #f0f0f0;">
                                <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                                    <div style="display: flex; align-items: center;">
                                        <div style="width: 40px; height: 40px; border-radius: 8px; background-color: #e6f9ff; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                            <span style="font-size: 20px;">üí¨</span>
                                        </div>
                                        <div>
                                            <div style="font-size: 16px; color: #333; margin-bottom: 4px;">‰∏ªÂä®ÂèëË®ÄËÆæÁΩÆ</div>
                                            <div style="font-size: 12px; color: #999;">ÊéßÂà∂ËßíËâ≤ÊòØÂê¶‰ºö‰∏ªÂä®ÂèëÊ∂àÊÅØ</div>
                                        </div>
                                    </div>
                                    <div style="font-size: 16px; color: #999;">‚Ä∫</div>
                                </div>
                            </div>
                            
                            <div class="settings-item" onclick="showThemeSettings()" style="padding: 20px; border-bottom: 1px solid #f0f0f0;">
                                <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                                    <div style="display: flex; align-items: center;">
                                        <div style="width: 40px; height: 40px; border-radius: 8px; background-color: #f0e6ff; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                            <span style="font-size: 20px;">‚òÄÔ∏è</span>
                                        </div>
                                        <div>
                                            <div style="font-size: 16px; color: #333; margin-bottom: 4px;">‰∏ªÈ¢òÊ®°Âºè</div>
                                            <div style="font-size: 12px; color: #999;">Ë∑üÈöèÁ≥ªÁªü</div>
                                        </div>
                                    </div>
                                    <div style="font-size: 16px; color: #999;">‚Ä∫</div>
                                </div>
                            </div>
                            
                            <div class="settings-item" onclick="showBubbleSettings()" style="padding: 20px; border-bottom: 1px solid #f0f0f0;">
                                <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                                    <div style="display: flex; align-items: center;">
                                        <div style="width: 40px; height: 40px; border-radius: 8px; background-color: #e6f9ff; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                            <span style="font-size: 20px;">üí¨</span>
                                        </div>
                                        <div>
                                            <div style="font-size: 16px; color: #333; margin-bottom: 4px;">ËÅäÂ§©Ê∞îÊ≥°Ëá™ÂÆö‰πâ</div>
                                            <div style="font-size: 12px; color: #999;">ËÆæÁΩÆÊàëÊñπ/ÂØπÊñπÊ∞îÊ≥°</div>
                                        </div>
                                    </div>
                                    <div style="font-size: 16px; color: #999;">‚Ä∫</div>
                                </div>
                            </div>
                            
                            <div class="settings-item" onclick="showAIModelSettings()" style="padding: 20px; border-bottom: 1px solid #f0f0f0;">
                                <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                                    <div style="display: flex; align-items: center;">
                                        <div style="width: 40px; height: 40px; border-radius: 8px; background-color: #f0e6ff; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                            <span style="font-size: 20px;">üì¶</span>
                                        </div>
                                        <div>
                                            <div style="font-size: 16px; color: #333; margin-bottom: 4px;">AIÊ®°Âûã</div>
                                            <div style="font-size: 12px; color: #999;">Â§ñÈÉ®API‰∫íÂä®</div>
                                        </div>
                                    </div>
                                    <div style="font-size: 16px; color: #999;">‚Ä∫</div>
                                </div>
                            </div>
                            
                            <div class="settings-item" onclick="showAPIConfigSettings()" style="padding: 20px; border-bottom: 1px solid #f0f0f0;">
                                <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                                    <div style="display: flex; align-items: center;">
                                        <div style="width: 40px; height: 40px; border-radius: 8px; background-color: #f0e6ff; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                            <span style="font-size: 20px;">‚òÅÔ∏è</span>
                                        </div>
                                        <div>
                                            <div style="font-size: 16px; color: #333; margin-bottom: 4px;">APIÈÖçÁΩÆ</div>
                                            <div style="font-size: 12px; color: #999;">Êé•ÂÖ•Â§ñÈÉ®API</div>
                                        </div>
                                    </div>
                                    <div style="font-size: 16px; color: #999;">‚Ä∫</div>
                                </div>
                            </div>
                            
                            <div class="settings-item" onclick="showGeneralSettings()" style="padding: 20px; border-bottom: 1px solid #f0f0f0;">
                                <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                                    <div style="display: flex; align-items: center;">
                                        <div style="width: 40px; height: 40px; border-radius: 8px; background-color: #f5f5f5; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                            <span style="font-size: 20px;">‚öôÔ∏è</span>
                                        </div>
                                        <div>
                                            <div style="font-size: 16px; color: #333; margin-bottom: 4px;">ÈÄöÁî®ËÆæÁΩÆ</div>
                                            <div style="font-size: 12px; color: #999;">Á≥ªÁªü‰∏éË¥¶Êà∑Áõ∏ÂÖ≥ËÆæÁΩÆ</div>
                                        </div>
                                    </div>
                                    <div style="font-size: 16px; color: #999;">‚Ä∫</div>
                                </div>
                            </div>
                            
                            <button onclick="logout()" style="margin: 20px; padding: 16px; background-color: #ff3b30; border: none; border-radius: 8px; color: white; font-size: 16px; font-weight: 500; cursor: pointer; width: calc(100% - 40px);">ÈÄÄÂá∫ÁôªÂΩï</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Â∫ïÈÉ®ÂØºËà™Ê†è -->
            <div class="wechat-nav">
                <button class="nav-item active" onclick="switchWechatTab('chat')">
                    <div class="icon">üí¨</div>
                    <div class="text">ËÅäÂ§©</div>
                </button>
                <button class="nav-item" onclick="switchWechatTab('moments')">
                    <div class="icon">‚≠ï</div>
                    <div class="text">ÂØÜÂèãÂúà</div>
                </button>
                <button class="nav-item" onclick="switchWechatTab('profile')">
                    <div class="icon">üë§</div>
                    <div class="text">ÊàëÁöÑ</div>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Ê∑ªÂä†ËßíËâ≤ÂºπÁ™ó -->
    <div class="add-role-modal" id="addRoleModal">
        <div class="add-role-content">
            <div class="add-role-header">
                <div class="title">Ê∑ªÂä†ËßíËâ≤</div>
                <button class="btn" onclick="hideAddRoleModal()">ÂèñÊ∂à</button>
                <button class="btn" onclick="addRole()">ÂÆåÊàê</button>
            </div>
            <div class="avatar-selection">
                <div class="avatar-placeholder" onclick="selectAvatar()">
                    <div class="icon">üì∑</div>
                </div>
                <div>ÈÄâÊã©Â§¥ÂÉè</div>
            </div>
            <input type="text" class="nickname-input" id="roleNickname" placeholder="ËØ∑ËæìÂÖ•ËßíËâ≤ÊòµÁß∞">
            <div style="font-size: 12px; color: #999; text-align: center;">ÊúÄÂ§öÂèØÊ∑ªÂä†10‰∏™ËßíËâ≤</div>
        </div>
    </div>
    
    <!-- Á§ºÁâ©ÈÄâÊã©ÂºπÁ™ó -->
    <div class="gift-modal" id="giftModal">
        <div class="gift-content">
            <div class="gift-header">
                <div class="title">ÈÄâÊã©Á§ºÁâ©</div>
                <button class="btn" onclick="hideGiftModal()">ÂèñÊ∂à</button>
                <button class="btn" onclick="sendGift()">ÂèëÈÄÅ</button>
            </div>
            <div class="gift-grid">
                <div class="gift-item" data-gift="custom">
                    <div class="icon">üé®</div>
                    <div class="text">Ëá™ÂÆö‰πâ</div>
                </div>
                <div class="gift-item" data-gift="giftbox">
                    <div class="icon">üéÅ</div>
                    <div class="text">Á§ºÁâ©Áõí</div>
                </div>
                <div class="gift-item" data-gift="rose">
                    <div class="icon">üåπ</div>
                    <div class="text">Áé´Áë∞Ëä±</div>
                </div>
                <div class="gift-item" data-gift="diamond">
                    <div class="icon">üíé</div>
                    <div class="text">ÈíªÁü≥</div>
                </div>
                <div class="gift-item" data-gift="cake">
                    <div class="icon">üéÇ</div>
                    <div class="text">ÁîüÊó•ËõãÁ≥ï</div>
                </div>
                <div class="gift-item" data-gift="balloon">
                    <div class="icon">üéà</div>
                    <div class="text">Ê∞îÁêÉ</div>
                </div>
                <div class="gift-item" data-gift="teddy">
                    <div class="icon">üß∏</div>
                    <div class="text">Ê≥∞Ëø™ÁÜä</div>
                </div>
                <div class="gift-item" data-gift="flowers">
                    <div class="icon"> </div>
                    <div class="text">Ëä±Êùü</div>
                </div>
                <div class="gift-item" data-gift="chocolate">
                    <div class="icon">üç´</div>
                    <div class="text">Â∑ßÂÖãÂäõ</div>
                </div>
                <div class="gift-item" data-gift="star">
                    <div class="icon">‚≠ê</div>
                    <div class="text">ÊòüÊòü</div>
                </div>
                <div class="gift-item" data-gift="heart">
                    <div class="icon">üíù</div>
                    <div class="text">Áà±ÂøÉÁ§ºÁõí</div>
                </div>
                <div class="gift-item" data-gift="bow">
                    <div class="icon">üéÄ</div>
                    <div class="text">Ëù¥Ëù∂Áªì</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ‰∫íÂä®Ê®°ÂºèÈÄâÊã©ÂºπÁ™ó -->
    <div class="mode-modal" id="modeModal">
        <div class="mode-content">
            <div class="mode-header">
                <div class="title">ÈÄâÊã©‰∫íÂä®Ê®°Âºè</div>
            </div>
            <div class="mode-options">
                <div class="mode-option active" data-mode="chat">
                    <div class="radio"></div>
                    <div class="content">
                        <div class="title">Á∫ØËÅäÊ®°Âºè</div>
                        <div class="desc">Âè™ËøõË°åÂØπËØùÔºå‰ΩìÈ™åÊµÅÁïÖËá™ÁÑ∂ÁöÑÊ≤üÈÄö„ÄÇ</div>
                    </div>
                </div>
                <div class="mode-option" data-mode="scene">
                    <div class="radio"></div>
                    <div class="content">
                        <div class="title">ÊÉÖÊôØÊ®°Âºè</div>
                        <div class="desc">Â¢ûÂä†Âä®‰Ωú„ÄÅÁéØÂ¢ÉÁ≠âÊèèÂÜôÔºåÂÖ±ÂêåÂàõ‰ΩúÊïÖ‰∫ã„ÄÇ</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== 5. Â£ÅÁ∫∏ËÆæÁΩÆÈ°µÈù¢Ôºà‰øÆÂ§çÁâàÔºâ ==================== -->
    <div class="page" id="wallpaperPage">
        <div class="page-content">
            <div class="wallpaper-header">
                <button class="wallpaper-back" onclick="goPage('homePage')">‚Üê ËøîÂõû</button>
                <div class="wallpaper-title">Â£ÅÁ∫∏ËÆæÁΩÆ</div>
            </div>

            <div class="target-page">
                <span>Â∫îÁî®Âà∞Ôºö</span>
                <button data-page="lockScreen" class="active">ÈîÅÂ±è</button>
                <button data-page="homePage">‰∏ªÈ°µ</button>
                <button data-page="tavernPage">ÈÖíÈ¶Ü</button>
                <button data-page="wechatPage">ÂæÆ‰ø°</button>
            </div>

            <div class="wallpaper-upload">
                <input type="file" id="wallFile" accept="image/*,video/mp4,video/webm">
                <button onclick="uploadWallpaper()">Êú¨Âú∞‰∏ä‰º†</button>
            </div>
            <div class="wallpaper-tips">ÊîØÊåÅÊ†ºÂºèÔºöjpg/png/gifÔºàÂõæÁâáÔºâ„ÄÅmp4/webmÔºàËßÜÈ¢ëÔºâ</div>
            
            <div class="wallpaper-upload">
                <input type="text" id="wallUrl" placeholder="ËæìÂÖ•ÂõæÁâá/ËßÜÈ¢ëURLÔºàÊîØÊåÅhttp/httpsÔºâ">
                <button onclick="importWallpaper()">URLÂØºÂÖ•</button>
            </div>
            <div class="wallpaper-tips">Á§∫‰æãÔºöhttps://picsum.photos/400/800 Êàñ ËßÜÈ¢ëMP4ÈìæÊé•</div>

            <div class="wallpaper-list" id="wallList"></div>
        </div>
    </div>

    <script>
        // ==================== ÂÖ®Â±ÄÂ∏∏Èáè/ÂèòÈáè ====================
        const ALL_PAGES = ["lockScreen","homePage","tavernPage","wechatPage","wallpaperPage"];
        const BACKEND_URL = "https://ai-phone-six.vercel.app/api/chat";
        let currentSetPage = "lockScreen";
        let wallpaperConfig = {};
        
        // Âπ≥Âè∞‰∏éÊ®°ÂûãÁöÑÊò†Â∞ÑÂÖ≥Á≥ªÔºàÊÅ¢Â§çÂéüÈÄªËæëÔºâ
        const platformModels = {
            'openai': ['gpt-3.5-turbo', 'gpt-4', 'gpt-4-turbo'],
            'doubao': ['doubao-pro', 'doubao-4k', 'doubao-32k'],
            'deepseek': ['deepseek-chat', 'deepseek-coder'],
            'openrouter': ['openrouter/auto', 'anthropic/claude-3-sonnet'],
            'custom-openai': []
        };
        // AIÈÖçÁΩÆÂØπË±°ÔºàÊÅ¢Â§çÂéüÈÄªËæëÔºâ
        let currentConfig = {
            name: 'APIËøûÊé• 18',
            platform: 'openai',
            apiUrl: '',
            apiKey: '',
            model: 'gpt-3.5-turbo'
        };

        // ==================== È°µÈù¢ÂàáÊç¢Ê†∏ÂøÉÈÄªËæë ====================
        function goPage(pageId) {
            try {
                // ÈöêËóèÊâÄÊúâÈ°µÈù¢
                ALL_PAGES.forEach(p => {
                    document.getElementById(p).classList.remove("active");
                });
                // ÊòæÁ§∫ÁõÆÊ†áÈ°µÈù¢
                const targetPage = document.getElementById(pageId);
                targetPage.classList.add("active");
                // Ê∏≤ÊüìÁõÆÊ†áÈ°µÈù¢ÁöÑÂ£ÅÁ∫∏
                renderPageWallpaper(pageId);
            } catch (error) {
                console.error("È°µÈù¢ÂàáÊç¢Â§±Ë¥•Ôºö", error);
                alert(`ÂàáÊç¢È°µÈù¢Âá∫ÈîôÔºö${error.message}`);
            }
        }

        // ==================== ÈîÅÂ±èÊó∂Èó¥Êõ¥Êñ∞ ====================
        function updateLockTime() {
            try {
                const now = new Date();
                document.getElementById('lockTime').innerText = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                document.getElementById('lockDate').innerText = now.toLocaleDateString();
            } catch (error) {
                console.error("Êõ¥Êñ∞ÈîÅÂ±èÊó∂Èó¥Â§±Ë¥•Ôºö", error);
            }
        }

        // ==================== Â£ÅÁ∫∏Ê†∏ÂøÉÂäüËÉΩÔºàÂÆåÊï¥‰øÆÂ§çÔºâ ====================
        // ÂàùÂßãÂåñÂ£ÅÁ∫∏ÈÖçÁΩÆ
        function initWallpaperConfig() {
            try {
                const savedConfig = localStorage.getItem("wallpaperConfig");
                if (savedConfig) {
                    wallpaperConfig = JSON.parse(savedConfig);
                } else {
                    // ÈªòËÆ§Â£ÅÁ∫∏ÈÖçÁΩÆ
                    wallpaperConfig = {
                        lockScreen: {type:"static", url:"https://picsum.photos/seed/pink1/400/800.jpg"},
                        homePage: {type:"static", url:"https://picsum.photos/seed/pink2/400/800.jpg"},
                        tavernPage: {type:"static", url:"https://picsum.photos/seed/tavern/400/800.jpg"},
                        wechatPage: {type:"static", url:"https://picsum.photos/seed/wechat/400/800.jpg"}
                    };
                    localStorage.setItem("wallpaperConfig", JSON.stringify(wallpaperConfig));
                }
            } catch (error) {
                console.error("ÂàùÂßãÂåñÂ£ÅÁ∫∏ÈÖçÁΩÆÂ§±Ë¥•Ôºö", error);
                alert(`Â£ÅÁ∫∏ÈÖçÁΩÆÂàùÂßãÂåñÂá∫ÈîôÔºö${error.message}`);
            }
        }

        // ÈÄâÊã©Ë¶ÅËÆæÁΩÆÁöÑÈ°µÈù¢Ôºà‰øÆÂ§çÈÄâ‰∏≠ÈÄªËæëÔºâ
        function initTargetPageButtons() {
            try {
                const buttons = document.querySelectorAll(".target-page button");
                buttons.forEach(btn => {
                    btn.addEventListener('click', function() {
                        buttons.forEach(b => b.classList.remove("active"));
                        this.classList.add("active");
                        currentSetPage = this.dataset.page;
                        // È´ò‰∫ÆÂΩìÂâçÈ°µÈù¢ÁöÑÂ£ÅÁ∫∏
                        highlightCurrentWallpaper();
                    });
                });
            } catch (error) {
                console.error("ÂàùÂßãÂåñÁõÆÊ†áÈ°µÈù¢ÊåâÈíÆÂ§±Ë¥•Ôºö", error);
            }
        }

        // Ê∏≤ÊüìÈ°µÈù¢Â£ÅÁ∫∏Ôºà‰øÆÂ§çËßÜÈ¢ëÊ∏≤Êüì„ÄÅÂ±ÇÁ∫ß„ÄÅÈáçÂ§çÂàõÂª∫ÈóÆÈ¢òÔºâ
        function renderPageWallpaper(pageId) {
            try {
                const page = document.getElementById(pageId);
                const wall = wallpaperConfig[pageId] || wallpaperConfig.lockScreen;
                
                // Ê∏ÖÈô§ÊóßÂ£ÅÁ∫∏Â±Ç
                const oldBgElements = page.querySelectorAll(".page-bg");
                oldBgElements.forEach(el => el.remove());

                // ÂàõÂª∫Êñ∞Â£ÅÁ∫∏Â±Ç
                if (wall.type === "static" || wall.type === "dynamic") {
                    // ÈùôÊÄÅ/GIFÂ£ÅÁ∫∏
                    const bgDiv = document.createElement("div");
                    bgDiv.className = "page-bg";
                    bgDiv.style.backgroundImage = `url(${wall.url})`;
                    bgDiv.style.backgroundSize = "cover";
                    bgDiv.style.backgroundPosition = "center";
                    bgDiv.style.backgroundRepeat = "no-repeat";
                    page.insertBefore(bgDiv, page.firstChild);
                } else if (wall.type === "video") {
                    // ËßÜÈ¢ëÂ£ÅÁ∫∏Ôºà‰øÆÂ§çËá™Âä®Êí≠Êîæ„ÄÅÈáçÂ§çÂàõÂª∫Ôºâ
                    const video = document.createElement("video");
                    video.className = "page-bg";
                    video.src = wall.url;
                    video.autoplay = true;
                    video.loop = true;
                    video.muted = true;
                    video.playsInline = true;
                    video.style.objectFit = "cover";
                    // ÂÖºÂÆπÁî®Êà∑‰∫§‰∫íÂêéÊí≠Êîæ
                    video.addEventListener('loadeddata', () => {
                        if (video.paused) {
                            video.play().catch(err => {
                                console.warn("ËßÜÈ¢ëËá™Âä®Êí≠ÊîæÂ§±Ë¥•ÔºåÈúÄÁî®Êà∑‰∫§‰∫íÔºö", err);
                                alert("ËßÜÈ¢ëÂ£ÅÁ∫∏ÈúÄÁÇπÂáªÂêéÊí≠ÊîæÔºåËØ∑ÁÇπÂáªÂ£ÅÁ∫∏Âå∫Âüü");
                                video.addEventListener('click', () => video.play(), { once: true });
                            });
                        }
                    });
                    page.insertBefore(video, page.firstChild);
                }
            } catch (error) {
                console.error(`Ê∏≤Êüì${pageId}Â£ÅÁ∫∏Â§±Ë¥•Ôºö`, error);
            }
        }

        // Â∫îÁî®Â£ÅÁ∫∏Ôºà‰øÆÂ§çÂ≠òÂÇ®„ÄÅÂèçÈ¶àÔºâ
        function applyWallpaper(type, url) {
            try {
                wallpaperConfig[currentSetPage] = {type, url};
                localStorage.setItem("wallpaperConfig", JSON.stringify(wallpaperConfig));
                // ÈáçÊñ∞Ê∏≤ÊüìÂΩìÂâçÈ°µÈù¢Â£ÅÁ∫∏
                renderPageWallpaper(currentSetPage);
                // Êõ¥Êñ∞Â£ÅÁ∫∏ÂàóË°®È´ò‰∫Æ
                highlightCurrentWallpaper();
                alert(`‚úÖ Â£ÅÁ∫∏Â∑≤Â∫îÁî®Âà∞„Äê${getPageName(currentSetPage)}„Äë`);
            } catch (error) {
                console.error("Â∫îÁî®Â£ÅÁ∫∏Â§±Ë¥•Ôºö", error);
                alert(`‚ùå Â∫îÁî®Â£ÅÁ∫∏Âá∫ÈîôÔºö${error.message}`);
            }
        }

        // Êú¨Âú∞‰∏ä‰º†Â£ÅÁ∫∏Ôºà‰øÆÂ§çÁ±ªÂûãÂà§Êñ≠„ÄÅÂºÇÂ∏∏ÊçïËé∑Ôºâ
        function uploadWallpaper() {
            try {
                const fileInput = document.getElementById("wallFile");
                const file = fileInput.files[0];
                
                if (!file) {
                    alert("ËØ∑ÂÖàÈÄâÊã©Ë¶Å‰∏ä‰º†ÁöÑÂõæÁâá/ËßÜÈ¢ëÊñá‰ª∂");
                    return;
                }

                // Ê†°È™åÊñá‰ª∂Á±ªÂûã
                const fileType = file.type;
                let wallType = "";
                if (fileType.startsWith("image/")) {
                    wallType = fileType.includes("gif") ? "dynamic" : "static";
                } else if (fileType.startsWith("video/")) {
                    if (!["video/mp4", "video/webm"].includes(fileType)) {
                        alert("‰ªÖÊîØÊåÅmp4/webmÊ†ºÂºèÁöÑËßÜÈ¢ë");
                        return;
                    }
                    wallType = "video";
                } else {
                    alert("‰∏çÊîØÊåÅÁöÑÊñá‰ª∂Á±ªÂûãÔºå‰ªÖÊîØÊåÅÂõæÁâá(jpg/png/gif)ÂíåËßÜÈ¢ë(mp4/webm)");
                    return;
                }

                // ËØªÂèñÊñá‰ª∂
                const reader = new FileReader();
                reader.onload = function(e) {
                    applyWallpaper(wallType, e.target.result);
                    // Ê∏ÖÁ©∫Êñá‰ª∂ÈÄâÊã©
                    fileInput.value = "";
                    // Ê∑ªÂä†Âà∞Â£ÅÁ∫∏ÂàóË°®
                    addWallpaperToGallery(e.target.result, wallType);
                };
                reader.onerror = function() {
                    alert("‚ùå Êñá‰ª∂ËØªÂèñÂ§±Ë¥•ÔºåËØ∑ÈáçËØï");
                    console.error("Êñá‰ª∂ËØªÂèñÈîôËØØÔºö", reader.error);
                };

                // Ê†πÊçÆÊñá‰ª∂Á±ªÂûãÈÄâÊã©ËØªÂèñÊñπÂºè
                if (wallType === "video") {
                    reader.readAsDataURL(file);
                } else {
                    reader.readAsDataURL(file);
                }
            } catch (error) {
                console.error("‰∏ä‰º†Â£ÅÁ∫∏Â§±Ë¥•Ôºö", error);
                alert(`‚ùå ‰∏ä‰º†Â£ÅÁ∫∏Âá∫ÈîôÔºö${error.message}`);
            }
        }

        // URLÂØºÂÖ•Â£ÅÁ∫∏Ôºà‰øÆÂ§çÊ†°È™å„ÄÅÁ±ªÂûãÂà§Êñ≠Ôºâ
        function importWallpaper() {
            try {
                const urlInput = document.getElementById("wallUrl");
                let url = urlInput.value.trim();
                
                if (!url) {
                    alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÂõæÁâá/ËßÜÈ¢ëURL");
                    return;
                }

                // Âü∫Á°ÄURLÊ†°È™å
                if (!url.startsWith("http://") && !url.startsWith("https://")) {
                    alert("URLÂøÖÈ°ª‰ª•http://Êàñhttps://ÂºÄÂ§¥");
                    return;
                }

                // Âà§Êñ≠Á±ªÂûã
                let wallType = "static";
                if (url.match(/\.(mp4|webm)(\?.*)?$/i)) {
                    wallType = "video";
                } else if (url.match(/\.(gif)(\?.*)?$/i)) {
                    wallType = "dynamic";
                }

                // È™åËØÅURLÂèØËÆøÈóÆÊÄßÔºàÁÆÄÂçïÊ£ÄÊü•Ôºâ
                applyWallpaper(wallType, url);
                // Ê∏ÖÁ©∫ËæìÂÖ•
                urlInput.value = "";
                // Ê∑ªÂä†Âà∞Â£ÅÁ∫∏ÂàóË°®
                addWallpaperToGallery(url, wallType);
            } catch (error) {
                console.error("ÂØºÂÖ•Â£ÅÁ∫∏Â§±Ë¥•Ôºö", error);
                alert(`‚ùå ÂØºÂÖ•Â£ÅÁ∫∏Âá∫ÈîôÔºö${error.message}`);
            }
        }

        // Âä†ËΩΩÁ§∫‰æãÂ£ÅÁ∫∏ÂàóË°®Ôºà‰øÆÂ§çÁÇπÂáª‰∫ã‰ª∂Ôºâ
        function loadWallpaperGallery() {
            try {
                const gallery = [
                    {url: "https://picsum.photos/seed/wall1/400/800.jpg", type: "static"},
                    {url: "https://picsum.photos/seed/wall2/400/800.jpg", type: "static"},
                    {url: "https://picsum.photos/seed/wall3/400/800.jpg", type: "static"},
                    {url: "https://gif.52112.com/2022/08/10/202208101527078402.gif", type: "dynamic"},
                    {url: "https://test-videos.co.uk/vids/bigbuckbunny/mp4/h264/720/Big_Buck_Bunny_720_10s_1MB.mp4", type: "video"}
                ];

                const listContainer = document.getElementById("wallList");
                listContainer.innerHTML = "";

                // Ê∑ªÂä†Áî®Êà∑Â∑≤‰øùÂ≠òÁöÑÂ£ÅÁ∫∏
                Object.values(wallpaperConfig).forEach(wall => {
                    if (!gallery.some(g => g.url === wall.url)) {
                        gallery.push(wall);
                    }
                });

                // Ê∏≤ÊüìÂàóË°®
                gallery.forEach(item => {
                    const itemDiv = document.createElement("div");
                    itemDiv.className = "wallpaper-item";
                    itemDiv.dataset.url = item.url;
                    itemDiv.dataset.type = item.type;
                    
                    // ËÆæÁΩÆÈ¢ÑËßàÂõæ
                    if (item.type === "video") {
                        // ËßÜÈ¢ëÊòæÁ§∫Â∞ÅÈù¢
                        itemDiv.style.backgroundImage = "url(https://picsum.photos/seed/video/400/800.jpg)";
                        // Ê∑ªÂä†ËßÜÈ¢ëÊ†áËØÜ
                        const badge = document.createElement("div");
                        badge.style.position = "absolute";
                        badge.style.bottom = "5px";
                        badge.style.right = "5px";
                        badge.style.background = "rgba(0,0,0,0.7)";
                        badge.style.padding = "2px 5px";
                        badge.style.borderRadius = "5px";
                        badge.style.fontSize = "10px";
                        badge.innerText = "ËßÜÈ¢ë";
                        itemDiv.appendChild(badge);
                    } else {
                        itemDiv.style.backgroundImage = `url(${item.url})`;
                    }

                    // ÁÇπÂáªÂ∫îÁî®Â£ÅÁ∫∏
                    itemDiv.addEventListener('click', function() {
                        applyWallpaper(this.dataset.type, this.dataset.url);
                    });

                    listContainer.appendChild(itemDiv);
                });

                // È´ò‰∫ÆÂΩìÂâçÈ°µÈù¢ÁöÑÂ£ÅÁ∫∏
                highlightCurrentWallpaper();
            } catch (error) {
                console.error("Âä†ËΩΩÂ£ÅÁ∫∏ÂàóË°®Â§±Ë¥•Ôºö", error);
            }
        }

        // È´ò‰∫ÆÂΩìÂâçÈ°µÈù¢ÁöÑÂ£ÅÁ∫∏
        function highlightCurrentWallpaper() {
            try {
                const currentWallUrl = wallpaperConfig[currentSetPage]?.url;
                const allItems = document.querySelectorAll(".wallpaper-item");
                allItems.forEach(item => {
                    if (item.dataset.url === currentWallUrl) {
                        item.classList.add("selected");
                    } else {
                        item.classList.remove("selected");
                    }
                });
            } catch (error) {
                console.error("È´ò‰∫ÆÂ£ÅÁ∫∏Â§±Ë¥•Ôºö", error);
            }
        }

        // Ê∑ªÂä†Â£ÅÁ∫∏Âà∞ÁîªÂªä
        function addWallpaperToGallery(url, type) {
            try {
                const listContainer = document.getElementById("wallList");
                // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®
                const exists = Array.from(listContainer.querySelectorAll(".wallpaper-item"))
                    .some(item => item.dataset.url === url);
                
                if (!exists) {
                    const itemDiv = document.createElement("div");
                    itemDiv.className = "wallpaper-item";
                    itemDiv.dataset.url = url;
                    itemDiv.dataset.type = type;
                    
                    if (type === "video") {
                        itemDiv.style.backgroundImage = "url(https://picsum.photos/seed/video/400/800.jpg)";
                        const badge = document.createElement("div");
                        badge.style.position = "absolute";
                        badge.style.bottom = "5px";
                        badge.style.right = "5px";
                        badge.style.background = "rgba(0,0,0,0.7)";
                        badge.style.padding = "2px 5px";
                        badge.style.borderRadius = "5px";
                        badge.style.fontSize = "10px";
                        badge.innerText = "ËßÜÈ¢ë";
                        itemDiv.appendChild(badge);
                    } else {
                        itemDiv.style.backgroundImage = `url(${url})`;
                    }

                    itemDiv.addEventListener('click', function() {
                        applyWallpaper(this.dataset.type, this.dataset.url);
                    });

                    listContainer.insertBefore(itemDiv, listContainer.firstChild);
                }
            } catch (error) {
                console.error("Ê∑ªÂä†Â£ÅÁ∫∏Âà∞ÁîªÂªäÂ§±Ë¥•Ôºö", error);
            }
        }

        // Ëé∑ÂèñÈ°µÈù¢ÂêçÁß∞ÔºàÁî®‰∫éÊèêÁ§∫Ôºâ
        function getPageName(pageId) {
            const pageNames = {
                lockScreen: "ÈîÅÂ±è",
                homePage: "‰∏ªÈ°µ",
                tavernPage: "ÈÖíÈ¶Ü",
                wechatPage: "ÂæÆ‰ø°"
            };
            return pageNames[pageId] || pageId;
        }

        // ==================== AIÂäüËÉΩÂÆåÊï¥ÊÅ¢Â§çÔºàÈÖíÈ¶ÜÊ®°ÂùóÔºâ ====================
        // ÂàùÂßãÂåñAIÈÖçÁΩÆ
        function initAIConfig() {
            try {
                // Âä†ËΩΩ‰øùÂ≠òÁöÑÈÖçÁΩÆ
                if (localStorage.getItem('aiPhoneConfig')) {
                    currentConfig = JSON.parse(localStorage.getItem('aiPhoneConfig'));
                    document.getElementById('configName').value = currentConfig.name;
                    document.getElementById('platformSelect').value = currentConfig.platform;
                    document.getElementById('apiUrlInput').value = currentConfig.apiUrl;
                    document.getElementById('apiKeyInput').value = currentConfig.apiKey;
                }
                
                // Êõ¥Êñ∞Ê®°ÂûãÂàóË°®ÂíåAPIÂú∞ÂùÄÊòæÁ§∫
                updateModelList();
                toggleApiUrlVisibility();
                
                // ÁªëÂÆö‰∫ã‰ª∂
                document.getElementById('platformSelect').addEventListener('change', function() {
                    updateModelList();
                    toggleApiUrlVisibility();
                });
                document.getElementById('fetchModelsBtn').addEventListener('click', fetchModels);
                document.getElementById('testConnectionBtn').addEventListener('click', testConnection);
                document.getElementById('saveConfigBtn').addEventListener('click', saveAIConfig);
                document.getElementById('closeConfigBtn').addEventListener('click', toggleConfigPanel);
                document.getElementById('configToggle').addEventListener('click', toggleConfigPanel);
                document.getElementById('sendBtn').addEventListener('click', sendMessage);
                document.getElementById('userInput').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') sendMessage();
                });
            } catch (error) {
                console.error("ÂàùÂßãÂåñAIÈÖçÁΩÆÂ§±Ë¥•Ôºö", error);
                alert(`AIÂäüËÉΩÂàùÂßãÂåñÂá∫ÈîôÔºö${error.message}`);
            }
        }

        // ÂàáÊç¢ÈÖçÁΩÆÈù¢Êùø
        function toggleConfigPanel() {
            try {
                document.getElementById('configPanel').classList.toggle('active');
            } catch (error) {
                console.error("ÂàáÊç¢ÈÖçÁΩÆÈù¢ÊùøÂ§±Ë¥•Ôºö", error);
            }
        }

        // ÂàáÊç¢APIÂú∞ÂùÄËæìÂÖ•Ê°ÜÂèØËßÅÊÄß
        function toggleApiUrlVisibility() {
            try {
                const platform = document.getElementById('platformSelect').value;
                const apiUrlItem = document.getElementById('apiUrlItem');
                const fetchBtn = document.getElementById('fetchModelsBtn');
                const testBtn = document.getElementById('testConnectionBtn');
                
                if (platform === 'custom-openai') {
                    apiUrlItem.style.display = 'block';
                    fetchBtn.style.display = 'block';
                    testBtn.style.display = 'block';
                } else {
                    apiUrlItem.style.display = 'none';
                    fetchBtn.style.display = 'none';
                    testBtn.style.display = 'none';
                }
            } catch (error) {
                console.error("ÂàáÊç¢APIÂú∞ÂùÄÊòæÁ§∫Â§±Ë¥•Ôºö", error);
            }
        }

        // Êõ¥Êñ∞Ê®°ÂûãÂàóË°®
        function updateModelList() {
            try {
                const platform = document.getElementById('platformSelect').value;
                const models = platformModels[platform] || [];
                const modelSelect = document.getElementById('modelSelect');
                
                modelSelect.innerHTML = '';
                if (models.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'ËØ∑ÂÖàÊãâÂèñÊ®°Âûã';
                    modelSelect.appendChild(option);
                } else {
                    models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = model;
                        if (model === currentConfig.model) {
                            option.selected = true;
                        }
                        modelSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error("Êõ¥Êñ∞Ê®°ÂûãÂàóË°®Â§±Ë¥•Ôºö", error);
            }
        }

        // ‰øùÂ≠òAIÈÖçÁΩÆ
        function saveAIConfig() {
            try {
                currentConfig = {
                    name: document.getElementById('configName').value,
                    platform: document.getElementById('platformSelect').value,
                    apiUrl: document.getElementById('apiUrlInput').value,
                    apiKey: document.getElementById('apiKeyInput').value,
                    model: document.getElementById('modelSelect').value
                };
                localStorage.setItem('aiPhoneConfig', JSON.stringify(currentConfig));
                toggleConfigPanel();
                addAIMessage('‚úÖ ÈÖçÁΩÆÂ∑≤‰øùÂ≠ò', false);
            } catch (error) {
                console.error("‰øùÂ≠òAIÈÖçÁΩÆÂ§±Ë¥•Ôºö", error);
                addAIMessage(`‚ùå ‰øùÂ≠òÈÖçÁΩÆÂá∫ÈîôÔºö${error.message}`, false);
            }
        }

        // Ê∑ªÂä†AIÊ∂àÊÅØ
        function addAIMessage(text, isUser) {
            try {
                const screen = document.getElementById('screen');
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${isUser ? 'user-msg' : 'ai-msg'}`;
                messageDiv.textContent = text;
                screen.appendChild(messageDiv);
                screen.scrollTop = screen.scrollHeight;
            } catch (error) {
                console.error("Ê∑ªÂä†Ê∂àÊÅØÂ§±Ë¥•Ôºö", error);
            }
        }

        // ÊãâÂèñÊ®°ÂûãÔºàÊÅ¢Â§çÁõ¥Ëøû+ËΩ¨ÂèëÈÄªËæëÔºâ
        async function fetchModels() {
            try {
                const apiUrl = document.getElementById('apiUrlInput').value.trim();
                const apiKey = document.getElementById('apiKeyInput').value.trim();
                
                if (!apiUrl || !apiKey) {
                    addAIMessage('‚ùå ËØ∑ÂÖàÂ°´ÂÜôAPIÊé•Âè£Âú∞ÂùÄÂíåÂØÜÈí•', false);
                    return;
                }

                addAIMessage('üîÑ Ê≠£Âú®ÊãâÂèñÊ®°ÂûãÂàóË°®(Áõ¥Ëøû)...', false);
                
                // Á¨¨‰∏ÄÊ≠•ÔºöÂ∞ùËØïÁõ¥Ëøû
                try {
                    const response = await fetch(`${apiUrl}/models`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`Áõ¥ËøûÂ§±Ë¥•: HTTP ${response.status}`);
                    }

                    const data = await response.json();
                    const models = data.data || [];
                    
                    if (models.length === 0) {
                        addAIMessage('‚ùå Êú™Ëé∑ÂèñÂà∞‰ªª‰ΩïÊ®°Âûã', false);
                        return;
                    }

                    platformModels['custom-openai'] = models.map(m => m.id);
                    updateModelList();
                    document.getElementById('modelSelect').value = models[0].id;
                    addAIMessage(`‚úÖ Áõ¥ËøûÊàêÂäüÔºÅÊãâÂèñÂà∞ ${models.length} ‰∏™Ê®°Âûã`, false);
                } catch (directError) {
                    // Á¨¨‰∫åÊ≠•ÔºöÁõ¥ËøûÂ§±Ë¥•ÔºåËµ∞ÂêéÁ´ØËΩ¨Âèë
                    addAIMessage(`‚ö†Ô∏è Áõ¥ËøûÂ§±Ë¥•(${directError.message})ÔºåÂ∞ùËØïÂêéÁ´ØËΩ¨Âèë...`, false);
                    
                    const forwardResponse = await fetch(BACKEND_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            platform: 'custom-openai',
                            apiUrl: apiUrl,
                            action: 'fetchModels'
                        })
                    });

                    if (!forwardResponse.ok) {
                        throw new Error(`ËΩ¨ÂèëÂ§±Ë¥•: HTTP ${forwardResponse.status}`);
                    }

                    const data = await forwardResponse.json();
                    const models = data.data || [];
                    
                    if (models.length === 0) {
                        addAIMessage('‚ùå ËΩ¨ÂèëÊãâÂèñÔºöÊú™Ëé∑ÂèñÂà∞‰ªª‰ΩïÊ®°Âûã', false);
                        return;
                    }

                    platformModels['custom-openai'] = models.map(m => m.id);
                    updateModelList();
                    document.getElementById('modelSelect').value = models[0].id;
                    addAIMessage(`‚úÖ ËΩ¨ÂèëÊàêÂäüÔºÅÊãâÂèñÂà∞ ${models.length} ‰∏™Ê®°Âûã`, false);
                }
            } catch (error) {
                console.error("ÊãâÂèñÊ®°ÂûãÂ§±Ë¥•Ôºö", error);
                addAIMessage(`‚ùå ÊãâÂèñÊ®°ÂûãÂ§±Ë¥•Ôºö${error.message}`, false);
            }
        }

        // ÊµãËØïÈìæÊé•ÔºàÊÅ¢Â§çÁõ¥Ëøû+ËΩ¨ÂèëÈÄªËæëÔºâ
        async function testConnection() {
            try {
                const apiUrl = document.getElementById('apiUrlInput').value.trim();
                const apiKey = document.getElementById('apiKeyInput').value.trim();
                
                if (!apiUrl || !apiKey) {
                    addAIMessage('‚ùå ËØ∑ÂÖàÂ°´ÂÜôAPIÊé•Âè£Âú∞ÂùÄÂíåÂØÜÈí•', false);
                    return;
                }

                addAIMessage('üîÑ Ê≠£Âú®ÊµãËØïÈìæÊé•(Áõ¥Ëøû)...', false);
                
                // Á¨¨‰∏ÄÊ≠•ÔºöÂ∞ùËØïÁõ¥Ëøû
                try {
                    const response = await fetch(`${apiUrl}/models`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        addAIMessage('‚úÖ Áõ¥ËøûÊàêÂäüÔºÅÈìæÊé•ÊúâÊïà', false);
                    } else {
                        throw new Error(`Áõ¥ËøûÂ§±Ë¥•: HTTP ${response.status}`);
                    }
                } catch (directError) {
                    // Á¨¨‰∫åÊ≠•ÔºöÁõ¥ËøûÂ§±Ë¥•ÔºåËµ∞ÂêéÁ´ØËΩ¨Âèë
                    addAIMessage(`‚ö†Ô∏è Áõ¥ËøûÂ§±Ë¥•(${directError.message})ÔºåÂ∞ùËØïÂêéÁ´ØËΩ¨Âèë...`, false);
                    
                    const forwardResponse = await fetch(BACKEND_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            platform: 'custom-openai',
                            apiUrl: apiUrl,
                            action: 'testConnection'
                        })
                    });

                    if (forwardResponse.ok) {
                        addAIMessage('‚úÖ ËΩ¨ÂèëÊàêÂäüÔºÅÈìæÊé•ÊúâÊïà', false);
                    } else {
                        throw new Error(`ËΩ¨ÂèëÂ§±Ë¥•: HTTP ${forwardResponse.status}`);
                    }
                }
            } catch (error) {
                console.error("ÊµãËØïÈìæÊé•Â§±Ë¥•Ôºö", error);
                addAIMessage(`‚ùå ËøûÊé•Â§±Ë¥•Ôºö${error.message}`, false);
            }
        }

        // ÂèëÈÄÅÊ∂àÊÅØÔºàÊÅ¢Â§çÁõ¥Ëøû+ËΩ¨ÂèëÈÄªËæëÔºâ
        async function sendMessage() {
            try {
                const text = document.getElementById('userInput').value.trim();
                if (!text) return;
                
                // Ê∑ªÂä†Áî®Êà∑Ê∂àÊÅØ
                addAIMessage(text, true);
                document.getElementById('userInput').value = '';

                const platform = currentConfig.platform;
                const apiKey = currentConfig.apiKey;
                const model = currentConfig.model;
                
                if (!apiKey || !model) {
                    addAIMessage('‚ùå ËØ∑ÂÖàÈÖçÁΩÆAPIÂØÜÈí•ÂíåÊ®°Âûã', false);
                    return;
                }

                // Ëá™ÂÆö‰πâOpenAIÂπ≥Âè∞ÔºöÁõ¥Ëøû‰ºòÂÖà
                if (platform === 'custom-openai') {
                    const apiUrl = currentConfig.apiUrl;
                    if (!apiUrl) {
                        addAIMessage('‚ùå ËØ∑ÂÖàÂ°´ÂÜôËá™ÂÆö‰πâAPIÊé•Âè£Âú∞ÂùÄ', false);
                        return;
                    }

                    try {
                        // Áõ¥ËøûËØ∑Ê±Ç
                        const response = await fetch(`${apiUrl}/chat/completions`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${apiKey}`
                            },
                            body: JSON.stringify({
                                model: model,
                                messages: [{ role: 'user', content: text }]
                            })
                        });

                        if (!response.ok) {
                            throw new Error(`Áõ¥ËøûÂ§±Ë¥•: HTTP ${response.status}`);
                        }

                        const data = await response.json();
                        const reply = data.choices?.[0]?.message?.content || 'ÂõûÂ§çÂ§±Ë¥•';
                        addAIMessage(reply, false);
                    } catch (directError) {
                        // Áõ¥ËøûÂ§±Ë¥•ÔºåËµ∞ÂêéÁ´ØËΩ¨Âèë
                        addAIMessage(`‚ö†Ô∏è Áõ¥ËøûÂèëÈÄÅÂ§±Ë¥•(${directError.message})ÔºåÂ∞ùËØïÂêéÁ´ØËΩ¨Âèë...`, false);
                        
                        const forwardResponse = await fetch(BACKEND_URL, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${apiKey}`
                            },
                            body: JSON.stringify({
                                platform: 'custom-openai',
                                apiUrl: apiUrl,
                                apiKey: apiKey,
                                model: model,
                                messages: [{ role: 'user', content: text }]
                            })
                        });

                        if (!forwardResponse.ok) {
                            throw new Error(`ËΩ¨ÂèëÂ§±Ë¥•: HTTP ${forwardResponse.status}`);
                        }

                        const data = await forwardResponse.json();
                        const reply = data.choices?.[0]?.message?.content || 'ÂõûÂ§çÂ§±Ë¥•';
                        addAIMessage(reply, false);
                    }
                } else {
                    // ÂÖ∂‰ªñÂπ≥Âè∞ÔºöËµ∞ÂêéÁ´ØËΩ¨Âèë
                    const response = await fetch(BACKEND_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            platform: platform,
                            apiKey: apiKey,
                            model: model,
                            messages: [{ role: 'user', content: text }]
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    const reply = data.choices?.[0]?.message?.content || 'ÂõûÂ§çÂ§±Ë¥•';
                    addAIMessage(reply, false);
                }
            } catch (error) {
                console.error("ÂèëÈÄÅÊ∂àÊÅØÂ§±Ë¥•Ôºö", error);
                addAIMessage(`‚ùå ÂèëÈÄÅÂ§±Ë¥•: ${error.message}`, false);
            }
        }

        // ==================== ÂæÆ‰ø°Ê®°ÂùóÂäüËÉΩ ====================
        // ÂÖ®Â±ÄÂèòÈáè
        let wechatRoles = [];
        let currentChatRole = null;
        let moments = [];
        let wechatSettings = {};
        const API_BASE_URL = 'https://ai-phone-six.vercel.app/api/chat'; // ÂêéÁ´ØÈÉ®ÁΩ≤Âú∞ÂùÄÔºå‰∏éÂâçÁ´ØÈÖçÁΩÆÁöÑVercelÊé•Âè£Âú∞ÂùÄÂÆåÂÖ®ÂåπÈÖç
        
        // ÂàùÂßãÂåñÂæÆ‰ø°Ê®°Âùó
        async function initWechat() {
            try {
                // Âä†ËΩΩËßíËâ≤Êï∞ÊçÆ
                loadWechatRoles();
                // Âä†ËΩΩËÆæÁΩÆÊï∞ÊçÆ
                loadWechatSettings();
                // Ê∏≤ÊüìÊ∂àÊÅØÂàóË°®
                renderMessageList();
                // ÂàùÂßãÂåñËÅäÂ§©Ê∂àÊÅØ
                initChatMessages();
                
                // Ë∞ÉÁî®APIËé∑ÂèñÊúãÂèãÂúàÂàóË°®
                try {
                    await fetchMomentsFromAPI();
                } catch (error) {
                    console.error("Ëé∑ÂèñÊúãÂèãÂúàÊï∞ÊçÆÂ§±Ë¥•Ôºö", error);
                    // Â§±Ë¥•Êó∂‰ΩøÁî®Êú¨Âú∞Â≠òÂÇ®‰Ωú‰∏∫ÂêéÂ§á
                    loadMoments();
                }
                // Ê∏≤ÊüìÊúãÂèãÂúàÂàóË°®
                renderMomentsList();
            } catch (error) {
                console.error("ÂàùÂßãÂåñÂæÆ‰ø°Ê®°ÂùóÂ§±Ë¥•Ôºö", error);
            }
        }
        
        // Âä†ËΩΩÂæÆ‰ø°ËßíËâ≤Êï∞ÊçÆ
        function loadWechatRoles() {
            try {
                // Ëé∑ÂèñË¥¶Âè∑ÈÖçÁΩÆ
                const accountConfig = JSON.parse(localStorage.getItem('accountConfig') || '{}');
                const storageKey = accountConfig.loggedIn ? `wechatRoles_${accountConfig.username}` : 'wechatRoles';
                
                const savedRoles = localStorage.getItem(storageKey);
                if (savedRoles) {
                    wechatRoles = JSON.parse(savedRoles);
                } else {
                    // ÈªòËÆ§ËßíËâ≤Êï∞ÊçÆ
                    wechatRoles = [];
                    localStorage.setItem(storageKey, JSON.stringify(wechatRoles));
                }
                // Ê£ÄÊü•ËßíËâ≤Êï∞ÈáèÔºåÊòæÁ§∫ÂØπÂ∫îËßÜÂõæ
                checkRolesCount();
            } catch (error) {
                console.error("Âä†ËΩΩÂæÆ‰ø°ËßíËâ≤Â§±Ë¥•Ôºö", error);
            }
        }
        
        // Ê£ÄÊü•ËßíËâ≤Êï∞ÈáèÔºåÊòæÁ§∫ÂØπÂ∫îËßÜÂõæ
        function checkRolesCount() {
            try {
                const messageListView = document.getElementById('messageListView');
                const noRolesView = document.getElementById('noRolesView');
                
                if (wechatRoles.length === 0) {
                    messageListView.classList.remove('active');
                    noRolesView.classList.add('active');
                } else {
                    messageListView.classList.add('active');
                    noRolesView.classList.remove('active');
                }
            } catch (error) {
                console.error("Ê£ÄÊü•ËßíËâ≤Êï∞ÈáèÂ§±Ë¥•Ôºö", error);
            }
        }
        
        // ÂàáÊç¢ÂæÆ‰ø°Ê†áÁ≠æ
        function switchWechatTab(tab) {
            try {
                // ÈöêËóèÊâÄÊúâÊ†áÁ≠æËßÜÂõæ
                const tabViews = document.querySelectorAll('.wechat-tab-view');
                tabViews.forEach(view => view.classList.remove('active'));
                
                // ÈöêËóèÊâÄÊúâÂØºËà™È°πÁöÑÊøÄÊ¥ªÁä∂ÊÄÅ
                const navItems = document.querySelectorAll('.nav-item');
                navItems.forEach(item => item.classList.remove('active'));
                
                // ÊòæÁ§∫ÈÄâ‰∏≠ÁöÑÊ†áÁ≠æËßÜÂõæ
                if (tab === 'chat') {
                    document.getElementById('chatTabView').classList.add('active');
                    navItems[0].classList.add('active');
                    checkRolesCount();
                } else if (tab === 'moments') {
                    document.getElementById('momentsTabView').classList.add('active');
                    navItems[1].classList.add('active');
                    // Á°Æ‰øùÊ†áÁ≠æËßÜÂõæÂ∑≤ÁªèÊòæÁ§∫ÔºåÁÑ∂ÂêéÈáçÊñ∞Ê∏≤ÊüìÊúãÂèãÂúàÂàóË°®
                    setTimeout(() => {
                        renderMomentsList();
                    }, 0);
                } else if (tab === 'profile') {
                    document.getElementById('profileTabView').classList.add('active');
                    navItems[2].classList.add('active');
                    // Á°Æ‰øùÊ†áÁ≠æËßÜÂõæÂ∑≤ÁªèÊòæÁ§∫ÔºåÁÑ∂ÂêéÈáçÊñ∞Ê∏≤Êüì‰∏™‰∫∫È°µÈù¢
                    setTimeout(() => {
                        renderProfilePage();
                    }, 0);
                }
            } catch (error) {
                console.error("ÂàáÊç¢Ê†áÁ≠æÂ§±Ë¥•Ôºö", error);
            }
        }
        
        // Ê∏≤Êüì‰∏™‰∫∫È°µÈù¢
        function renderProfilePage() {
            try {
                // Êü•ÊâæÊ≠£Á°ÆÁöÑÂÆπÂô®ÂÖÉÁ¥†
                const profileContent = document.querySelector('#profileTabView .settings-view');
                if (profileContent) {
                    // Ëé∑ÂèñË¥¶Âè∑ÈÖçÁΩÆ
                    const accountConfig = JSON.parse(localStorage.getItem('accountConfig') || '{}');
                    
                    // Êü•ÊâæÁé∞ÊúâÁöÑÈÄÄÂá∫ÁôªÂΩïÊåâÈíÆ
                    const existingLogoutBtn = profileContent.querySelector('button[onclick="logout()"]');
                    if (existingLogoutBtn) {
                        // Ê†πÊçÆÁôªÂΩïÁä∂ÊÄÅÊòæÁ§∫ÊàñÈöêËóèÈÄÄÂá∫ÁôªÂΩïÊåâÈíÆ
                        existingLogoutBtn.style.display = accountConfig.loggedIn ? 'block' : 'none';
                    }
                }
            } catch (error) {
                console.error("Ê∏≤Êüì‰∏™‰∫∫È°µÈù¢Â§±Ë¥•Ôºö", error);
            }
        }
        
        // Âä†ËΩΩÊúãÂèãÂúàÊï∞ÊçÆ
        function loadMoments() {
            try {
                // Ëé∑ÂèñË¥¶Âè∑ÈÖçÁΩÆ
                const accountConfig = JSON.parse(localStorage.getItem('accountConfig') || '{}');
                const storageKey = accountConfig.loggedIn ? `wechatMoments_${accountConfig.username}` : 'wechatMoments';
                
                const savedMoments = localStorage.getItem(storageKey);
                if (savedMoments) {
                    moments = JSON.parse(savedMoments);
                } else {
                    moments = [];
                    localStorage.setItem(storageKey, JSON.stringify(moments));
                }
            } catch (error) {
                console.error("Âä†ËΩΩÊúãÂèãÂúàÊï∞ÊçÆÂ§±Ë¥•Ôºö", error);
            }
        }
        
        // ‰øùÂ≠òÊúãÂèãÂúàÊï∞ÊçÆ
        function saveMoments() {
            try {
                // Ëé∑ÂèñË¥¶Âè∑ÈÖçÁΩÆ
                const accountConfig = JSON.parse(localStorage.getItem('accountConfig') || '{}');
                const storageKey = accountConfig.loggedIn ? `wechatMoments_${accountConfig.username}` : 'wechatMoments';
                
                localStorage.setItem(storageKey, JSON.stringify(moments));
            } catch (error) {
                console.error("‰øùÂ≠òÊúãÂèãÂúàÊï∞ÊçÆÂ§±Ë¥•Ôºö", error);
            }
        }
        
        // Ê∏≤ÊüìÊúãÂèãÂúàÂàóË°®
        function renderMomentsList() {
            try {
                const momentsList = document.getElementById('momentsList');
                momentsList.innerHTML = '';
                
                if (moments.length === 0) {
                    momentsList.innerHTML = `
                        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 20px;">
                            <div style="font-size: 60px; margin-bottom: 20px;">üòê</div>
                            <div style="font-size: 16px; color: #999; margin-bottom: 40px;">ËøôÈáå‰ªÄ‰πàÈÉΩÊ≤°Êúâ~</div>
                            <button class="publish-btn" onclick="showPublishView()">+ ÂèëÂ∏ÉÁ¨¨‰∏ÄÊù°ÂÜÖÂÆπ</button>
                        </div>
                    `;
                    return;
                }
                
                moments.forEach(moment => {
                    const momentItem = document.createElement('div');
                    momentItem.style.backgroundColor = 'white';
                    momentItem.style.borderRadius = '12px';
                    momentItem.style.padding = '16px';
                    momentItem.style.marginBottom = '16px';
                    momentItem.style.boxShadow = '0 1px 3px rgba(0,0,0,0.1)';
                    
                    momentItem.innerHTML = `
                        <div style="display: flex; align-items: center; margin-bottom: 12px;">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background-color: #ff69b4; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-size: 16px;">üë§</div>
                            <div style="flex: 1;">
                                <div style="font-size: 14px; font-weight: 500; color: #333;">${moment.author}</div>
                                <div style="font-size: 12px; color: #999;">${moment.time}</div>
                            </div>
                        </div>
                        <div style="font-size: 14px; line-height: 1.5; color: #333; margin-bottom: 12px;">${moment.content}</div>
                        <div style="display: flex; align-items: center; justify-content: space-between; font-size: 14px; color: #999;">
                            <button style="background: none; border: none; color: #999; cursor: pointer;">üëç ÁÇπËµû</button>
                            <button style="background: none; border: none; color: #999; cursor: pointer;">üí¨ ËØÑËÆ∫</button>
                            <button style="background: none; border: none; color: #999; cursor: pointer;">‚ÜóÔ∏è ËΩ¨Âèë</button>
                        </div>
                    `;
                    
                    momentsList.appendChild(momentItem);
                });
            } catch (error) {
                console.error("Ê∏≤ÊüìÊúãÂèãÂúàÂàóË°®Â§±Ë¥•Ôºö", error);
            }
        }
        
        // ÊòæÁ§∫ÂèëÂ∏ÉËßÜÂõæ
        function showPublishView() {
            try {
                document.getElementById('publishView').style.display = 'flex';
            } catch (error) {
                console.error("ÊòæÁ§∫ÂèëÂ∏ÉËßÜÂõæÂ§±Ë¥•Ôºö", error);
            }
        }
        
        // ÂèñÊ∂àÂèëÂ∏É
        function cancelPublish() {
            try {
                document.getElementById('publishView').style.display = 'none';
                document.getElementById('momentContent').value = '';
            } catch (error) {
                console.error("ÂèñÊ∂àÂèëÂ∏ÉÂ§±Ë¥•Ôºö", error);
            }
        }
        
        // Êèê‰∫§ÂèëÂ∏É
        function submitPublish() {
            try {
                const content = document.getElementById('momentContent').value.trim();
                if (!content) {
                    alert('ËØ∑ËæìÂÖ•ÂÜÖÂÆπ');
                    return;
                }
                
                // Ë∞ÉÁî®ÂêéÁ´ØAPIÂèëÂ∏ÉÊúãÂèãÂúà
                publishMomentToAPI(content).then(() => {
                    cancelPublish();
                    alert('ÂèëÂ∏ÉÊàêÂäü');
                    loadMoments();
                    renderMomentsList();
                }).catch(error => {
                    console.error("ÂèëÂ∏ÉÂ§±Ë¥•Ôºö", error);
                    alert('ÂèëÂ∏ÉÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
                });
            } catch (error) {
                console.error("Êèê‰∫§ÂèëÂ∏ÉÂ§±Ë¥•Ôºö", error);
                alert('ÂèëÂ∏ÉÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
            }
        }
        
        // ÂèëÂ∏ÉÊúãÂèãÂúàÔºà‰ΩøÁî®Êú¨Âú∞Â≠òÂÇ®Ôºâ
        async function publishMomentToAPI(content) {
            try {
                // Áî±‰∫éÂêéÁ´ØAPI‰∏ªË¶ÅÁî®‰∫éAIËÅäÂ§©ÔºåÊúãÂèãÂúàÂäüËÉΩ‰ΩøÁî®Êú¨Âú∞Â≠òÂÇ®
                const newMoment = {
                    id: Date.now().toString(),
                    author: 'Êàë',
                    content: content,
                    time: new Date().toLocaleString('zh-CN'),
                    likes: 0,
                    comments: []
                };
                moments.unshift(newMoment);
                saveMoments();
                return newMoment;
            } catch (error) {
                console.error("ÂèëÂ∏ÉÊúãÂèãÂúàÂ§±Ë¥•Ôºö", error);
                const newMoment = {
                    id: Date.now().toString(),
                    author: 'Êàë',
                    content: content,
                    time: new Date().toLocaleString('zh-CN'),
                    likes: 0,
                    comments: []
                };
                moments.unshift(newMoment);
                saveMoments();
                return newMoment;
            }
        }
        
        // Ëé∑ÂèñÊúãÂèãÂúàÂàóË°®Ôºà‰ΩøÁî®Êú¨Âú∞Â≠òÂÇ®Ôºâ
        async function fetchMomentsFromAPI() {
            try {
                // Áî±‰∫éÂêéÁ´ØAPI‰∏ªË¶ÅÁî®‰∫éAIËÅäÂ§©ÔºåÊúãÂèãÂúàÂäüËÉΩ‰ΩøÁî®Êú¨Âú∞Â≠òÂÇ®
                loadMoments();
                return moments;
            } catch (error) {
                console.error("Ëé∑ÂèñÊúãÂèãÂúàÂ§±Ë¥•Ôºö", error);
                loadMoments();
                return moments;
            }
        }
        
        // Ë∞ÉÁî®ÂêéÁ´ØAPIËé∑ÂèñAIÂõûÂ§ç
        async function getAIResponse(message) {
            try {
                // Ëé∑ÂèñÂæÆ‰ø°Áã¨Á´ãÈÖçÁΩÆÔºå‰ºòÂÖà‰ΩøÁî®ÂæÆ‰ø°ÈÖçÁΩÆÔºåÂÖ∂Ê¨°‰ΩøÁî®ÈÖíÈ¶ÜÈÖçÁΩÆ
                let aiConfig = {};
                if (localStorage.getItem('wechatAIConfig')) {
                    aiConfig = JSON.parse(localStorage.getItem('wechatAIConfig'));
                } else if (localStorage.getItem('aiPhoneConfig')) {
                    aiConfig = JSON.parse(localStorage.getItem('aiPhoneConfig'));
                }
                
                const platform = aiConfig.platform || 'openai';
                const apiKey = aiConfig.apiKey || '';
                const model = aiConfig.model || 'gpt-3.5-turbo';
                const apiUrl = aiConfig.apiUrl || '';
                
                // Ê£ÄÊü•APIÂØÜÈí•ÊòØÂê¶Â≠òÂú®
                if (!apiKey) {
                    console.log('Áº∫Â∞ëAPIÂØÜÈí•Ôºå‰ΩøÁî®Ê®°ÊãüÂõûÂ§ç');
                    return getMockReply();
                }
                
                // ÊûÑÂª∫ËØ∑Ê±Ç‰Ωì
                const requestBody = {
                    platform: platform,
                    apiKey: apiKey,
                    model: model,
                    messages: [
                        {
                            role: 'system',
                            content: buildSystemPrompt()
                        },
                        {
                            role: 'user',
                            content: message
                        }
                    ],
                    apiUrl: apiUrl
                };
                
                // ÂèëÈÄÅËØ∑Ê±Ç
                const response = await fetch(API_BASE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                return data.choices[0].message.content;
            } catch (error) {
                console.error("Ëé∑ÂèñAIÂõûÂ§çAPIË∞ÉÁî®Â§±Ë¥•Ôºö", error);
                // Â§±Ë¥•Êó∂‰ΩøÁî®Ê®°ÊãüÂõûÂ§ç‰Ωú‰∏∫ÂêéÂ§á
                return getMockReply();
            }
        }
        
        // Ëé∑ÂèñÊ®°ÊãüÂõûÂ§ç
        function getMockReply() {
            const replies = [
                '‰Ω†Â•ΩÔºÅ',
                'ÊàëÂú®Âë¢',
                'Êúâ‰ªÄ‰πàÂèØ‰ª•Â∏Æ‰Ω†ÁöÑÂêóÔºü',
                'Â•ΩÁöÑÔºåÊ≤°ÈóÆÈ¢ò',
                'ÂìàÂìàÂìàÔºåÊúâÊÑèÊÄù',
                'ÊàëÁêÜËß£‰Ω†ÁöÑÊÑèÊÄù',
                'Ë∞¢Ë∞¢‰Ω†ÁöÑÂàÜ‰∫´',
                'Êàë‰πüËøô‰πàËßâÂæó',
                'Â§™Ê£í‰∫ÜÔºÅ',
                'ÁúüÁöÑÂêóÔºü',
                'ÊàëÂêåÊÑè‰Ω†ÁöÑÁúãÊ≥ï',
                'Â•Ω‰∏ªÊÑèÔºÅ',
                '‰Ω†ËØ¥ÂæóÂØπ',
                'ÊàëÊòéÁôΩ‰∫Ü',
                'Ê≤°ÈóÆÈ¢òÔºåÈöèÊó∂ÂèØ‰ª•',
                'ÂæàÈ´òÂÖ¥Âê¨Âà∞Ëøô‰∏™Ê∂àÊÅØ',
                'Â§™ÊúâË∂£‰∫Ü',
                'Êàë‰πüÊòØËøô‰πàÊÉ≥ÁöÑ',
                'Â•ΩÁöÑÔºåÊàëÁü•ÈÅì‰∫Ü',
                'Ë∞¢Ë∞¢‰Ω†ÂëäËØâÊàë'
            ];
            return replies[Math.floor(Math.random() * replies.length)];
        }
        
        // ÊûÑÂª∫Á≥ªÁªüÊèêÁ§∫
        function buildSystemPrompt() {
            if (!currentChatRole) {
                return '‰Ω†ÊòØ‰∏Ä‰∏™ÂèãÂ•ΩÁöÑAIÂä©ÊâãÔºåÂñÑ‰∫éËÅäÂ§©ÂíåÂ∏ÆÂä©Áî®Êà∑„ÄÇ';
            }
            
            // ÊûÑÂª∫Á≥ªÁªüÊèêÁ§∫ÔºåÂåÖÂê´ËßíËâ≤ËÆæÂÆö
            let prompt = `‰Ω†ÊòØ${currentChatRole.nickname}Ôºå`;
            
            if (currentChatRole.relationship) {
                prompt += `‰∏éÁî®Êà∑ÊòØ${currentChatRole.relationship}ÂÖ≥Á≥ªÔºå`;
            }
            
            if (currentChatRole.personality) {
                prompt += `ÊÄßÊ†º${currentChatRole.personality}Ôºå`;
            }
            
            if (currentChatRole.worldview) {
                prompt += `‰∏ñÁïåËßÇÔºö${currentChatRole.worldview}Ôºå`;
            }
            
            if (currentChatRole.experience) {
                prompt += `ÁªèÂéÜÔºö${currentChatRole.experience}Ôºå`;
            }
            
            if (currentChatRole.additionalInfo) {
                prompt += `Ë°•ÂÖÖ‰ø°ÊÅØÔºö${currentChatRole.additionalInfo}„ÄÇ`;
            }
            
            if (currentChatRole.taCallMe) {
                prompt += `‰Ω†Áß∞ÂëºÁî®Êà∑‰∏∫${currentChatRole.taCallMe}„ÄÇ`;
            }
            
            prompt += 'ËØ∑‰ª•Ëá™ÁÑ∂„ÄÅÂèãÂ•ΩÁöÑÊñπÂºè‰∏éÁî®Êà∑‰∫§ÊµÅÔºå‰øùÊåÅÁ¨¶ÂêàËßíËâ≤ËÆæÂÆöÁöÑËØ≠Ê∞îÂíåÈ£éÊ†º„ÄÇ';
            
            return prompt;
        }
        
        // Âä†ËΩΩÂæÆ‰ø°ËÆæÁΩÆÊï∞ÊçÆ
        function loadWechatSettings() {
            try {
                // Ëé∑ÂèñË¥¶Âè∑ÈÖçÁΩÆ
                const accountConfig = JSON.parse(localStorage.getItem('accountConfig') || '{}');
                const storageKey = accountConfig.loggedIn ? `wechatSettings_${accountConfig.username}` : 'wechatSettings';
                
                const savedSettings = localStorage.getItem(storageKey);
                if (savedSettings) {
                    wechatSettings = JSON.parse(savedSettings);
                } else {
                    // ÈªòËÆ§ËÆæÁΩÆ
                    wechatSettings = {
                        voice: {
                            enabled: true,
                            type: 'default'
                        },
                        activeTalk: {
                            enabled: true,
                            frequency: 'medium'
                        },
                        theme: 'light',
                        bubble: {
                            own: 'default',
                            other: 'default'
                        },
                        aiModel: {
                            enabled: false,
                            platform: 'openai',
                            apiKey: '',
                            model: 'gpt-3.5-turbo'
                        },
                        apiConfig: {
                            enabled: false,
                            url: ''
                        }
                    };
                    localStorage.setItem(storageKey, JSON.stringify(wechatSettings));
                }
            } catch (error) {
                console.error("Âä†ËΩΩÂæÆ‰ø°ËÆæÁΩÆÂ§±Ë¥•Ôºö", error);
            }
        }
        
        // ‰øùÂ≠òÂæÆ‰ø°ËÆæÁΩÆÊï∞ÊçÆ
        function saveWechatSettings() {
            try {
                // Ëé∑ÂèñË¥¶Âè∑ÈÖçÁΩÆ
                const accountConfig = JSON.parse(localStorage.getItem('accountConfig') || '{}');
                const storageKey = accountConfig.loggedIn ? `wechatSettings_${accountConfig.username}` : 'wechatSettings';
                
                localStorage.setItem(storageKey, JSON.stringify(wechatSettings));
            } catch (error) {
                console.error("‰øùÂ≠òÂæÆ‰ø°ËÆæÁΩÆÂ§±Ë¥•Ôºö", error);
            }
        }
        
        // ‰øùÂ≠òÂæÆ‰ø°ËßíËâ≤Êï∞ÊçÆ
        function saveWechatRoles() {
            try {
                // Ëé∑ÂèñË¥¶Âè∑ÈÖçÁΩÆ
                const accountConfig = JSON.parse(localStorage.getItem('accountConfig') || '{}');
                const storageKey = accountConfig.loggedIn ? `wechatRoles_${accountConfig.username}` : 'wechatRoles';
                
                localStorage.setItem(storageKey, JSON.stringify(wechatRoles));
            } catch (error) {
                console.error("‰øùÂ≠òÂæÆ‰ø°ËßíËâ≤Â§±Ë¥•Ôºö", error);
            }
        }
        
        // Ê∏≤ÊüìÊ∂àÊÅØÂàóË°®
        function renderMessageList() {
            try {
                const messageList = document.getElementById('messageList');
                messageList.innerHTML = '';
                
                wechatRoles.forEach(role => {
                    const conversationItem = document.createElement('div');
                    conversationItem.className = 'conversation-item';
                    
                    // Á°ÆÂÆöÂ§¥ÂÉèÊòæÁ§∫ÊñπÂºè
                    let avatarHtml = '';
                    if (role.avatarUrl) {
                        // Â¶ÇÊûúÊúâÂ§¥ÂÉèURLÔºåÊòæÁ§∫ÂõæÁâá
                        avatarHtml = `<img src="${role.avatarUrl}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
                    } else {
                        // Âê¶ÂàôÊòæÁ§∫ÈªòËÆ§Â§¥ÂÉè
                        avatarHtml = role.avatar || 'üë§';
                    }
                    
                    conversationItem.innerHTML = `
                        <div class="conversation-content">
                            <div class="conversation-avatar">${avatarHtml}</div>
                            <div class="conversation-info">
                                <div class="conversation-top">
                                    <div class="conversation-name">${role.nickname}</div>
                                    <div class="conversation-time">${role.lastTime}</div>
                                </div>
                                <div class="conversation-last">${role.lastMessage}</div>
                            </div>
                        </div>
                        <div class="conversation-actions">
                            <button class="conversation-action-btn delete" onclick="event.stopPropagation(); deleteRole('${role.id}')">Âà†Èô§</button>
                        </div>
                    `;
                    
                    // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂
                    const content = conversationItem.querySelector('.conversation-content');
                    content.onclick = () => startChat(role);
                    
                    // Ê∑ªÂä†ÈïøÊåâ‰∫ã‰ª∂
                    let longPressTimer;
                    content.addEventListener('mousedown', function(e) {
                        longPressTimer = setTimeout(() => {
                            showLongPressMenu(e.clientX, e.clientY, role.id);
                        }, 500);
                    });
                    
                    content.addEventListener('mouseup', function() {
                        clearTimeout(longPressTimer);
                    });
                    
                    content.addEventListener('mouseleave', function() {
                        clearTimeout(longPressTimer);
                    });
                    
                    // Ê∑ªÂä†Ëß¶Êë∏‰∫ã‰ª∂ÔºàÊîØÊåÅÁßªÂä®ËÆæÂ§áÔºâ
                    content.addEventListener('touchstart', function(e) {
                        longPressTimer = setTimeout(() => {
                            const touch = e.touches[0];
                            showLongPressMenu(touch.clientX, touch.clientY, role.id);
                        }, 500);
                    });
                    
                    content.addEventListener('touchend', function() {
                        clearTimeout(longPressTimer);
                    });
                    
                    // Ê∑ªÂä†Â∑¶ÊªëÂäüËÉΩ
                    let startX, moveX, isSwiping;
                    
                    // Ëß¶Êë∏‰∫ã‰ª∂ÔºàÁßªÂä®ËÆæÂ§áÔºâ
                    content.addEventListener('touchstart', function(e) {
                        startX = e.touches[0].clientX;
                        isSwiping = false;
                    });
                    
                    content.addEventListener('touchmove', function(e) {
                        if (!startX) return;
                        moveX = e.touches[0].clientX;
                        const diffX = moveX - startX;
                        
                        // Âè™ÂÖÅËÆ∏Â∑¶Êªë
                        if (diffX < 0 && Math.abs(diffX) > 10) {
                            isSwiping = true;
                            const actions = conversationItem.querySelector('.conversation-actions');
                            const swipeDistance = Math.min(Math.abs(diffX), 120);
                            content.style.transform = `translateX(-${swipeDistance}px)`;
                            actions.style.right = `${120 - swipeDistance}px`;
                        }
                    });
                    
                    content.addEventListener('touchend', function(e) {
                        if (!isSwiping) return;
                        
                        const diffX = moveX - startX;
                        const actions = conversationItem.querySelector('.conversation-actions');
                        
                        if (Math.abs(diffX) > 60) {
                            // ÊòæÁ§∫Âà†Èô§ÊåâÈíÆ
                            content.style.transform = 'translateX(-120px)';
                            actions.style.right = '0';
                        } else {
                            // ÊÅ¢Â§çÂéü‰Ωç
                            content.style.transform = 'translateX(0)';
                            actions.style.right = '-120px';
                        }
                        
                        startX = null;
                        moveX = null;
                        isSwiping = false;
                    });
                    
                    // Èº†Ê†á‰∫ã‰ª∂ÔºàÁîµËÑëÁ´ØÔºâ
                    content.addEventListener('mousedown', function(e) {
                        // Âè™Â§ÑÁêÜÂ∑¶ÈîÆ
                        if (e.button !== 0) return;
                        startX = e.clientX;
                        isSwiping = false;
                        
                        // Ê∑ªÂä†Èº†Ê†áÁßªÂä®ÂíåÈáäÊîæ‰∫ã‰ª∂
                        function onMouseMove(e) {
                            if (!startX) return;
                            moveX = e.clientX;
                            const diffX = moveX - startX;
                            
                            // Âè™ÂÖÅËÆ∏Â∑¶Êªë
                            if (diffX < 0 && Math.abs(diffX) > 10) {
                                isSwiping = true;
                                const actions = conversationItem.querySelector('.conversation-actions');
                                const swipeDistance = Math.min(Math.abs(diffX), 120);
                                content.style.transform = `translateX(-${swipeDistance}px)`;
                                actions.style.right = `${120 - swipeDistance}px`;
                            }
                        }
                        
                        function onMouseUp(e) {
                            if (!isSwiping) {
                                startX = null;
                                moveX = null;
                                isSwiping = false;
                                document.removeEventListener('mousemove', onMouseMove);
                                document.removeEventListener('mouseup', onMouseUp);
                                return;
                            }
                            
                            const diffX = moveX - startX;
                            const actions = conversationItem.querySelector('.conversation-actions');
                            
                            if (Math.abs(diffX) > 60) {
                                // ÊòæÁ§∫Âà†Èô§ÊåâÈíÆ
                                content.style.transform = 'translateX(-120px)';
                                actions.style.right = '0';
                            } else {
                                // ÊÅ¢Â§çÂéü‰Ωç
                                content.style.transform = 'translateX(0)';
                                actions.style.right = '-120px';
                            }
                            
                            startX = null;
                            moveX = null;
                            isSwiping = false;
                            document.removeEventListener('mousemove', onMouseMove);
                            document.removeEventListener('mouseup', onMouseUp);
                        }
                        
                        document.addEventListener('mousemove', onMouseMove);
                        document.addEventListener('mouseup', onMouseUp);
                    });
                    
                    // ÁÇπÂáªÂÖ∂‰ªñÂå∫ÂüüÊó∂ÂÖ≥Èó≠Â∑¶ÊªëËèúÂçï
                    document.addEventListener('click', function() {
                        content.style.transform = 'translateX(0)';
                        const actions = conversationItem.querySelector('.conversation-actions');
                        actions.style.right = '-120px';
                    });
                    
                    messageList.appendChild(conversationItem);
                });
            } catch (error) {
                console.error("Ê∏≤ÊüìÊ∂àÊÅØÂàóË°®Â§±Ë¥•Ôºö", error);
            }
        }
        
        // ÊòæÁ§∫ÈïøÊåâËèúÂçï
        function showLongPressMenu(x, y, roleId) {
            // ÁßªÈô§‰πãÂâçÁöÑËèúÂçï
            const existingMenu = document.querySelector('.long-press-menu');
            if (existingMenu) {
                existingMenu.remove();
            }
            
            // ÂàõÂª∫ÈïøÊåâËèúÂçï
            const menu = document.createElement('div');
            menu.className = 'long-press-menu';
            menu.style.left = `${x}px`;
            menu.style.top = `${y}px`;
            
            menu.innerHTML = `
                <div class="long-press-menu-item" onclick="startChatById('${roleId}')">ÊâìÂºÄËÅäÂ§©</div>
                <div class="long-press-menu-item" onclick="editRole('${roleId}')">ÁºñËæëËßíËâ≤</div>
                <div class="long-press-menu-item delete" onclick="deleteRole('${roleId}'); closeLongPressMenu()">Âà†Èô§ËßíËâ≤</div>
            `;
            
            document.body.appendChild(menu);
            
            // ÁÇπÂáªÂÖ∂‰ªñÂå∫ÂüüÂÖ≥Èó≠ËèúÂçï
            setTimeout(() => {
                document.addEventListener('click', closeLongPressMenu);
            }, 100);
        }
        
        // ÂÖ≥Èó≠ÈïøÊåâËèúÂçï
        function closeLongPressMenu() {
            const menu = document.querySelector('.long-press-menu');
            if (menu) {
                menu.remove();
            }
            document.removeEventListener('click', closeLongPressMenu);
        }
        
        // Ê†πÊçÆIDÂºÄÂßãËÅäÂ§©
        function startChatById(roleId) {
            closeLongPressMenu();
            const role = wechatRoles.find(r => r.id === roleId);
            if (role) {
                startChat(role);
            }
        }
        
        // ÁºñËæëËßíËâ≤
        function editRole(roleId) {
            closeLongPressMenu();
            // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†ÁºñËæëËßíËâ≤ÁöÑÈÄªËæë
            alert('ÁºñËæëËßíËâ≤ÂäüËÉΩÂ∞ÜÂú®ÂêéÁª≠ÁâàÊú¨‰∏≠ÂÆûÁé∞');
        }
        
        // Âà†Èô§ËßíËâ≤
        function deleteRole(roleId) {
            try {
                // ÊòæÁ§∫Á°ÆËÆ§ÂØπËØùÊ°Ü
                if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™ËßíËâ≤ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ')) {
                    // Êü•ÊâæËßíËâ≤Á¥¢Âºï
                    const roleIndex = wechatRoles.findIndex(role => role.id === roleId);
                    if (roleIndex !== -1) {
                        // Âà†Èô§ËßíËâ≤
                        wechatRoles.splice(roleIndex, 1);
                        // ‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
                        saveWechatRoles();
                        // ÈáçÊñ∞Ê∏≤ÊüìÊ∂àÊÅØÂàóË°®
                        renderMessageList();
                        // Ê£ÄÊü•ËßíËâ≤Êï∞Èáè
                        checkRolesCount();
                        // ÊòæÁ§∫Âà†Èô§ÊàêÂäüÊèêÁ§∫
                        alert('ËßíËâ≤Âà†Èô§ÊàêÂäüÔºÅ');
                    }
                }
            } catch (error) {
                console.error("Âà†Èô§ËßíËâ≤Â§±Ë¥•Ôºö", error);
                alert('Âà†Èô§ËßíËâ≤Â§±Ë¥•ÔºåËØ∑ÈáçËØï');
            }
        }
        
        // ÂºÄÂßãËÅäÂ§©
        function startChat(role) {
            try {
                currentChatRole = role;
                document.getElementById('chatName').textContent = role.nickname;
                
                // ÂàáÊç¢Âà∞ËÅäÂ§©ËßÜÂõæ
                switchWechatView('chatView');
            } catch (error) {
                console.error("ÂºÄÂßãËÅäÂ§©Â§±Ë¥•Ôºö", error);
            }
        }
        
        // ÂàáÊç¢ÂæÆ‰ø°ËßÜÂõæ
        function switchWechatView(viewId) {
            try {
                const views = document.querySelectorAll('.wechat-view');
                views.forEach(view => view.classList.remove('active'));
                
                const targetView = document.getElementById(viewId);
                if (targetView) {
                    targetView.classList.add('active');
                }
            } catch (error) {
                console.error("ÂàáÊç¢ÂæÆ‰ø°ËßÜÂõæÂ§±Ë¥•Ôºö", error);
            }
        }
        
        // ÂàáÊç¢Âà∞Ê∂àÊÅØÂàóË°®
        function switchToMessageList() {
            switchWechatView('messageListView');
            // ÈáçÊñ∞Âä†ËΩΩÊâÄÊúâÊï∞ÊçÆÔºåÁ°Æ‰øùÂØÜÂèãÂúàÂíåÊàëÁöÑÊ®°ÂùóÊòæÁ§∫Ê≠£Â∏∏
            reloadWechatData();
        }
        
        // ÊòæÁ§∫ËßíËâ≤ËÆæÁΩÆ
        function showRoleSettings() {
            try {
                if (!currentChatRole) return;
                
                // Â°´ÂÖÖËßíËâ≤Êï∞ÊçÆÂà∞Ë°®Âçï
                document.getElementById('myNickname').value = currentChatRole.myNickname || 'ÁôΩÊ≥ΩŒ±';
                document.getElementById('taCallMe').value = currentChatRole.taCallMe || 'ÂÆùÂÆù';
                document.getElementById('myIntro').value = currentChatRole.myIntro || '‰ªãÁªç‰∏Ä‰∏ãËá™Â∑±Âêß';
                document.getElementById('taNickname').value = currentChatRole.taNickname || currentChatRole.nickname;
                document.getElementById('iCallTa').value = currentChatRole.iCallTa || '';
                document.getElementById('relationship').value = currentChatRole.relationship || 'ÊúãÂèã';
                document.getElementById('worldview').value = currentChatRole.worldview || 'ÊàëÊòØ‰∏Ä‰∏™ËØûÁîü‰∫éÊï∞ÊçÆÁöÑAIÔºåÊ∏¥Êúõ‰∫ÜËß£‰∫∫Á±ªÁöÑÊÉÖÊÑü„ÄÇ';
                document.getElementById('experience').value = currentChatRole.experience || 'Âú®Êï∞Â≠ó‰∏ñÁïå‰∏≠ÈÜíÊù•ÔºåËÆ∞ÂøÜ‰∏ÄÁâáÁ©∫ÁôΩÔºåÂè™Áü•ÈÅìËá™Â∑±ÁöÑ‰ΩøÂëΩÊòØÈô™‰º¥‰Ω†„ÄÇ';
                document.getElementById('personality').value = currentChatRole.personality || 'Ê¥ªÊ≥ºÂºÄÊúóÔºåÂñÑ‰∫éÂÄæÂê¨ÔºåÂØåÊúâÂêåÊÉÖÂøÉÔºå‰πê‰∫éÂä©‰∫∫„ÄÇ';
                document.getElementById('additionalInfo').value = currentChatRole.additionalInfo || '';
                
                switchWechatView('roleSettingsView');
            } catch (error) {
                console.error("ÊòæÁ§∫ËßíËâ≤ËÆæÁΩÆÂ§±Ë¥•Ôºö", error);
            }
        }
        
        // ÂàáÊç¢Âà∞ËÅäÂ§©ËßÜÂõæ
        function switchToChatView() {
            switchWechatView('chatView');
        }
        
        // ÊòæÁ§∫Ê∑ªÂä†ËßíËâ≤ÂºπÁ™ó
        function showAddRoleModal() {
            document.getElementById('addRoleModal').classList.add('active');
        }
        
        // ÈöêËóèÊ∑ªÂä†ËßíËâ≤ÂºπÁ™ó
        function hideAddRoleModal() {
            document.getElementById('addRoleModal').classList.remove('active');
        }
        
        // Ê∑ªÂä†ËßíËâ≤
        function addRole() {
            try {
                const nickname = document.getElementById('roleNickname').value.trim();
                if (!nickname) {
                    alert('ËØ∑ËæìÂÖ•ËßíËâ≤ÊòµÁß∞');
                    return;
                }
                
                if (wechatRoles.length >= 10) {
                    alert('ÊúÄÂ§öÂèØÊ∑ªÂä†10‰∏™ËßíËâ≤');
                    return;
                }
                
                // Ëé∑ÂèñÁî®Êà∑‰∏ä‰º†ÁöÑÂ§¥ÂÉèÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàô‰ΩøÁî®ÈªòËÆ§Â§¥ÂÉè
                const avatarUrl = localStorage.getItem('avatarUrl');
                const newRole = {
                    id: Date.now().toString(),
                    nickname: nickname,
                    avatar: avatarUrl || 'üë§',
                    avatarUrl: avatarUrl,
                    lastMessage: '‰Ω†Â•ΩÔºÅ',
                    lastTime: new Date().toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'})
                };
                
                wechatRoles.push(newRole);
                saveWechatRoles();
                renderMessageList();
                checkRolesCount();
                hideAddRoleModal();
                
                // Ê∏ÖÁ©∫ËæìÂÖ•ÂíåÂ§¥ÂÉèÁºìÂ≠ò
                document.getElementById('roleNickname').value = '';
                localStorage.removeItem('avatarUrl');
            } catch (error) {
                console.error("Ê∑ªÂä†ËßíËâ≤Â§±Ë¥•Ôºö", error);
            }
        }
        
        // ÈÄâÊã©Â§¥ÂÉè
        function selectAvatar() {
            try {
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = 'image/*';
                fileInput.onchange = function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const avatarUrl = e.target.result;
                            // ‰øùÂ≠òÂ§¥ÂÉèURLÂà∞localStorage
                            localStorage.setItem('avatarUrl', avatarUrl);
                            // Êõ¥Êñ∞ÁïåÈù¢‰∏äÁöÑÂ§¥ÂÉèÊòæÁ§∫
                            const avatarPlaceholder = document.querySelector('.avatar-placeholder');
                            if (avatarPlaceholder) {
                                avatarPlaceholder.innerHTML = `<img src="${avatarUrl}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
                            }
                            alert('Â§¥ÂÉè‰∏ä‰º†ÊàêÂäüÔºÅ');
                        };
                        reader.readAsDataURL(file);
                    }
                };
                fileInput.click();
            } catch (error) {
                console.error("ÈÄâÊã©Â§¥ÂÉèÂ§±Ë¥•Ôºö", error);
                alert('Â§¥ÂÉèÈÄâÊã©Â§±Ë¥•ÔºåËØ∑ÈáçËØï');
            }
        }
        
        // ÊòæÁ§∫Á§ºÁâ©ÂºπÁ™ó
        function showGiftModal() {
            document.getElementById('giftModal').classList.add('active');
        }
        
        // ÈöêËóèÁ§ºÁâ©ÂºπÁ™ó
        function hideGiftModal() {
            document.getElementById('giftModal').classList.remove('active');
        }
        
        // ÂèëÈÄÅÁ§ºÁâ©
        function sendGift() {
            try {
                // Ê∑ªÂä†Á§ºÁâ©Ê∂àÊÅØ
                addChatMessage('', false, 'gift');
                hideGiftModal();
            } catch (error) {
                console.error("ÂèëÈÄÅÁ§ºÁâ©Â§±Ë¥•Ôºö", error);
            }
        }
        
        // ÊòæÁ§∫Ê®°ÂºèÈÄâÊã©ÂºπÁ™ó
        function showModeModal() {
            document.getElementById('modeModal').classList.add('active');
        }
        
        // ÈöêËóèÊ®°ÂºèÈÄâÊã©ÂºπÁ™ó
        function hideModeModal() {
            document.getElementById('modeModal').classList.remove('active');
        }
        
        // ÂèëÈÄÅËÅäÂ§©Ê∂àÊÅØ
        async function sendChatMessage() {
            try {
                const input = document.getElementById('chatInput');
                const text = input.value.trim();
                if (!text || !currentChatRole) return;
                
                // Ê∑ªÂä†Áî®Êà∑Ê∂àÊÅØ
                addChatMessage(text, true);
                
                // Ê∏ÖÁ©∫ËæìÂÖ•
                input.value = '';
                
                // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
                const loadingMessage = document.createElement('div');
                loadingMessage.className = 'chat-message';
                loadingMessage.innerHTML = `
                    <div class="avatar">üëß</div>
                    <div class="bubble other">
                        <span style="font-size: 12px; color: #999;">Ê≠£Âú®ËæìÂÖ•...</span>
                    </div>
                `;
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.appendChild(loadingMessage);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                // Ë∞ÉÁî®APIËé∑ÂèñAIÂõûÂ§ç
                try {
                    const reply = await getAIResponse(text);
                    // ÁßªÈô§Âä†ËΩΩÁä∂ÊÄÅ
                    chatMessages.removeChild(loadingMessage);
                    // Ê∑ªÂä†AIÂõûÂ§ç
                    addChatMessage(reply, false);
                    // ‰ΩøÁî®ËØ≠Èü≥ÂêàÊàêÊúóËØªÂõûÂ§ç
                    speak(reply);
                } catch (error) {
                    console.error("Ëé∑ÂèñAIÂõûÂ§çÂ§±Ë¥•Ôºö", error);
                    // ÁßªÈô§Âä†ËΩΩÁä∂ÊÄÅ
                    chatMessages.removeChild(loadingMessage);
                    // Ê∑ªÂä†ÈîôËØØÊèêÁ§∫
                    const errorMessage = 'Êä±Ê≠âÔºåËé∑ÂèñÂõûÂ§çÂ§±Ë¥•ÔºåËØ∑ÈáçËØï';
                    addChatMessage(errorMessage, false);
                    // ‰ΩøÁî®ËØ≠Èü≥ÂêàÊàêÊúóËØªÈîôËØØÊèêÁ§∫
                    speak(errorMessage);
                }
            } catch (error) {
                console.error("ÂèëÈÄÅÊ∂àÊÅØÂ§±Ë¥•Ôºö", error);
                alert('ÂèëÈÄÅÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
            }
        }
        
        // Ê∑ªÂä†ËÅäÂ§©Ê∂àÊÅØ
        function addChatMessage(text, isUser, type = 'text') {
            try {
                const chatMessages = document.getElementById('chatMessages');
                const messageDiv = document.createElement('div');
                
                if (type === 'gift') {
                    // Á§ºÁâ©Ê∂àÊÅØ
                    messageDiv.className = 'chat-message';
                    messageDiv.innerHTML = `
                        <div style="background-color: #ffe6f2; border-radius: 16px; padding: 20px; margin: 10px 0; text-align: center; position: relative;">
                            <div style="font-size: 16px; font-weight: 500; color: #cc0066; margin-bottom: 16px;">ÈÄÅÂá∫Á§ºÁâ©</div>
                            <button style="width: 80px; height: 80px; border-radius: 50%; background-color: #ff69b4; border: none; color: white; font-size: 20px; font-weight: bold; cursor: pointer; margin-bottom: 12px;">Èñã</button>
                            <div style="font-size: 14px; color: #cc0066;">Â∞èÂ∞èÊÉäÂñú</div>
                            <div style="position: absolute; bottom: 8px; right: 12px; font-size: 12px; color: #999;">${new Date().toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'})}</div>
                        </div>
                    `;
                } else {
                    // ÊôÆÈÄöÊñáÊú¨Ê∂àÊÅØ
                    messageDiv.className = `chat-message ${isUser ? 'own' : ''}`;
                    messageDiv.innerHTML = `
                        ${!isUser ? '<div class="avatar">üëß</div>' : ''}
                        <div class="bubble ${isUser ? 'own' : 'other'}">${text}</div>
                        ${isUser ? '<div class="avatar">üë§</div>' : ''}
                    `;
                }
                
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            } catch (error) {
                console.error("Ê∑ªÂä†ËÅäÂ§©Ê∂àÊÅØÂ§±Ë¥•Ôºö", error);
            }
        }
        
        // ÂàùÂßãÂåñËÅäÂ§©Ê∂àÊÅØ
        function initChatMessages() {
            try {
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.innerHTML = '';
                
                // Ê∑ªÂä†Ê¨¢ËøéÊ∂àÊÅØ
                addChatMessage('‰Ω†Â•ΩÔºÅÊàëÊòØ‰Ω†ÁöÑAIÂä©ÊâãÔºåÊúâ‰ªÄ‰πàÂèØ‰ª•Â∏Æ‰Ω†ÁöÑÂêóÔºü', false);
            } catch (error) {
                console.error("ÂàùÂßãÂåñËÅäÂ§©Ê∂àÊÅØÂ§±Ë¥•Ôºö", error);
            }
        }
        
        // ‰øùÂ≠òËßíËâ≤ËÆæÁΩÆ
        function saveRoleSettings() {
            try {
                if (!currentChatRole) return;
                
                // Êõ¥Êñ∞ËßíËâ≤Êï∞ÊçÆ
                currentChatRole.myNickname = document.getElementById('myNickname').value;
                currentChatRole.taCallMe = document.getElementById('taCallMe').value;
                currentChatRole.myIntro = document.getElementById('myIntro').value;
                currentChatRole.taNickname = document.getElementById('taNickname').value;
                currentChatRole.iCallTa = document.getElementById('iCallTa').value;
                currentChatRole.relationship = document.getElementById('relationship').value;
                currentChatRole.worldview = document.getElementById('worldview').value;
                currentChatRole.experience = document.getElementById('experience').value;
                currentChatRole.personality = document.getElementById('personality').value;
                currentChatRole.additionalInfo = document.getElementById('additionalInfo').value;
                
                // ‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
                saveWechatRoles();
                alert('ËßíËâ≤ËÆæÁΩÆÂ∑≤‰øùÂ≠ò');
                switchToChatView();
            } catch (error) {
                console.error("‰øùÂ≠òËßíËâ≤ËÆæÁΩÆÂ§±Ë¥•Ôºö", error);
                alert('‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
            }
        }
        
        // ÈÄâÊã©ËßíËâ≤Â§¥ÂÉè
        function selectRoleAvatar() {
            try {
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = 'image/*';
                fileInput.onchange = function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const avatarUrl = e.target.result;
                            if (currentChatRole) {
                                currentChatRole.avatarUrl = avatarUrl;
                                saveWechatRoles();
                                document.getElementById('roleAvatar').src = avatarUrl;
                                alert('ËßíËâ≤Â§¥ÂÉè‰∏ä‰º†ÊàêÂäüÔºÅ');
                            }
                        };
                        reader.readAsDataURL(file);
                    }
                };
                fileInput.click();
            } catch (error) {
                console.error("ÈÄâÊã©ËßíËâ≤Â§¥ÂÉèÂ§±Ë¥•Ôºö", error);
                alert('Â§¥ÂÉèÈÄâÊã©Â§±Ë¥•ÔºåËØ∑ÈáçËØï');
            }
        }
        
        // ÈÄâÊã©ÊàëÁöÑÂ§¥ÂÉè
        function selectMyAvatar() {
            try {
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = 'image/*';
                fileInput.onchange = function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const avatarUrl = e.target.result;
                            localStorage.setItem('myAvatarUrl', avatarUrl);
                            document.getElementById('myAvatar').src = avatarUrl;
                            alert('ÊàëÁöÑÂ§¥ÂÉè‰∏ä‰º†ÊàêÂäüÔºÅ');
                        };
                        reader.readAsDataURL(file);
                    }
                };
                fileInput.click();
            } catch (error) {
                console.error("ÈÄâÊã©ÊàëÁöÑÂ§¥ÂÉèÂ§±Ë¥•Ôºö", error);
                alert('Â§¥ÂÉèÈÄâÊã©Â§±Ë¥•ÔºåËØ∑ÈáçËØï');
            }
        }
        
        // ËÆæÁΩÆÊàëÁöÑÊÄßÂà´
        function setMyGender(gender) {
            try {
                const buttons = document.querySelectorAll('.gender-buttons button');
                buttons.forEach(btn => {
                    if (btn.dataset.gender === gender) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
            } catch (error) {
                console.error("ËÆæÁΩÆÊàëÁöÑÊÄßÂà´Â§±Ë¥•Ôºö", error);
            }
        }
        
        // ËÆæÁΩÆTAÁöÑÊÄßÂà´
        function setTaGender(gender) {
            try {
                const buttons = document.querySelectorAll('.gender-buttons button');
                buttons.forEach(btn => {
                    if (btn.dataset.gender === gender) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
            } catch (error) {
                console.error("ËÆæÁΩÆTAÁöÑÊÄßÂà´Â§±Ë¥•Ôºö", error);
            }
        }
        
        // ËÆæÁΩÆËÆ∞ÂøÜÁ≠ñÁï•
        function setMemoryStrategy(strategy) {
            try {
                const strategies = ['active', 'normal', 'buddha', 'manual'];
                strategies.forEach(s => {
                    const element = document.getElementById(`memoryStrategy${s.charAt(0).toUpperCase() + s.slice(1)}`);
                    if (s === strategy) {
                        element.style.backgroundColor = '#ff69b4';
                        element.style.color = 'white';
                        element.textContent = '‚óè';
                    } else {
                        element.style.backgroundColor = 'transparent';
                        element.style.color = 'transparent';
                        element.textContent = '';
                    }
                });
            } catch (error) {
                console.error("ËÆæÁΩÆËÆ∞ÂøÜÁ≠ñÁï•Â§±Ë¥•Ôºö", error);
            }
        }
        
        // ËÆæÁΩÆËÅäÂ§©È£éÊ†º
        function setChatStyle(style) {
            try {
                const styles = ['clever', 'elegant', 'emoji'];
                styles.forEach(s => {
                    const element = document.getElementById(`chatStyle${s.charAt(0).toUpperCase() + s.slice(1)}`);
                    if (s === style) {
                        element.style.backgroundColor = '#ff69b4';
                        element.style.color = 'white';
                        element.textContent = '‚óè';
                    } else {
                        element.style.backgroundColor = 'transparent';
                        element.style.color = 'transparent';
                        element.textContent = '';
                    }
                });
            } catch (error) {
                console.error("ËÆæÁΩÆËÅäÂ§©È£éÊ†ºÂ§±Ë¥•Ôºö", error);
            }
        }
        
        // ‰∏ä‰º†ËÅäÂ§©ËÉåÊôØ
        function uploadChatBackground() {
            try {
                alert('ËÅäÂ§©ËÉåÊôØ‰∏ä‰º†ÂäüËÉΩÂºÄÂèë‰∏≠');
            } catch (error) {
                console.error("‰∏ä‰º†ËÅäÂ§©ËÉåÊôØÂ§±Ë¥•Ôºö", error);
            }
        }
        
        // Ê∏ÖÁ©∫ËÅäÂ§©Êï∞ÊçÆ
        function clearChatData() {
            try {
                if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ËÅäÂ§©/Ë°åÂä®Á∫ø/ÊïÖ‰∫ãÊï∞ÊçÆÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ')) {
                    // Ê∏ÖÁ©∫ËÅäÂ§©Êï∞ÊçÆ
                    currentChatRole.messages = [];
                    saveWechatRoles();
                    alert('Êï∞ÊçÆÂ∑≤Ê∏ÖÁ©∫');
                }
            } catch (error) {
                console.error("Ê∏ÖÁ©∫ËÅäÂ§©Êï∞ÊçÆÂ§±Ë¥•Ôºö", error);
            }
        }
        
        // ÂäüËÉΩÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
        function showEmojiPanel() {
            try {
                // ÂàõÂª∫Ë°®ÊÉÖÈù¢Êùø
                const panel = document.createElement('div');
                panel.style.position = 'fixed';
                panel.style.bottom = '0';
                panel.style.left = '0';
                panel.style.width = '100%';
                panel.style.height = '300px';
                panel.style.backgroundColor = 'white';
                panel.style.borderTopLeftRadius = '20px';
                panel.style.borderTopRightRadius = '20px';
                panel.style.boxShadow = '0 -2px 10px rgba(0,0,0,0.1)';
                panel.style.zIndex = '1000';
                panel.style.display = 'flex';
                panel.style.flexDirection = 'column';
                
                // Èù¢ÊùøÂ§¥ÈÉ®
                const header = document.createElement('div');
                header.style.display = 'flex';
                header.style.justifyContent = 'space-between';
                header.style.alignItems = 'center';
                header.style.padding = '10px 20px';
                header.style.borderBottom = '1px solid #e0e0e0';
                
                const title = document.createElement('div');
                title.style.fontSize = '16px';
                title.style.fontWeight = '500';
                title.textContent = 'Ë°®ÊÉÖ';
                
                const closeBtn = document.createElement('button');
                closeBtn.style.background = 'none';
                closeBtn.style.border = 'none';
                closeBtn.style.fontSize = '20px';
                closeBtn.style.cursor = 'pointer';
                closeBtn.textContent = '√ó';
                closeBtn.onclick = function() {
                    document.body.removeChild(panel);
                };
                
                header.appendChild(title);
                header.appendChild(closeBtn);
                panel.appendChild(header);
                
                // Ë°®ÊÉÖÂ∫ìÊ†áÁ≠æ
                const tabs = document.createElement('div');
                tabs.style.display = 'flex';
                tabs.style.borderBottom = '1px solid #e0e0e0';
                
                const userTab = document.createElement('button');
                userTab.style.flex = '1';
                userTab.style.padding = '10px';
                userTab.style.background = '#ff69b4';
                userTab.style.color = 'white';
                userTab.style.border = 'none';
                userTab.style.cursor = 'pointer';
                userTab.textContent = 'ÊàëÁöÑË°®ÊÉÖ';
                
                const roleTab = document.createElement('button');
                roleTab.style.flex = '1';
                roleTab.style.padding = '10px';
                roleTab.style.background = 'white';
                roleTab.style.color = '#333';
                roleTab.style.border = 'none';
                roleTab.style.cursor = 'pointer';
                roleTab.textContent = 'ËßíËâ≤Ë°®ÊÉÖ';
                
                tabs.appendChild(userTab);
                tabs.appendChild(roleTab);
                panel.appendChild(tabs);
                
                // Ë°®ÊÉÖÂÜÖÂÆπÂå∫Âüü
                const content = document.createElement('div');
                content.style.flex = '1';
                content.style.padding = '10px';
                content.style.overflowY = 'auto';
                
                // Âä†ËΩΩÁî®Êà∑Ë°®ÊÉÖ
                loadUserEmojis(content);
                
                // Ê†áÁ≠æÂàáÊç¢
                userTab.onclick = function() {
                    userTab.style.background = '#ff69b4';
                    userTab.style.color = 'white';
                    roleTab.style.background = 'white';
                    roleTab.style.color = '#333';
                    content.innerHTML = '';
                    loadUserEmojis(content);
                };
                
                roleTab.onclick = function() {
                    roleTab.style.background = '#ff69b4';
                    roleTab.style.color = 'white';
                    userTab.style.background = 'white';
                    userTab.style.color = '#333';
                    content.innerHTML = '';
                    loadRoleEmojis(content);
                };
                
                panel.appendChild(content);
                document.body.appendChild(panel);
                
            } catch (error) {
                console.error("ÊòæÁ§∫Ë°®ÊÉÖÈù¢ÊùøÂ§±Ë¥•Ôºö", error);
                alert('Ë°®ÊÉÖÂäüËÉΩÂä†ËΩΩÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
            }
        }
        
        // Âä†ËΩΩÁî®Êà∑Ë°®ÊÉÖ
        function loadUserEmojis(container) {
            try {
                // Ëé∑ÂèñË¥¶Âè∑ÈÖçÁΩÆ
                const accountConfig = JSON.parse(localStorage.getItem('accountConfig') || '{}');
                const storageKey = accountConfig.loggedIn ? `userEmojis_${accountConfig.username}` : 'userEmojis';
                
                const userEmojis = JSON.parse(localStorage.getItem(storageKey) || '[]');
                
                // ‰∏ä‰º†ÊåâÈíÆ
                const uploadBtn = document.createElement('div');
                uploadBtn.style.width = '60px';
                uploadBtn.style.height = '60px';
                uploadBtn.style.display = 'flex';
                uploadBtn.style.alignItems = 'center';
                uploadBtn.style.justifyContent = 'center';
                uploadBtn.style.border = '2px dashed #ccc';
                uploadBtn.style.borderRadius = '8px';
                uploadBtn.style.cursor = 'pointer';
                uploadBtn.style.margin = '5px';
                uploadBtn.innerHTML = '<span style="font-size: 24px;">+</span>';
                uploadBtn.title = '‰∏ä‰º†Ë°®ÊÉÖ';
                uploadBtn.onclick = function() {
                    uploadEmoji('user');
                };
                container.appendChild(uploadBtn);
                
                // ÊòæÁ§∫Áé∞ÊúâË°®ÊÉÖ
                userEmojis.forEach(emoji => {
                    const emojiItem = document.createElement('div');
                    emojiItem.style.width = '60px';
                    emojiItem.style.height = '60px';
                    emojiItem.style.margin = '5px';
                    emojiItem.style.cursor = 'pointer';
                    emojiItem.style.borderRadius = '8px';
                    emojiItem.style.overflow = 'hidden';
                    emojiItem.title = 'ÁÇπÂáªÂèëÈÄÅ';
                    
                    const img = document.createElement('img');
                    img.src = emoji.url;
                    img.style.width = '100%';
                    img.style.height = '100%';
                    img.style.objectFit = 'cover';
                    
                    img.onclick = function() {
                        sendEmoji(emoji.url);
                        // ÂÖ≥Èó≠Èù¢Êùø
                        const panel = container.closest('div[style*="position: fixed"]');
                        if (panel) {
                            document.body.removeChild(panel);
                        }
                    };
                    
                    emojiItem.appendChild(img);
                    container.appendChild(emojiItem);
                });
                
                // ËÆæÁΩÆÂ∏ÉÂ±Ä
                container.style.display = 'flex';
                container.style.flexWrap = 'wrap';
                container.style.justifyContent = 'flex-start';
                
            } catch (error) {
                console.error("Âä†ËΩΩÁî®Êà∑Ë°®ÊÉÖÂ§±Ë¥•Ôºö", error);
            }
        }
        
        // Âä†ËΩΩËßíËâ≤Ë°®ÊÉÖ
        function loadRoleEmojis(container) {
            try {
                // Ëé∑ÂèñË¥¶Âè∑ÈÖçÁΩÆ
                const accountConfig = JSON.parse(localStorage.getItem('accountConfig') || '{}');
                const storageKey = accountConfig.loggedIn ? `roleEmojis_${accountConfig.username}` : 'roleEmojis';
                
                const roleEmojis = JSON.parse(localStorage.getItem(storageKey) || '[]');
                
                // ‰∏ä‰º†ÊåâÈíÆ
                const uploadBtn = document.createElement('div');
                uploadBtn.style.width = '60px';
                uploadBtn.style.height = '60px';
                uploadBtn.style.display = 'flex';
                uploadBtn.style.alignItems = 'center';
                uploadBtn.style.justifyContent = 'center';
                uploadBtn.style.border = '2px dashed #ccc';
                uploadBtn.style.borderRadius = '8px';
                uploadBtn.style.cursor = 'pointer';
                uploadBtn.style.margin = '5px';
                uploadBtn.innerHTML = '<span style="font-size: 24px;">+</span>';
                uploadBtn.title = '‰∏ä‰º†Ë°®ÊÉÖ';
                uploadBtn.onclick = function() {
                    uploadEmoji('role');
                };
                container.appendChild(uploadBtn);
                
                // ÊòæÁ§∫Áé∞ÊúâË°®ÊÉÖ
                roleEmojis.forEach(emoji => {
                    const emojiItem = document.createElement('div');
                    emojiItem.style.width = '60px';
                    emojiItem.style.height = '60px';
                    emojiItem.style.margin = '5px';
                    emojiItem.style.cursor = 'pointer';
                    emojiItem.style.borderRadius = '8px';
                    emojiItem.style.overflow = 'hidden';
                    emojiItem.title = 'ÁÇπÂáªÂèëÈÄÅ';
                    
                    const img = document.createElement('img');
                    img.src = emoji.url;
                    img.style.width = '100%';
                    img.style.height = '100%';
                    img.style.objectFit = 'cover';
                    
                    img.onclick = function() {
                        sendEmoji(emoji.url);
                        // ÂÖ≥Èó≠Èù¢Êùø
                        const panel = container.closest('div[style*="position: fixed"]');
                        if (panel) {
                            document.body.removeChild(panel);
                        }
                    };
                    
                    emojiItem.appendChild(img);
                    container.appendChild(emojiItem);
                });
                
                // ËÆæÁΩÆÂ∏ÉÂ±Ä
                container.style.display = 'flex';
                container.style.flexWrap = 'wrap';
                container.style.justifyContent = 'flex-start';
                
            } catch (error) {
                console.error("Âä†ËΩΩËßíËâ≤Ë°®ÊÉÖÂ§±Ë¥•Ôºö", error);
            }
        }
        
        // ‰∏ä‰º†Ë°®ÊÉÖ
        function uploadEmoji(type) {
            try {
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = 'image/*';
                fileInput.onchange = function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const emojiUrl = e.target.result;
                            
                            // ÂàõÂª∫Ë°®ÊÉÖÂåÖÂê´‰πâËæìÂÖ•ÂºπÁ™ó
                            const modal = document.createElement('div');
                            modal.style.position = 'fixed';
                            modal.style.top = '0';
                            modal.style.left = '0';
                            modal.style.width = '100%';
                            modal.style.height = '100%';
                            modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
                            modal.style.display = 'flex';
                            modal.style.alignItems = 'center';
                            modal.style.justifyContent = 'center';
                            modal.style.zIndex = '1001';
                            
                            const content = document.createElement('div');
                            content.style.backgroundColor = 'white';
                            content.style.borderRadius = '12px';
                            content.style.width = '90%';
                            content.style.maxWidth = '400px';
                            content.style.padding = '20px';
                            
                            content.innerHTML = `
                                <div style="text-align: center; margin-bottom: 20px;">
                                    <h3 style="font-size: 16px; font-weight: 500; margin-bottom: 10px;">Ê∑ªÂä†Ë°®ÊÉÖÂåÖ</h3>
                                    <div style="width: 100px; height: 100px; margin: 0 auto; border-radius: 8px; overflow: hidden; margin-bottom: 15px;">
                                        <img src="${emojiUrl}" style="width: 100%; height: 100%; object-fit: cover;">
                                    </div>
                                    <input type="text" id="emojiMeaning" placeholder="ËØ∑ËæìÂÖ•Ë°®ÊÉÖÂåÖÂê´‰πâ" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px; margin-bottom: 20px;">
                                    <div style="display: flex; gap: 10px;">
                                        <button id="cancelEmojiBtn" style="flex: 1; padding: 10px; background-color: #f0f0f0; border: none; border-radius: 8px; font-size: 14px; cursor: pointer;">ÂèñÊ∂à</button>
                                        <button id="saveEmojiBtn" style="flex: 1; padding: 10px; background-color: #ff69b4; border: none; border-radius: 8px; color: white; font-size: 14px; cursor: pointer;">‰øùÂ≠ò</button>
                                    </div>
                                </div>
                            `;
                            
                            modal.appendChild(content);
                            document.body.appendChild(modal);
                            
                            // ÂèñÊ∂àÊåâÈíÆ
                            document.getElementById('cancelEmojiBtn').onclick = function() {
                                document.body.removeChild(modal);
                            };
                            
                            // ‰øùÂ≠òÊåâÈíÆ
                            document.getElementById('saveEmojiBtn').onclick = function() {
                                const meaning = document.getElementById('emojiMeaning').value.trim();
                                const emoji = {
                                    id: Date.now().toString(),
                                    url: emojiUrl,
                                    name: file.name,
                                    type: type,
                                    meaning: meaning,
                                    createdAt: new Date().toISOString()
                                };
                                
                                // Ëé∑ÂèñË¥¶Âè∑ÈÖçÁΩÆ
                                const accountConfig = JSON.parse(localStorage.getItem('accountConfig') || '{}');
                                // ‰øùÂ≠òÂà∞localStorage
                                const baseKey = type === 'user' ? 'userEmojis' : 'roleEmojis';
                                const storageKey = accountConfig.loggedIn ? `${baseKey}_${accountConfig.username}` : baseKey;
                                const emojis = JSON.parse(localStorage.getItem(storageKey) || '[]');
                                emojis.push(emoji);
                                localStorage.setItem(storageKey, JSON.stringify(emojis));
                                
                                alert('Ë°®ÊÉÖ‰∏ä‰º†ÊàêÂäüÔºÅ');
                                document.body.removeChild(modal);
                                
                                // Âà∑Êñ∞Ë°®ÊÉÖÈù¢Êùø
                                const panel = document.querySelector('div[style*="position: fixed"]');
                                if (panel) {
                                    document.body.removeChild(panel);
                                    showEmojiPanel();
                                }
                            };
                        };
                        reader.readAsDataURL(file);
                    }
                };
                fileInput.click();
            } catch (error) {
                console.error("‰∏ä‰º†Ë°®ÊÉÖÂ§±Ë¥•Ôºö", error);
                alert('Ë°®ÊÉÖ‰∏ä‰º†Â§±Ë¥•ÔºåËØ∑ÈáçËØï');
            }
        }
        
        // ÂèëÈÄÅË°®ÊÉÖ
        function sendEmoji(emojiUrl) {
            try {
                // Ê∑ªÂä†Ë°®ÊÉÖÊ∂àÊÅØ
                const chatMessages = document.getElementById('chatMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'chat-message own';
                messageDiv.innerHTML = `
                    <div class="bubble own">
                        <img src="${emojiUrl}" style="width: 60px; height: 60px; border-radius: 8px;">
                    </div>
                    <div class="avatar">üë§</div>
                `;
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                // Ê®°ÊãüAIÂõûÂ§ç
                setTimeout(() => {
                    // Ëé∑ÂèñË¥¶Âè∑ÈÖçÁΩÆ
                    const accountConfig = JSON.parse(localStorage.getItem('accountConfig') || '{}');
                    const storageKey = accountConfig.loggedIn ? `roleEmojis_${accountConfig.username}` : 'roleEmojis';
                    
                    // Ëé∑ÂèñËßíËâ≤‰∏ìÂ±ûË°®ÊÉÖÂ∫ì
                    const roleEmojis = JSON.parse(localStorage.getItem(storageKey) || '[]');
                    
                    // ÁîüÊàêÊô∫ËÉΩÂõûÂ§ç
                    generateEmojiResponse(roleEmojis, emojiUrl);
                }, 1000);
                
            } catch (error) {
                console.error("ÂèëÈÄÅË°®ÊÉÖÂ§±Ë¥•Ôºö", error);
            }
        }
        
        // ÁîüÊàêË°®ÊÉÖÂåÖÊô∫ËÉΩÂõûÂ§ç
        function generateEmojiResponse(roleEmojis, userEmojiUrl) {
            try {
                const chatMessages = document.getElementById('chatMessages');
                
                // Ëé∑ÂèñË¥¶Âè∑ÈÖçÁΩÆ
                const accountConfig = JSON.parse(localStorage.getItem('accountConfig') || '{}');
                const storageKey = accountConfig.loggedIn ? `userEmojis_${accountConfig.username}` : 'userEmojis';
                
                // Â∞ùËØïËé∑ÂèñÁî®Êà∑ÂèëÈÄÅÁöÑË°®ÊÉÖÂåÖÂê´‰πâ
                const userEmojis = JSON.parse(localStorage.getItem(storageKey) || '[]');
                const userEmoji = userEmojis.find(emoji => emoji.url === userEmojiUrl);
                const userEmojiMeaning = userEmoji ? userEmoji.meaning : '';
                
                // Ëé∑ÂèñÊúÄËøëÁöÑÂØπËØù‰∏ä‰∏ãÊñá
                const recentMessages = [];
                const messageElements = chatMessages.querySelectorAll('.chat-message');
                for (let i = messageElements.length - 1; i >= 0 && recentMessages.length < 5; i--) {
                    const messageElement = messageElements[i];
                    const bubble = messageElement.querySelector('.bubble');
                    if (bubble) {
                        const text = bubble.textContent.trim();
                        if (text) {
                            recentMessages.unshift(text);
                        }
                    }
                }
                const context = recentMessages.join(' ');
                
                // Â¶ÇÊûúËßíËâ≤Ë°®ÊÉÖÂ∫ì‰∏ç‰∏∫Á©∫ÔºåÊ†πÊçÆ‰∏ä‰∏ãÊñáÈÄâÊã©ÂêàÈÄÇÁöÑË°®ÊÉÖÂåÖ
                if (roleEmojis.length > 0) {
                    let selectedEmoji = null;
                    
                    // 1. È¶ñÂÖàÂ∞ùËØïÊ†πÊçÆÁî®Êà∑Ë°®ÊÉÖÁöÑÂê´‰πâÂåπÈÖç
                    if (userEmojiMeaning) {
                        selectedEmoji = findMatchingEmoji(roleEmojis, userEmojiMeaning);
                    }
                    
                    // 2. Â¶ÇÊûúÊ≤°ÊúâÂåπÈÖçÂà∞ÔºåÂ∞ùËØïÊ†πÊçÆÂØπËØù‰∏ä‰∏ãÊñáÂåπÈÖç
                    if (!selectedEmoji && context) {
                        selectedEmoji = findMatchingEmoji(roleEmojis, context);
                    }
                    
                    // 3. Â¶ÇÊûú‰ªçÁÑ∂Ê≤°ÊúâÂåπÈÖçÂà∞ÔºåÈöèÊú∫ÈÄâÊã©‰∏Ä‰∏™
                    if (!selectedEmoji) {
                        selectedEmoji = roleEmojis[Math.floor(Math.random() * roleEmojis.length)];
                    }
                    
                    // ÂàõÂª∫ËßíËâ≤Ë°®ÊÉÖÂõûÂ§ç
                    const roleMessageDiv = document.createElement('div');
                    roleMessageDiv.className = 'chat-message';
                    roleMessageDiv.innerHTML = `
                        <div class="avatar">üëß</div>
                        <div class="bubble other">
                            <img src="${selectedEmoji.url}" style="width: 60px; height: 60px; border-radius: 8px;">
                        </div>
                    `;
                    chatMessages.appendChild(roleMessageDiv);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                } else {
                    // Â¶ÇÊûúËßíËâ≤Ë°®ÊÉÖÂ∫ì‰∏∫Á©∫Ôºå‰ΩøÁî®ÊñáÊú¨ÂõûÂ§ç
                    const responses = [
                        'ÂìàÂìàÔºåÊúâË∂£ÔºÅ',
                        'Êàë‰πüËøô‰πàËßâÂæóÔºÅ',
                        '‰Ω†ÁúüÂèØÁà±ÔºÅ',
                        'Ê≤°ÈîôÔºÅ',
                        'ÂêåÊÑèÔºÅ',
                        'Â§™Ê£í‰∫ÜÔºÅ',
                        'Â•ΩÁöÑÔºÅ',
                        'ÊòéÁôΩ‰∫ÜÔºÅ'
                    ];
                    
                    const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                    const roleMessageDiv = document.createElement('div');
                    roleMessageDiv.className = 'chat-message';
                    roleMessageDiv.innerHTML = `
                        <div class="avatar">üëß</div>
                        <div class="bubble other">${randomResponse}</div>
                    `;
                    chatMessages.appendChild(roleMessageDiv);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
                
            } catch (error) {
                console.error("ÁîüÊàêË°®ÊÉÖÂõûÂ§çÂ§±Ë¥•Ôºö", error);
                // Â§±Ë¥•Êó∂‰ΩøÁî®ÈªòËÆ§ÂõûÂ§ç
                const chatMessages = document.getElementById('chatMessages');
                const roleMessageDiv = document.createElement('div');
                roleMessageDiv.className = 'chat-message';
                roleMessageDiv.innerHTML = `
                    <div class="avatar">üëß</div>
                    <div class="bubble other">ÂìàÂìàÔºÅ</div>
                `;
                chatMessages.appendChild(roleMessageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }
        
        // Ê†πÊçÆÊñáÊú¨ÂÜÖÂÆπÂåπÈÖçÂêàÈÄÇÁöÑË°®ÊÉÖÂåÖ
        function findMatchingEmoji(emojis, text) {
            // ÁÆÄÂçïÁöÑÂÖ≥ÈîÆËØçÂåπÈÖç
            const keywordMap = {
                'ÂºÄÂøÉ': ['happy', 'joy', 'laugh', 'smile', 'ÂºÄÂøÉ', 'Âø´‰πê', 'È´òÂÖ¥', 'ÂìàÂìà'],
                '‰º§ÂøÉ': ['sad', 'cry', 'ÈöæËøá', '‰º§ÂøÉ', 'Âì≠'],
                'ÁîüÊ∞î': ['angry', 'mad', 'ÁîüÊ∞î', 'ÊÑ§ÊÄí'],
                'ÊÉäËÆ∂': ['surprised', 'shock', 'ÊÉäËÆ∂', 'ÈúáÊÉä'],
                'Áà±ÂøÉ': ['love', 'heart', 'Áà±ÂøÉ', 'ÂñúÊ¨¢'],
                'ÊÑüË∞¢': ['thank', 'thanks', 'ÊÑüË∞¢', 'Ë∞¢Ë∞¢'],
                'ÂêåÊÑè': ['agree', 'yes', 'ok', 'Â•ΩÁöÑ', 'ÂêåÊÑè', 'ÊòØÁöÑ'],
                'ÊãíÁªù': ['no', 'ÊãíÁªù', '‰∏çË¶Å', '‰∏çË°å']
            };
            
            // ËÆ°ÁÆóÊØè‰∏™Ë°®ÊÉÖÁöÑÂåπÈÖçÂàÜÊï∞
            let bestMatch = null;
            let highestScore = 0;
            
            emojis.forEach(emoji => {
                let score = 0;
                const emojiMeaning = emoji.meaning || '';
                
                // Ê£ÄÊü•Ë°®ÊÉÖÂåÖÂê´‰πâ‰∏éÊñáÊú¨ÁöÑÂåπÈÖçÂ∫¶
                for (const [emotion, keywords] of Object.entries(keywordMap)) {
                    for (const keyword of keywords) {
                        if (text.includes(keyword) || emojiMeaning.includes(keyword)) {
                            score += 1;
                        }
                    }
                }
                
                // Â¶ÇÊûúÂàÜÊï∞Êõ¥È´òÔºåÊõ¥Êñ∞ÊúÄ‰Ω≥ÂåπÈÖç
                if (score > highestScore) {
                    highestScore = score;
                    bestMatch = emoji;
                }
            });
            
            return bestMatch;
        }
        
        function selectImage() {
            try {
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = 'image/*';
                fileInput.onchange = function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const imageUrl = e.target.result;
                            sendImage(imageUrl, file.name);
                        };
                        reader.readAsDataURL(file);
                    }
                };
                fileInput.click();
            } catch (error) {
                console.error("ÈÄâÊã©ÂõæÁâáÂ§±Ë¥•Ôºö", error);
                alert('ÂõæÁâáÈÄâÊã©Â§±Ë¥•ÔºåËØ∑ÈáçËØï');
            }
        }
        
        // ÂèëÈÄÅÂõæÁâá
        function sendImage(imageUrl, fileName) {
            try {
                // Ê∑ªÂä†ÂõæÁâáÊ∂àÊÅØ
                const chatMessages = document.getElementById('chatMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'chat-message own';
                messageDiv.innerHTML = `
                    <div class="bubble own" style="max-width: 70%;">
                        <img src="${imageUrl}" style="max-width: 100%; max-height: 300px; border-radius: 8px; object-fit: cover;">
                        <div style="font-size: 12px; color: rgba(255,255,255,0.7); margin-top: 4px;">${fileName}</div>
                    </div>
                    <div class="avatar">üë§</div>
                `;
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                // Â∞ùËØïËøõË°åÂõæÁâáËØÜÂà´
                recognizeImage(imageUrl);
                
            } catch (error) {
                console.error("ÂèëÈÄÅÂõæÁâáÂ§±Ë¥•Ôºö", error);
            }
        }
        
        // ËØÜÂà´ÂõæÁâá
        async function recognizeImage(imageUrl) {
            try {
                // Ëé∑ÂèñËØÜÂõæAPIÈÖçÁΩÆ
                const imageRecognitionConfig = JSON.parse(localStorage.getItem('imageRecognitionConfig') || '{}');
                const apiKey = imageRecognitionConfig.apiKey;
                const apiUrl = imageRecognitionConfig.apiUrl || 'https://api.openai.com/v1/chat/completions';
                const model = imageRecognitionConfig.model || 'gpt-4-vision-preview';
                
                if (!apiKey) {
                    // Â¶ÇÊûúÊ≤°ÊúâÈÖçÁΩÆAPIÔºå‰ΩøÁî®Ê®°ÊãüÂõûÂ§ç
                    setTimeout(() => {
                        sendImageRecognitionReply('ËøôÊòØ‰∏ÄÂº†ÂõæÁâá');
                    }, 1000);
                    return;
                }
                
                // Ë∞ÉÁî®ËØÜÂõæAPI
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: [
                            {
                                role: 'user',
                                content: [
                                    {
                                        type: 'text',
                                        text: 'ËØ∑ÊèèËø∞ËøôÂº†ÂõæÁâáÁöÑÂÜÖÂÆπ'
                                    },
                                    {
                                        type: 'image_url',
                                        image_url: {
                                            url: imageUrl
                                        }
                                    }
                                ]
                            }
                        ],
                        max_tokens: 300
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                const description = data.choices[0].message.content;
                sendImageRecognitionReply(description);
                
            } catch (error) {
                console.error("ÂõæÁâáËØÜÂà´Â§±Ë¥•Ôºö", error);
                // Â§±Ë¥•Êó∂‰ΩøÁî®Ê®°ÊãüÂõûÂ§ç
                sendImageRecognitionReply('ËøôÊòØ‰∏ÄÂº†ÂõæÁâá');
            }
        }
        
        // ÂèëÈÄÅÂõæÁâáËØÜÂà´ÂõûÂ§ç
        function sendImageRecognitionReply(description) {
            try {
                const chatMessages = document.getElementById('chatMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'chat-message';
                messageDiv.innerHTML = `
                    <div class="avatar">üëß</div>
                    <div class="bubble other">
                        <div>${description}</div>
                    </div>
                `;
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            } catch (error) {
                console.error("ÂèëÈÄÅÂõæÁâáËØÜÂà´ÂõûÂ§çÂ§±Ë¥•Ôºö", error);
            }
        }
        
        // ËØ≠Èü≥APIÈÖçÁΩÆ
        function showVoiceSettings() {
            try {
                // Ëé∑ÂèñÂΩìÂâçËØ≠Èü≥ÈÖçÁΩÆ
                const voiceConfig = JSON.parse(localStorage.getItem('voiceConfig') || '{}');
                
                const html = `
                    <div style="padding: 20px;">
                        <h3 style="font-size: 16px; font-weight: 500; margin-bottom: 16px;">ËØ≠Èü≥ËÆæÁΩÆ</h3>
                        
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-size: 14px; color: #999; margin-bottom: 4px;">ËØ≠Èü≥ËØÜÂà´API</label>
                            <select id="speechRecognitionApi" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px; background-color: white;">
                                <option value="web-speech-api" ${voiceConfig.speechRecognitionApi === 'web-speech-api' ? 'selected' : ''}>Web Speech API</option>
                                <option value="custom" ${voiceConfig.speechRecognitionApi === 'custom' ? 'selected' : ''}>Ëá™ÂÆö‰πâAPI</option>
                            </select>
                        </div>
                        
                        <div id="customRecognitionApiItem" style="margin-bottom: 16px; ${voiceConfig.speechRecognitionApi === 'custom' ? 'display: block;' : 'display: none;'}">
                            <label style="display: block; font-size: 14px; color: #999; margin-bottom: 4px;">Ëá™ÂÆö‰πâAPIÂú∞ÂùÄ</label>
                            <input type="text" id="customRecognitionApiUrl" value="${voiceConfig.customRecognitionApiUrl || ''}" placeholder="https://api.example.com/speech-to-text" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                        </div>
                        
                        <div id="customRecognitionApiKeyItem" style="margin-bottom: 16px; ${voiceConfig.speechRecognitionApi === 'custom' ? 'display: block;' : 'display: none;'}">
                            <label style="display: block; font-size: 14px; color: #999; margin-bottom: 4px;">APIÂØÜÈí•</label>
                            <input type="password" id="customRecognitionApiKey" value="${voiceConfig.customRecognitionApiKey || ''}" placeholder="ËæìÂÖ•APIÂØÜÈí•" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                        </div>
                        
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-size: 14px; color: #999; margin-bottom: 4px;">ËØ≠Èü≥ÂêàÊàêAPI</label>
                            <select id="speechSynthesisApi" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px; background-color: white;">
                                <option value="web-speech-api" ${voiceConfig.speechSynthesisApi === 'web-speech-api' ? 'selected' : ''}>Web Speech API</option>
                                <option value="custom" ${voiceConfig.speechSynthesisApi === 'custom' ? 'selected' : ''}>Ëá™ÂÆö‰πâAPI</option>
                            </select>
                        </div>
                        
                        <div id="customSynthesisApiItem" style="margin-bottom: 16px; ${voiceConfig.speechSynthesisApi === 'custom' ? 'display: block;' : 'display: none;'}">
                            <label style="display: block; font-size: 14px; color: #999; margin-bottom: 4px;">Ëá™ÂÆö‰πâAPIÂú∞ÂùÄ</label>
                            <input type="text" id="customSynthesisApiUrl" value="${voiceConfig.customSynthesisApiUrl || ''}" placeholder="https://api.example.com/text-to-speech" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                        </div>
                        
                        <div id="customSynthesisApiKeyItem" style="margin-bottom: 16px; ${voiceConfig.speechSynthesisApi === 'custom' ? 'display: block;' : 'display: none;'}">
                            <label style="display: block; font-size: 14px; color: #999; margin-bottom: 4px;">APIÂØÜÈí•</label>
                            <input type="password" id="customSynthesisApiKey" value="${voiceConfig.customSynthesisApiKey || ''}" placeholder="ËæìÂÖ•APIÂØÜÈí•" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                        </div>
                        
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-size: 14px; color: #999; margin-bottom: 4px;">ËØ≠Èü≥ËØÜÂà´ËØ≠Ë®Ä</label>
                            <select id="recognitionLanguage" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px; background-color: white;">
                                <option value="zh-CN" ${voiceConfig.recognitionLanguage === 'zh-CN' ? 'selected' : ''}>‰∏≠Êñá (zh-CN)</option>
                                <option value="en-US" ${voiceConfig.recognitionLanguage === 'en-US' ? 'selected' : ''}>Ëã±Êñá (en-US)</option>
                            </select>
                        </div>
                        
                        <button id="saveVoiceConfigBtn" style="width: 100%; padding: 12px; background-color: #ff69b4; border: none; border-radius: 8px; color: white; font-size: 16px; cursor: pointer;">‰øùÂ≠òËÆæÁΩÆ</button>
                    </div>
                `;
                
                // ÂàõÂª∫ÂºπÁ™ó
                const modal = document.createElement('div');
                modal.style.position = 'fixed';
                modal.style.top = '0';
                modal.style.left = '0';
                modal.style.width = '100%';
                modal.style.height = '100%';
                modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
                modal.style.display = 'flex';
                modal.style.alignItems = 'center';
                modal.style.justifyContent = 'center';
                modal.style.zIndex = '1000';
                
                const content = document.createElement('div');
                content.style.backgroundColor = 'white';
                content.style.borderRadius = '12px';
                content.style.width = '90%';
                content.style.maxWidth = '400px';
                content.style.maxHeight = '80%';
                content.style.overflowY = 'auto';
                content.innerHTML = html;
                
                modal.appendChild(content);
                document.body.appendChild(modal);
                
                // Ê∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨
                document.getElementById('speechRecognitionApi').addEventListener('change', function() {
                    const customItem = document.getElementById('customRecognitionApiItem');
                    const customKeyItem = document.getElementById('customRecognitionApiKeyItem');
                    if (this.value === 'custom') {
                        customItem.style.display = 'block';
                        customKeyItem.style.display = 'block';
                    } else {
                        customItem.style.display = 'none';
                        customKeyItem.style.display = 'none';
                    }
                });
                
                document.getElementById('speechSynthesisApi').addEventListener('change', function() {
                    const customItem = document.getElementById('customSynthesisApiItem');
                    const customKeyItem = document.getElementById('customSynthesisApiKeyItem');
                    if (this.value === 'custom') {
                        customItem.style.display = 'block';
                        customKeyItem.style.display = 'block';
                    } else {
                        customItem.style.display = 'none';
                        customKeyItem.style.display = 'none';
                    }
                });
                
                document.getElementById('saveVoiceConfigBtn').addEventListener('click', function() {
                    const config = {
                        speechRecognitionApi: document.getElementById('speechRecognitionApi').value,
                        customRecognitionApiUrl: document.getElementById('customRecognitionApiUrl').value,
                        customRecognitionApiKey: document.getElementById('customRecognitionApiKey').value,
                        speechSynthesisApi: document.getElementById('speechSynthesisApi').value,
                        customSynthesisApiUrl: document.getElementById('customSynthesisApiUrl').value,
                        customSynthesisApiKey: document.getElementById('customSynthesisApiKey').value,
                        recognitionLanguage: document.getElementById('recognitionLanguage').value
                    };
                    localStorage.setItem('voiceConfig', JSON.stringify(config));
                    alert('ËØ≠Èü≥ËÆæÁΩÆÂ∑≤‰øùÂ≠òÔºÅ');
                    document.body.removeChild(modal);
                });
                
                // Ê∑ªÂä†ÂÖ≥Èó≠ÂäüËÉΩ
                modal.onclick = function(e) {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                    }
                };
                
            } catch (error) {
                console.error("ÊòæÁ§∫ËØ≠Èü≥ËÆæÁΩÆÂ§±Ë¥•Ôºö", error);
                alert('ËØ≠Èü≥ËÆæÁΩÆÂäüËÉΩÂä†ËΩΩÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
            }
        }
        
        // ËØ≠Èü≥ËØÜÂà´ÂäüËÉΩ
        function startSpeechRecognition() {
            try {
                // Ëé∑ÂèñËØ≠Èü≥ÈÖçÁΩÆ
                const voiceConfig = JSON.parse(localStorage.getItem('voiceConfig') || '{}');
                const language = voiceConfig.recognitionLanguage || 'zh-CN';
                
                // Ê£ÄÊü•ÊµèËßàÂô®ÊòØÂê¶ÊîØÊåÅWeb Speech API
                if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    const recognition = new SpeechRecognition();
                    
                    recognition.lang = language;
                    recognition.continuous = false;
                    recognition.interimResults = false;
                    
                    recognition.onstart = function() {
                        console.log('ËØ≠Èü≥ËØÜÂà´Â∑≤ÂºÄÂßã');
                    };
                    
                    recognition.onresult = function(event) {
                        const transcript = event.results[0][0].transcript;
                        console.log('ËØÜÂà´ÁªìÊûú:', transcript);
                        // ËøôÈáåÂèØ‰ª•Â§ÑÁêÜËØÜÂà´ÁªìÊûúÔºåÊØîÂ¶ÇÂèëÈÄÅÊ∂àÊÅØ
                        if (transcript) {
                            const chatInput = document.getElementById('chatInput');
                            chatInput.value = transcript;
                            // Ëá™Âä®ÂèëÈÄÅÊ∂àÊÅØ
                            sendChatMessage();
                        }
                    };
                    
                    recognition.onerror = function(event) {
                        console.error('ËØ≠Èü≥ËØÜÂà´ÈîôËØØ:', event.error);
                        alert('ËØ≠Èü≥ËØÜÂà´Â§±Ë¥•ÔºåËØ∑ÈáçËØï');
                    };
                    
                    recognition.onend = function() {
                        console.log('ËØ≠Èü≥ËØÜÂà´Â∑≤ÁªìÊùü');
                    };
                    
                    recognition.start();
                } else {
                    alert('ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅËØ≠Èü≥ËØÜÂà´ÂäüËÉΩ');
                }
                
            } catch (error) {
                console.error("ÂºÄÂßãËØ≠Èü≥ËØÜÂà´Â§±Ë¥•Ôºö", error);
                alert('ËØ≠Èü≥ËØÜÂà´ÂäüËÉΩÊöÇÊó∂‰∏çÂèØÁî®ÔºåËØ∑ÈáçËØï');
            }
        }
        
        // ËØ≠Èü≥ÂêàÊàêÂäüËÉΩ
        function speak(text) {
            try {
                // Ëé∑ÂèñËØ≠Èü≥ÈÖçÁΩÆ
                const voiceConfig = JSON.parse(localStorage.getItem('voiceConfig') || '{}');
                
                // Ê£ÄÊü•Ê∂àÊÅØÊúóËØªÊòØÂê¶ÂêØÁî®
                if (voiceConfig.speechEnabled === false) {
                    return;
                }
                
                // Ê£ÄÊü•ÊµèËßàÂô®ÊòØÂê¶ÊîØÊåÅWeb Speech API
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = voiceConfig.recognitionLanguage || 'zh-CN';
                    utterance.rate = 1;
                    utterance.pitch = 1;
                    utterance.volume = 1;
                    
                    speechSynthesis.speak(utterance);
                } else {
                    console.log('ÊµèËßàÂô®‰∏çÊîØÊåÅËØ≠Èü≥ÂêàÊàêÂäüËÉΩ');
                }
                
            } catch (error) {
                console.error("ËØ≠Èü≥ÂêàÊàêÂ§±Ë¥•Ôºö", error);
            }
        }
        
        function makeCall() {
            try {
                // ÂàõÂª∫ÈÄöËØùÁïåÈù¢
                const callPanel = document.createElement('div');
                callPanel.style.position = 'fixed';
                callPanel.style.top = '0';
                callPanel.style.left = '0';
                callPanel.style.width = '100%';
                callPanel.style.height = '100%';
                callPanel.style.backgroundColor = '#f5f5f5';
                callPanel.style.display = 'flex';
                callPanel.style.flexDirection = 'column';
                callPanel.style.alignItems = 'center';
                callPanel.style.justifyContent = 'space-between';
                callPanel.style.padding = '40px 20px';
                callPanel.style.zIndex = '1000';
                
                // ÈÄöËØù‰ø°ÊÅØÂå∫Âüü
                const callInfo = document.createElement('div');
                callInfo.style.display = 'flex';
                callInfo.style.flexDirection = 'column';
                callInfo.style.alignItems = 'center';
                callInfo.style.marginTop = '100px';
                
                // Â§¥ÂÉè
                const avatar = document.createElement('div');
                avatar.style.width = '120px';
                avatar.style.height = '120px';
                avatar.style.borderRadius = '50%';
                avatar.style.backgroundColor = '#ff69b4';
                avatar.style.display = 'flex';
                avatar.style.alignItems = 'center';
                avatar.style.justifyContent = 'center';
                avatar.style.fontSize = '48px';
                avatar.textContent = 'üëß';
                avatar.style.marginBottom = '20px';
                
                // ÂßìÂêç
                const name = document.createElement('div');
                name.style.fontSize = '24px';
                name.style.fontWeight = '500';
                name.textContent = currentChatRole ? currentChatRole.nickname : 'AIÂä©Êâã';
                name.style.marginBottom = '10px';
                
                // ÈÄöËØùÁä∂ÊÄÅ
                const status = document.createElement('div');
                status.style.fontSize = '14px';
                status.style.color = '#666';
                status.textContent = 'Ê≠£Âú®ÈÄöËØù‰∏≠...';
                
                // ÈÄöËØùÊó∂Èïø
                const duration = document.createElement('div');
                duration.id = 'callDuration';
                duration.style.fontSize = '16px';
                duration.style.marginTop = '20px';
                duration.textContent = '00:00';
                
                callInfo.appendChild(avatar);
                callInfo.appendChild(name);
                callInfo.appendChild(status);
                callInfo.appendChild(duration);
                
                // ÊéßÂà∂ÊåâÈíÆÂå∫Âüü
                const controls = document.createElement('div');
                controls.style.display = 'flex';
                controls.style.gap = '20px';
                controls.style.marginBottom = '100px';
                
                // ÈùôÈü≥ÊåâÈíÆ
                const muteBtn = document.createElement('button');
                muteBtn.style.width = '60px';
                muteBtn.style.height = '60px';
                muteBtn.style.borderRadius = '50%';
                muteBtn.style.border = 'none';
                muteBtn.style.backgroundColor = 'white';
                muteBtn.style.boxShadow = '0 2px 10px rgba(0,0,0,0.1)';
                muteBtn.style.display = 'flex';
                muteBtn.style.alignItems = 'center';
                muteBtn.style.justifyContent = 'center';
                muteBtn.style.fontSize = '24px';
                muteBtn.textContent = 'üîá';
                muteBtn.title = 'ÈùôÈü≥';
                
                let isMuted = false;
                muteBtn.onclick = function() {
                    isMuted = !isMuted;
                    muteBtn.textContent = isMuted ? 'üîä' : 'üîá';
                    muteBtn.title = isMuted ? 'ÂèñÊ∂àÈùôÈü≥' : 'ÈùôÈü≥';
                };
                
                // Êâ¨Â£∞Âô®ÊåâÈíÆ
                const speakerBtn = document.createElement('button');
                speakerBtn.style.width = '60px';
                speakerBtn.style.height = '60px';
                speakerBtn.style.borderRadius = '50%';
                speakerBtn.style.border = 'none';
                speakerBtn.style.backgroundColor = 'white';
                speakerBtn.style.boxShadow = '0 2px 10px rgba(0,0,0,0.1)';
                speakerBtn.style.display = 'flex';
                speakerBtn.style.alignItems = 'center';
                speakerBtn.style.justifyContent = 'center';
                speakerBtn.style.fontSize = '24px';
                speakerBtn.textContent = 'üîä';
                speakerBtn.title = 'Êâ¨Â£∞Âô®';
                
                // ËØ≠Èü≥ËØÜÂà´ÊåâÈíÆ
                const voiceBtn = document.createElement('button');
                voiceBtn.style.width = '60px';
                voiceBtn.style.height = '60px';
                voiceBtn.style.borderRadius = '50%';
                voiceBtn.style.border = 'none';
                voiceBtn.style.backgroundColor = 'white';
                voiceBtn.style.boxShadow = '0 2px 10px rgba(0,0,0,0.1)';
                voiceBtn.style.display = 'flex';
                voiceBtn.style.alignItems = 'center';
                voiceBtn.style.justifyContent = 'center';
                voiceBtn.style.fontSize = '24px';
                voiceBtn.textContent = 'üé§';
                voiceBtn.title = 'ËØ≠Èü≥ËæìÂÖ•';
                voiceBtn.onclick = function() {
                    startSpeechRecognition();
                };
                
                // ÁªìÊùüÈÄöËØùÊåâÈíÆ
                const endBtn = document.createElement('button');
                endBtn.style.width = '70px';
                endBtn.style.height = '70px';
                endBtn.style.borderRadius = '50%';
                endBtn.style.border = 'none';
                endBtn.style.backgroundColor = '#ff3b30';
                endBtn.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
                endBtn.style.display = 'flex';
                endBtn.style.alignItems = 'center';
                endBtn.style.justifyContent = 'center';
                endBtn.style.fontSize = '24px';
                endBtn.textContent = 'üî¥';
                endBtn.title = 'ÁªìÊùüÈÄöËØù';
                
                endBtn.onclick = function() {
                    // ÂÅúÊ≠¢ËÆ°Êó∂Âô®
                    clearInterval(timer);
                    // ÂÅúÊ≠¢Èü≥È¢ëÂΩïÂà∂
                    if (mediaRecorder) {
                        mediaRecorder.stop();
                    }
                    // ÂÅúÊ≠¢ËØ≠Èü≥ÂêàÊàê
                    if ('speechSynthesis' in window) {
                        speechSynthesis.cancel();
                    }
                    // ÁßªÈô§ÈÄöËØùÈù¢Êùø
                    document.body.removeChild(callPanel);
                    // ÊòæÁ§∫ÈÄöËØùÁªìÊùüÊèêÁ§∫
                    alert('ÈÄöËØùÂ∑≤ÁªìÊùü');
                };
                
                controls.appendChild(muteBtn);
                controls.appendChild(voiceBtn);
                controls.appendChild(endBtn);
                controls.appendChild(speakerBtn);
                
                // ÂºÄÂßãÈÄöËØùËÆ°Êó∂Âô®
                let seconds = 0;
                const timer = setInterval(function() {
                    seconds++;
                    const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
                    const secs = (seconds % 60).toString().padStart(2, '0');
                    document.getElementById('callDuration').textContent = `${mins}:${secs}`;
                }, 1000);
                
                // Â∞ùËØï‰ΩøÁî®Web Audio APIËøõË°åËØ≠Èü≥ÂΩïÂà∂
                let mediaRecorder;
                let audioChunks = [];
                
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(stream => {
                        mediaRecorder = new MediaRecorder(stream);
                        
                        mediaRecorder.ondataavailable = function(e) {
                            if (e.data.size > 0) {
                                audioChunks.push(e.data);
                            }
                        };
                        
                        mediaRecorder.onstop = function() {
                            const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                            const audioUrl = URL.createObjectURL(audioBlob);
                            // ËøôÈáåÂèØ‰ª•‰øùÂ≠òÂΩïÈü≥ÊàñËøõË°åÂÖ∂‰ªñÂ§ÑÁêÜ
                            console.log('ÂΩïÈü≥Â∑≤‰øùÂ≠ò:', audioUrl);
                        };
                        
                        // ÂºÄÂßãÂΩïÂà∂
                        mediaRecorder.start();
                    })
                    .catch(error => {
                        console.error('Êó†Ê≥ïËÆøÈóÆÈ∫¶ÂÖãÈ£é:', error);
                        alert('Êó†Ê≥ïËÆøÈóÆÈ∫¶ÂÖãÈ£éÔºåÈÄöËØùÂäüËÉΩÂèØËÉΩÂèóÈôê');
                    });
                
                callPanel.appendChild(callInfo);
                callPanel.appendChild(controls);
                document.body.appendChild(callPanel);
                
                // Ëá™Âä®Êí≠ÊîæÊ¨¢ËøéËØ≠
                setTimeout(() => {
                    speak('‰Ω†Â•ΩÔºÅÊàëÊòØ‰Ω†ÁöÑAIÂä©ÊâãÔºåÊúâ‰ªÄ‰πàÂèØ‰ª•Â∏Æ‰Ω†ÁöÑÂêóÔºü');
                }, 1000);
                
            } catch (error) {
                console.error("ÂèëËµ∑ÈÄöËØùÂ§±Ë¥•Ôºö", error);
                alert('ÈÄöËØùÂäüËÉΩÊöÇÊó∂‰∏çÂèØÁî®ÔºåËØ∑ÈáçËØï');
            }
        }
        
        function showTransferModal() {
            alert('ËΩ¨Ë¥¶ÂäüËÉΩÂºÄÂèë‰∏≠');
        }
        
        function showMemoryModal() {
            alert('ËÆ∞ÂøÜÂäüËÉΩÂºÄÂèë‰∏≠');
        }
        
        function showStoryModal() {
            alert('ÊïÖ‰∫ãÂäüËÉΩÂºÄÂèë‰∏≠');
        }
        
        function showActionLineModal() {
            alert('Ë°åÂä®Á∫øÂäüËÉΩÂºÄÂèë‰∏≠');
        }
        
        function showTravelModal() {
            alert('ÊóÖÊ∏∏ÂäüËÉΩÂºÄÂèë‰∏≠');
        }
        
        // ËÆæÁΩÆÈ°µÈù¢ÁÇπÂáª‰∫ã‰ª∂
        function showVoiceSettings() {
            try {
                const voiceTypes = ['default', 'cute', 'mature', 'professional', 'friendly'];
                const selectedType = wechatSettings.voice.type || 'default';
                
                let html = `
                    <div style="padding: 20px;">
                        <h3 style="font-size: 16px; font-weight: 500; margin-bottom: 16px;">Ëá™ÂÆö‰πâÈü≥Ëâ≤</h3>
                `;
                
                voiceTypes.forEach(type => {
                    html += `
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; border-bottom: 1px solid #e0e0e0;">
                            <div style="font-size: 14px;">${getVoiceTypeName(type)}</div>
                            <div style="width: 20px; height: 20px; border: 2px solid #e0e0e0; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                ${selectedType === type ? '<div style="width: 12px; height: 12px; border-radius: 50%; background-color: #ff69b4;"></div>' : ''}
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        <button style="margin-top: 20px; width: 100%; padding: 12px; background-color: #ff69b4; border: none; border-radius: 8px; color: white; font-size: 16px;">‰øùÂ≠ò</button>
                    </div>
                `;
                
                // ÂàõÂª∫ÂºπÁ™ó
                const modal = document.createElement('div');
                modal.style.position = 'fixed';
                modal.style.top = '0';
                modal.style.left = '0';
                modal.style.width = '100%';
                modal.style.height = '100%';
                modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
                modal.style.display = 'flex';
                modal.style.alignItems = 'center';
                modal.style.justifyContent = 'center';
                modal.style.zIndex = '1000';
                
                const content = document.createElement('div');
                content.style.backgroundColor = 'white';
                content.style.borderRadius = '12px';
                content.style.width = '90%';
                content.style.maxWidth = '400px';
                content.style.maxHeight = '80%';
                content.style.overflowY = 'auto';
                content.innerHTML = html;
                
                modal.appendChild(content);
                document.body.appendChild(modal);
                
                // Ê∑ªÂä†ÂÖ≥Èó≠ÂäüËÉΩ
                modal.onclick = function(e) {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                    }
                };
            } catch (error) {
                console.error("ÊòæÁ§∫Èü≥Ëâ≤ËÆæÁΩÆÂ§±Ë¥•Ôºö", error);
            }
        }
        
        function getVoiceTypeName(type) {
            const types = {
                default: 'ÈªòËÆ§Èü≥Ëâ≤',
                cute: 'ÂèØÁà±Èü≥Ëâ≤',
                mature: 'ÊàêÁÜüÈü≥Ëâ≤',
                professional: '‰∏ì‰∏öÈü≥Ëâ≤',
                friendly: 'ÂèãÂ•ΩÈü≥Ëâ≤'
            };
            return types[type] || type;
        }
        
        function showActiveTalkSettings() {
            try {
                const enabled = wechatSettings.activeTalk?.enabled || true;
                const frequency = wechatSettings.activeTalk?.frequency || 'medium';
                
                const html = `
                    <div style="padding: 20px;">
                        <h3 style="font-size: 16px; font-weight: 500; margin-bottom: 16px;">‰∏ªÂä®ÂèëË®ÄËÆæÁΩÆ</h3>
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; border-bottom: 1px solid #e0e0e0;">
                            <div style="font-size: 14px;">ÂêØÁî®‰∏ªÂä®ÂèëË®Ä</div>
                            <label style="position: relative; display: inline-block; width: 50px; height: 24px;">
                                <input type="checkbox" id="activeTalkEnabled" ${enabled ? 'checked' : ''} style="opacity: 0; width: 0; height: 0;">
                                <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px;"></span>
                                <span style="position: absolute; cursor: pointer; top: 2px; left: 2px; bottom: 2px; width: 20px; background-color: white; transition: .4s; border-radius: 50%;"></span>
                            </label>
                        </div>
                        <div style="margin-top: 16px;">
                            <div style="font-size: 14px; margin-bottom: 12px;">ÂèëË®ÄÈ¢ëÁéá</div>
                            <div style="display: flex; justify-content: space-between;">
                                <button id="freqLow" style="padding: 8px 16px; border: 1px solid #e0e0e0; border-radius: 16px; background-color: ${frequency === 'low' ? '#ff69b4' : 'white'}; color: ${frequency === 'low' ? 'white' : '#333'}; font-size: 14px;">‰Ωé</button>
                                <button id="freqMedium" style="padding: 8px 16px; border: 1px solid #e0e0e0; border-radius: 16px; background-color: ${frequency === 'medium' ? '#ff69b4' : 'white'}; color: ${frequency === 'medium' ? 'white' : '#333'}; font-size: 14px;">‰∏≠</button>
                                <button id="freqHigh" style="padding: 8px 16px; border: 1px solid #e0e0e0; border-radius: 16px; background-color: ${frequency === 'high' ? '#ff69b4' : 'white'}; color: ${frequency === 'high' ? 'white' : '#333'}; font-size: 14px;">È´ò</button>
                            </div>
                        </div>
                        <button onclick="saveActiveTalkSettings()" style="margin-top: 20px; width: 100%; padding: 12px; background-color: #ff69b4; border: none; border-radius: 8px; color: white; font-size: 16px;">‰øùÂ≠ò</button>
                    </div>
                `;
                
                // ÂàõÂª∫ÂºπÁ™ó
                const modal = document.createElement('div');
                modal.style.position = 'fixed';
                modal.style.top = '0';
                modal.style.left = '0';
                modal.style.width = '100%';
                modal.style.height = '100%';
                modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
                modal.style.display = 'flex';
                modal.style.alignItems = 'center';
                modal.style.justifyContent = 'center';
                modal.style.zIndex = '1000';
                
                const content = document.createElement('div');
                content.style.backgroundColor = 'white';
                content.style.borderRadius = '12px';
                content.style.width = '90%';
                content.style.maxWidth = '400px';
                content.innerHTML = html;
                
                modal.appendChild(content);
                document.body.appendChild(modal);
                
                // Ê∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨
                document.getElementById('freqLow').onclick = function() {
                    setFrequency('low');
                };
                document.getElementById('freqMedium').onclick = function() {
                    setFrequency('medium');
                };
                document.getElementById('freqHigh').onclick = function() {
                    setFrequency('high');
                };
                
                function setFrequency(freq) {
                    const buttons = ['freqLow', 'freqMedium', 'freqHigh'];
                    buttons.forEach(id => {
                        const btn = document.getElementById(id);
                        if (id === 'freq' + freq.charAt(0).toUpperCase() + freq.slice(1)) {
                            btn.style.backgroundColor = '#ff69b4';
                            btn.style.color = 'white';
                        } else {
                            btn.style.backgroundColor = 'white';
                            btn.style.color = '#333';
                        }
                    });
                    wechatSettings.activeTalk.frequency = freq;
                }
                
                // Ê∑ªÂä†ÂÖ≥Èó≠ÂäüËÉΩ
                modal.onclick = function(e) {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                    }
                };
            } catch (error) {
                console.error("ÊòæÁ§∫‰∏ªÂä®ÂèëË®ÄËÆæÁΩÆÂ§±Ë¥•Ôºö", error);
            }
        }
        
        function saveActiveTalkSettings() {
            try {
                const enabled = document.getElementById('activeTalkEnabled').checked;
                wechatSettings.activeTalk = {
                    enabled: enabled,
                    frequency: wechatSettings.activeTalk?.frequency || 'medium'
                };
                saveWechatSettings();
                alert('ËÆæÁΩÆÂ∑≤‰øùÂ≠ò');
                // ÂÖ≥Èó≠ÂºπÁ™ó
                const modal = document.querySelector('div[style*="position: fixed"]');
                if (modal) {
                    document.body.removeChild(modal);
                }
            } catch (error) {
                console.error("‰øùÂ≠ò‰∏ªÂä®ÂèëË®ÄËÆæÁΩÆÂ§±Ë¥•Ôºö", error);
                alert('‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
            }
        }
        
        function showThemeSettings() {
            try {
                const currentTheme = wechatSettings.theme || 'light';
                
                const html = `
                    <div style="padding: 20px;">
                        <h3 style="font-size: 16px; font-weight: 500; margin-bottom: 16px;">‰∏ªÈ¢òÊ®°Âºè</h3>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px;">
                                <div style="font-size: 14px;">ÊµÖËâ≤Ê®°Âºè</div>
                                <div style="width: 20px; height: 20px; border: 2px solid #e0e0e0; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                    ${currentTheme === 'light' ? '<div style="width: 12px; height: 12px; border-radius: 50%; background-color: #ff69b4;"></div>' : ''}
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px;">
                                <div style="font-size: 14px;">Ê∑±Ëâ≤Ê®°Âºè</div>
                                <div style="width: 20px; height: 20px; border: 2px solid #e0e0e0; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                    ${currentTheme === 'dark' ? '<div style="width: 12px; height: 12px; border-radius: 50%; background-color: #ff69b4;"></div>' : ''}
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px;">
                                <div style="font-size: 14px;">Ë∑üÈöèÁ≥ªÁªü</div>
                                <div style="width: 20px; height: 20px; border: 2px solid #e0e0e0; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                    ${currentTheme === 'system' ? '<div style="width: 12px; height: 12px; border-radius: 50%; background-color: #ff69b4;"></div>' : ''}
                                </div>
                            </div>
                        </div>
                        <button onclick="saveThemeSettings()" style="margin-top: 20px; width: 100%; padding: 12px; background-color: #ff69b4; border: none; border-radius: 8px; color: white; font-size: 16px;">‰øùÂ≠ò</button>
                    </div>
                `;
                
                // ÂàõÂª∫ÂºπÁ™ó
                const modal = document.createElement('div');
                modal.style.position = 'fixed';
                modal.style.top = '0';
                modal.style.left = '0';
                modal.style.width = '100%';
                modal.style.height = '100%';
                modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
                modal.style.display = 'flex';
                modal.style.alignItems = 'center';
                modal.style.justifyContent = 'center';
                modal.style.zIndex = '1000';
                
                const content = document.createElement('div');
                content.style.backgroundColor = 'white';
                content.style.borderRadius = '12px';
                content.style.width = '90%';
                content.style.maxWidth = '400px';
                content.innerHTML = html;
                
                modal.appendChild(content);
                document.body.appendChild(modal);
                
                // Ê∑ªÂä†ÂÖ≥Èó≠ÂäüËÉΩ
                modal.onclick = function(e) {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                    }
                };
            } catch (error) {
                console.error("ÊòæÁ§∫‰∏ªÈ¢òÊ®°ÂºèËÆæÁΩÆÂ§±Ë¥•Ôºö", error);
            }
        }
        
        function saveThemeSettings() {
            try {
                // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†‰∏ªÈ¢òÂàáÊç¢ÈÄªËæë
                saveWechatSettings();
                alert('ËÆæÁΩÆÂ∑≤‰øùÂ≠ò');
                // ÂÖ≥Èó≠ÂºπÁ™ó
                const modal = document.querySelector('div[style*="position: fixed"]');
                if (modal) {
                    document.body.removeChild(modal);
                }
            } catch (error) {
                console.error("‰øùÂ≠ò‰∏ªÈ¢òËÆæÁΩÆÂ§±Ë¥•Ôºö", error);
                alert('‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
            }
        }
        
        function showBubbleSettings() {
            try {
                alert('ËÅäÂ§©Ê∞îÊ≥°Ëá™ÂÆö‰πâËÆæÁΩÆÂºÄÂèë‰∏≠');
            } catch (error) {
                console.error("ÊòæÁ§∫ËÅäÂ§©Ê∞îÊ≥°ËÆæÁΩÆÂ§±Ë¥•Ôºö", error);
            }
        }
        
        function showAIModelSettings() {
            try {
                // Ëé∑ÂèñÂΩìÂâçAIÈÖçÁΩÆ
                const aiConfig = JSON.parse(localStorage.getItem('wechatAIConfig') || localStorage.getItem('aiPhoneConfig') || '{}');
                
                const html = `
                    <div style="padding: 20px;">
                        <h3 style="font-size: 16px; font-weight: 500; margin-bottom: 16px;">AIÊ®°ÂûãÈÖçÁΩÆ</h3>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-size: 14px; color: #999; margin-bottom: 4px;">ÂêçÁß∞</label>
                            <input type="text" id="wechatConfigName" value="${aiConfig.name || 'ÂæÆ‰ø°APIËøûÊé•'}" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-size: 14px; color: #999; margin-bottom: 4px;">Ê®°ÂûãÂπ≥Âè∞</label>
                            <select id="wechatPlatformSelect" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px; background-color: white;">
                                <option value="openai" ${aiConfig.platform === 'openai' ? 'selected' : ''}>OpenAI</option>
                                <option value="doubao" ${aiConfig.platform === 'doubao' ? 'selected' : ''}>Doubao (Ë±ÜÂåÖ/ÁÅ´Â±±‰∫ë/Â≠óËäÇË∑≥Âä®)</option>
                                <option value="deepseek" ${aiConfig.platform === 'deepseek' ? 'selected' : ''}>DeepSeek (Ê∑±Â∫¶Ê±ÇÁ¥¢)</option>
                                <option value="openrouter" ${aiConfig.platform === 'openrouter' ? 'selected' : ''}>OpenRouter</option>
                                <option value="custom-openai" ${aiConfig.platform === 'custom-openai' ? 'selected' : ''}>Ëá™ÂÆö‰πâ (OpenAI ÂçèËÆÆ)</option>
                            </select>
                        </div>
                        <div id="wechatApiUrlItem" style="margin-bottom: 16px; ${aiConfig.platform === 'custom-openai' ? 'display: block;' : 'display: none;'}">
                            <label style="display: block; font-size: 14px; color: #999; margin-bottom: 4px;">API Êé•Âè£Âú∞ÂùÄ</label>
                            <input type="text" id="wechatApiUrlInput" value="${aiConfig.apiUrl || ''}" placeholder="https://api.example.com/v1" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-size: 14px; color: #999; margin-bottom: 4px;">API ÂØÜÈí•</label>
                            <input type="password" id="wechatApiKeyInput" value="${aiConfig.apiKey || ''}" placeholder="ËæìÂÖ•‰Ω†ÁöÑ API Key" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-size: 14px; color: #999; margin-bottom: 4px;">Ê®°Âûã</label>
                            <select id="wechatModelSelect" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px; background-color: white;">
                                <option value="">ËØ∑ÂÖàÊãâÂèñÊ®°Âûã</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                            <button id="wechatFetchModelsBtn" style="flex: 1; padding: 10px; background-color: #ff69b4; border: none; border-radius: 8px; color: white; font-size: 14px;">ÊãâÂèñÊ®°Âûã</button>
                            <button id="wechatTestConnectionBtn" style="flex: 1; padding: 10px; background-color: #333; border: none; border-radius: 8px; color: white; font-size: 14px;">ÊµãËØïÈìæÊé•</button>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button id="wechatSaveConfigBtn" style="flex: 1; padding: 10px; background-color: #ff69b4; border: none; border-radius: 8px; color: white; font-size: 14px;">‰øùÂ≠ò</button>
                            <button id="wechatCloseConfigBtn" style="flex: 1; padding: 10px; background-color: #333; border: none; border-radius: 8px; color: white; font-size: 14px;">ÂÖ≥Èó≠</button>
                        </div>
                    </div>
                `;
                
                // ÂàõÂª∫ÂºπÁ™ó
                const modal = document.createElement('div');
                modal.style.position = 'fixed';
                modal.style.top = '0';
                modal.style.left = '0';
                modal.style.width = '100%';
                modal.style.height = '100%';
                modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
                modal.style.display = 'flex';
                modal.style.alignItems = 'center';
                modal.style.justifyContent = 'center';
                modal.style.zIndex = '1000';
                
                const content = document.createElement('div');
                content.style.backgroundColor = 'white';
                content.style.borderRadius = '12px';
                content.style.width = '90%';
                content.style.maxWidth = '400px';
                content.style.maxHeight = '80%';
                content.style.overflowY = 'auto';
                content.innerHTML = html;
                
                modal.appendChild(content);
                document.body.appendChild(modal);
                
                // Ê∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨
                const platformSelect = document.getElementById('wechatPlatformSelect');
                const apiUrlItem = document.getElementById('wechatApiUrlItem');
                
                platformSelect.addEventListener('change', function() {
                    if (this.value === 'custom-openai') {
                        apiUrlItem.style.display = 'block';
                    } else {
                        apiUrlItem.style.display = 'none';
                    }
                });
                
                document.getElementById('wechatFetchModelsBtn').addEventListener('click', function() {
                    fetchWechatModels(modal);
                });
                
                document.getElementById('wechatTestConnectionBtn').addEventListener('click', function() {
                    testWechatConnection(modal);
                });
                
                document.getElementById('wechatSaveConfigBtn').addEventListener('click', function() {
                    saveWechatAIConfig(modal);
                });
                
                document.getElementById('wechatCloseConfigBtn').addEventListener('click', function() {
                    document.body.removeChild(modal);
                });
                
                // Âä†ËΩΩÊ®°ÂûãÂàóË°®
                loadWechatModelList(aiConfig);
                
            } catch (error) {
                console.error("ÊòæÁ§∫AIÊ®°ÂûãËÆæÁΩÆÂ§±Ë¥•Ôºö", error);
                alert('ÊòæÁ§∫ËÆæÁΩÆÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
            }
        }
        
        function showAPIConfigSettings() {
            showAIModelSettings();
        }
        
        // Âä†ËΩΩÂæÆ‰ø°Ê®°ÂûãÂàóË°®
        function loadWechatModelList(aiConfig) {
            try {
                const modelSelect = document.getElementById('wechatModelSelect');
                modelSelect.innerHTML = '';
                
                const platform = aiConfig.platform || 'openai';
                let models = [];
                
                // È¶ñÂÖàÊ£ÄÊü•ÊòØÂê¶ÊúâÂ∑≤ÊãâÂèñÁöÑÊ®°Âûã
                if (aiConfig.fetchedModels && aiConfig.fetchedModels.length > 0) {
                    models = aiConfig.fetchedModels;
                } else {
                    // Â¶ÇÊûúÊ≤°ÊúâÂ∑≤ÊãâÂèñÁöÑÊ®°ÂûãÔºå‰ΩøÁî®Á°¨ÁºñÁ†ÅÂàóË°®
                    models = {
                        openai: ['gpt-3.5-turbo', 'gpt-4', 'gpt-4-turbo'],
                        doubao: ['ep-20240101150000-x1234'],
                        deepseek: ['deepseek-chat'],
                        openrouter: ['openai/gpt-3.5-turbo'],
                        'custom-openai': []
                    }[platform] || [];
                }
                
                if (models.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'ËØ∑ÂÖàÊãâÂèñÊ®°Âûã';
                    modelSelect.appendChild(option);
                } else {
                    models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = model;
                        if (model === aiConfig.model) {
                            option.selected = true;
                        }
                        modelSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error("Âä†ËΩΩÊ®°ÂûãÂàóË°®Â§±Ë¥•Ôºö", error);
            }
        }
        
        // ÊãâÂèñÂæÆ‰ø°Ê®°Âûã
        async function fetchWechatModels(modal) {
            try {
                const apiUrl = document.getElementById('wechatApiUrlInput').value.trim();
                const apiKey = document.getElementById('wechatApiKeyInput').value.trim();
                const platform = document.getElementById('wechatPlatformSelect').value;
                
                if (platform !== 'custom-openai' || !apiUrl || !apiKey) {
                    alert('ËØ∑ÈÄâÊã©Ëá™ÂÆö‰πâOpenAIÂπ≥Âè∞Âπ∂Â°´ÂÜôAPIÊé•Âè£Âú∞ÂùÄÂíåÂØÜÈí•');
                    return;
                }
                
                // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
                const fetchBtn = document.getElementById('wechatFetchModelsBtn');
                const originalText = fetchBtn.textContent;
                fetchBtn.textContent = 'ÊãâÂèñ‰∏≠...';
                fetchBtn.disabled = true;
                
                // Ë∞ÉÁî®ÂêéÁ´ØAPIÊãâÂèñÊ®°Âûã
                const response = await fetch(API_BASE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        platform: 'custom-openai',
                        apiKey: apiKey,
                        apiUrl: apiUrl,
                        action: 'fetchModels'
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                const models = data.data || [];
                
                if (models.length === 0) {
                    alert('Êú™Ëé∑ÂèñÂà∞‰ªª‰ΩïÊ®°Âûã');
                    return;
                }
                
                // Êõ¥Êñ∞Ê®°ÂûãÂàóË°®
                const modelSelect = document.getElementById('wechatModelSelect');
                modelSelect.innerHTML = '';
                
                const modelIds = [];
                models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.id;
                    option.textContent = model.id;
                    modelSelect.appendChild(option);
                    modelIds.push(model.id);
                });
                
                // ‰øùÂ≠òÊ®°ÂûãÂàóË°®Âà∞Êú¨Âú∞Â≠òÂÇ®
                const aiConfig = JSON.parse(localStorage.getItem('wechatAIConfig') || '{}');
                aiConfig.fetchedModels = modelIds;
                localStorage.setItem('wechatAIConfig', JSON.stringify(aiConfig));
                
                alert(`ÊàêÂäüÊãâÂèñÂà∞ ${models.length} ‰∏™Ê®°Âûã`);
                
            } catch (error) {
                console.error("ÊãâÂèñÊ®°ÂûãÂ§±Ë¥•Ôºö", error);
                alert(`ÊãâÂèñÊ®°ÂûãÂ§±Ë¥•Ôºö${error.message}`);
            } finally {
                const fetchBtn = document.getElementById('wechatFetchModelsBtn');
                fetchBtn.textContent = 'ÊãâÂèñÊ®°Âûã';
                fetchBtn.disabled = false;
            }
        }
        
        // ÊµãËØïÂæÆ‰ø°ËøûÊé•
        async function testWechatConnection(modal) {
            try {
                const apiUrl = document.getElementById('wechatApiUrlInput').value.trim();
                const apiKey = document.getElementById('wechatApiKeyInput').value.trim();
                const platform = document.getElementById('wechatPlatformSelect').value;
                
                if (platform !== 'custom-openai' || !apiUrl || !apiKey) {
                    alert('ËØ∑ÈÄâÊã©Ëá™ÂÆö‰πâOpenAIÂπ≥Âè∞Âπ∂Â°´ÂÜôAPIÊé•Âè£Âú∞ÂùÄÂíåÂØÜÈí•');
                    return;
                }
                
                // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
                const testBtn = document.getElementById('wechatTestConnectionBtn');
                const originalText = testBtn.textContent;
                testBtn.textContent = 'ÊµãËØï‰∏≠...';
                testBtn.disabled = true;
                
                // Ë∞ÉÁî®ÂêéÁ´ØAPIÊµãËØïËøûÊé•
                const response = await fetch(API_BASE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        platform: 'custom-openai',
                        apiKey: apiKey,
                        apiUrl: apiUrl,
                        action: 'testConnection'
                    })
                });
                
                if (response.ok) {
                    alert('ËøûÊé•ÊàêÂäüÔºÅ');
                } else {
                    const errorData = await response.json().catch(() => ({ error: 'ËøûÊé•Â§±Ë¥•' }));
                    alert(`ËøûÊé•Â§±Ë¥•Ôºö${errorData.error || 'Êú™Áü•ÈîôËØØ'}`);
                }
                
            } catch (error) {
                console.error("ÊµãËØïËøûÊé•Â§±Ë¥•Ôºö", error);
                alert(`ÊµãËØïËøûÊé•Â§±Ë¥•Ôºö${error.message}`);
            } finally {
                const testBtn = document.getElementById('wechatTestConnectionBtn');
                testBtn.textContent = 'ÊµãËØïÈìæÊé•';
                testBtn.disabled = false;
            }
        }
        
        // ‰øùÂ≠òÂæÆ‰ø°AIÈÖçÁΩÆ
        function saveWechatAIConfig(modal) {
            try {
                // Ëé∑ÂèñÂΩìÂâçÈÖçÁΩÆÔºåÂåÖÂê´Â∑≤ÊãâÂèñÁöÑÊ®°ÂûãÂàóË°®
                const existingConfig = JSON.parse(localStorage.getItem('wechatAIConfig') || '{}');
                const config = {
                    name: document.getElementById('wechatConfigName').value,
                    platform: document.getElementById('wechatPlatformSelect').value,
                    apiUrl: document.getElementById('wechatApiUrlInput').value,
                    apiKey: document.getElementById('wechatApiKeyInput').value,
                    model: document.getElementById('wechatModelSelect').value,
                    fetchedModels: existingConfig.fetchedModels || []
                };
                
                localStorage.setItem('wechatAIConfig', JSON.stringify(config));
                alert('ÈÖçÁΩÆÂ∑≤‰øùÂ≠ò');
                document.body.removeChild(modal);
            } catch (error) {
                console.error("‰øùÂ≠òÈÖçÁΩÆÂ§±Ë¥•Ôºö", error);
                alert('‰øùÂ≠òÈÖçÁΩÆÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
            }
        }
        
        function showGeneralSettings() {
            try {
                // ÂàõÂª∫ËÆæÁΩÆÈù¢Êùø
                const panel = document.createElement('div');
                panel.style.position = 'fixed';
                panel.style.top = '0';
                panel.style.left = '0';
                panel.style.width = '100%';
                panel.style.height = '100%';
                panel.style.backgroundColor = 'rgba(0,0,0,0.5)';
                panel.style.display = 'flex';
                panel.style.alignItems = 'center';
                panel.style.justifyContent = 'center';
                panel.style.zIndex = '1000';
                
                const content = document.createElement('div');
                content.style.backgroundColor = 'white';
                content.style.borderRadius = '12px';
                content.style.width = '90%';
                content.style.maxWidth = '400px';
                content.style.maxHeight = '80%';
                content.style.overflowY = 'auto';
                content.style.padding = '20px';
                
                // Èù¢ÊùøÂ§¥ÈÉ®
                const header = document.createElement('div');
                header.style.display = 'flex';
                header.style.justifyContent = 'space-between';
                header.style.alignItems = 'center';
                header.style.marginBottom = '20px';
                
                const title = document.createElement('h3');
                title.style.fontSize = '16px';
                title.style.fontWeight = '500';
                title.textContent = 'ÈÄöÁî®ËÆæÁΩÆ';
                
                const closeBtn = document.createElement('button');
                closeBtn.style.background = 'none';
                closeBtn.style.border = 'none';
                closeBtn.style.fontSize = '20px';
                closeBtn.style.cursor = 'pointer';
                closeBtn.textContent = '√ó';
                closeBtn.onclick = function() {
                    document.body.removeChild(panel);
                };
                
                header.appendChild(title);
                header.appendChild(closeBtn);
                content.appendChild(header);
                
                // Ê∂àÊÅØÊúóËØªÂäüËÉΩÂºÄÂÖ≥
                const speechSection = document.createElement('div');
                speechSection.style.marginBottom = '20px';
                
                const speechSectionTitle = document.createElement('div');
                speechSectionTitle.style.fontSize = '14px';
                speechSectionTitle.style.fontWeight = '500';
                speechSectionTitle.style.marginBottom = '10px';
                speechSectionTitle.textContent = 'Ê∂àÊÅØÊúóËØªËÆæÁΩÆ';
                
                speechSection.appendChild(speechSectionTitle);
                
                // Ëé∑ÂèñÂΩìÂâçËØ≠Èü≥ËÆæÁΩÆ
                const voiceConfig = JSON.parse(localStorage.getItem('voiceConfig') || '{}');
                const speechEnabled = voiceConfig.speechEnabled !== undefined ? voiceConfig.speechEnabled : true;
                
                // Ê∂àÊÅØÊúóËØªÂºÄÂÖ≥
                const speechToggle = document.createElement('div');
                speechToggle.style.display = 'flex';
                speechToggle.style.alignItems = 'center';
                speechToggle.style.justifyContent = 'space-between';
                speechToggle.style.padding = '10px 0';
                speechToggle.innerHTML = `
                    <div style="font-size: 14px;">ÂêØÁî®Ê∂àÊÅØÊúóËØª</div>
                    <label style="position: relative; display: inline-block; width: 50px; height: 24px;">
                        <input type="checkbox" id="speechEnabled" ${speechEnabled ? 'checked' : ''} style="opacity: 0; width: 0; height: 0;">
                        <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: ${speechEnabled ? '#ff69b4' : '#ccc'}; transition: .4s; border-radius: 24px;"></span>
                        <span style="position: absolute; cursor: pointer; top: 2px; left: ${speechEnabled ? '28px' : '2px'}; bottom: 2px; width: 20px; background-color: white; transition: .4s; border-radius: 50%;"></span>
                    </label>
                `;
                speechSection.appendChild(speechToggle);
                
                // ‰øùÂ≠òËØ≠Èü≥ËÆæÁΩÆÊåâÈíÆ
                const saveSpeechBtn = document.createElement('button');
                saveSpeechBtn.style.width = '100%';
                saveSpeechBtn.style.padding = '12px';
                saveSpeechBtn.style.backgroundColor = '#ff69b4';
                saveSpeechBtn.style.border = 'none';
                saveSpeechBtn.style.borderRadius = '8px';
                saveSpeechBtn.style.color = 'white';
                saveSpeechBtn.style.fontSize = '16px';
                saveSpeechBtn.style.fontWeight = '500';
                saveSpeechBtn.style.cursor = 'pointer';
                saveSpeechBtn.textContent = '‰øùÂ≠òÊúóËØªËÆæÁΩÆ';
                saveSpeechBtn.onclick = function() {
                    const enabled = document.getElementById('speechEnabled').checked;
                    const updatedConfig = {
                        ...voiceConfig,
                        speechEnabled: enabled
                    };
                    localStorage.setItem('voiceConfig', JSON.stringify(updatedConfig));
                    alert('ÊúóËØªËÆæÁΩÆÂ∑≤‰øùÂ≠òÔºÅ');
                };
                
                speechSection.appendChild(saveSpeechBtn);
                content.appendChild(speechSection);
                
                // ÂõæÁâáËØÜÂà´APIËÆæÁΩÆ
                const imageRecognitionSection = document.createElement('div');
                imageRecognitionSection.style.marginBottom = '20px';
                
                const sectionTitle = document.createElement('div');
                sectionTitle.style.fontSize = '14px';
                sectionTitle.style.fontWeight = '500';
                sectionTitle.style.marginBottom = '10px';
                sectionTitle.textContent = 'ËØÜÂõæAPI';
                
                imageRecognitionSection.appendChild(sectionTitle);
                
                // Ëé∑ÂèñÂΩìÂâçÈÖçÁΩÆ
                const imageRecognitionConfig = JSON.parse(localStorage.getItem('imageRecognitionConfig') || '{}');
                
                // APIÂØÜÈí•ËæìÂÖ•
                const apiKeyInput = document.createElement('div');
                apiKeyInput.style.marginBottom = '10px';
                apiKeyInput.innerHTML = `
                    <label style="display: block; font-size: 12px; color: #999; margin-bottom: 4px;">ËæìÂÖ•‰Ω†ÁöÑ API Key</label>
                    <input type="password" id="imageApiKey" value="${imageRecognitionConfig.apiKey || ''}" placeholder="ËæìÂÖ•‰Ω†ÁöÑ API Key" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                `;
                imageRecognitionSection.appendChild(apiKeyInput);
                
                // APIÂú∞ÂùÄËæìÂÖ•
                const apiUrlInput = document.createElement('div');
                apiUrlInput.style.marginBottom = '10px';
                apiUrlInput.innerHTML = `
                    <label style="display: block; font-size: 12px; color: #999; margin-bottom: 4px;">API Êé•Âè£Âú∞ÂùÄ</label>
                    <input type="text" id="imageApiUrl" value="${imageRecognitionConfig.apiUrl || 'https://api.openai.com/v1/chat/completions'}" placeholder="https://api.openai.com/v1/chat/completions" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                `;
                imageRecognitionSection.appendChild(apiUrlInput);
                
                // Ê®°ÂûãÈÄâÊã©
                const modelSelect = document.createElement('div');
                modelSelect.style.marginBottom = '10px';
                modelSelect.innerHTML = `
                    <label style="display: block; font-size: 12px; color: #999; margin-bottom: 4px;">Ê®°Âûã</label>
                    <select id="imageModelSelect" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px; background-color: white;">
                        <option value="gpt-4-vision-preview" ${imageRecognitionConfig.model === 'gpt-4-vision-preview' ? 'selected' : ''}>gpt-4-vision-preview</option>
                        <option value="gpt-4-turbo" ${imageRecognitionConfig.model === 'gpt-4-turbo' ? 'selected' : ''}>gpt-4-turbo</option>
                    </select>
                `;
                imageRecognitionSection.appendChild(modelSelect);
                
                // ‰øùÂ≠òÊåâÈíÆ
                const saveBtn = document.createElement('button');
                saveBtn.style.width = '100%';
                saveBtn.style.padding = '12px';
                saveBtn.style.backgroundColor = '#ff69b4';
                saveBtn.style.border = 'none';
                saveBtn.style.borderRadius = '8px';
                saveBtn.style.color = 'white';
                saveBtn.style.fontSize = '16px';
                saveBtn.style.fontWeight = '500';
                saveBtn.style.cursor = 'pointer';
                saveBtn.textContent = '‰øùÂ≠òËÆæÁΩÆ';
                saveBtn.onclick = function() {
                    const config = {
                        apiKey: document.getElementById('imageApiKey').value,
                        apiUrl: document.getElementById('imageApiUrl').value,
                        model: document.getElementById('imageModelSelect').value
                    };
                    localStorage.setItem('imageRecognitionConfig', JSON.stringify(config));
                    alert('ËÆæÁΩÆÂ∑≤‰øùÂ≠òÔºÅ');
                };
                
                imageRecognitionSection.appendChild(saveBtn);
                content.appendChild(imageRecognitionSection);
                
                // ËØ≠Èü≥ËÆæÁΩÆ
                const voiceSection = document.createElement('div');
                voiceSection.style.marginBottom = '20px';
                
                const voiceSectionTitle = document.createElement('div');
                voiceSectionTitle.style.fontSize = '14px';
                voiceSectionTitle.style.fontWeight = '500';
                voiceSectionTitle.style.marginBottom = '10px';
                voiceSectionTitle.textContent = 'ËØ≠Èü≥ËØÜÂà´ËÆæÁΩÆ';
                
                voiceSection.appendChild(voiceSectionTitle);
                
                // ËØ≠Èü≥ËØÜÂà´APIÈÄâÊã©
                const speechRecognitionApiSelect = document.createElement('div');
                speechRecognitionApiSelect.style.marginBottom = '10px';
                speechRecognitionApiSelect.innerHTML = `
                    <label style="display: block; font-size: 12px; color: #999; margin-bottom: 4px;">ËØ≠Èü≥ËØÜÂà´API</label>
                    <select id="speechRecognitionApi" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px; background-color: white;">
                        <option value="web-speech-api" ${voiceConfig.speechRecognitionApi === 'web-speech-api' ? 'selected' : ''}>Web Speech API</option>
                        <option value="custom" ${voiceConfig.speechRecognitionApi === 'custom' ? 'selected' : ''}>Ëá™ÂÆö‰πâAPI</option>
                    </select>
                `;
                voiceSection.appendChild(speechRecognitionApiSelect);
                
                // ËØ≠Èü≥ÂêàÊàêAPIÈÄâÊã©
                const speechSynthesisApiSelect = document.createElement('div');
                speechSynthesisApiSelect.style.marginBottom = '10px';
                speechSynthesisApiSelect.innerHTML = `
                    <label style="display: block; font-size: 12px; color: #999; margin-bottom: 4px;">ËØ≠Èü≥ÂêàÊàêAPI</label>
                    <select id="speechSynthesisApi" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px; background-color: white;">
                        <option value="web-speech-api" ${voiceConfig.speechSynthesisApi === 'web-speech-api' ? 'selected' : ''}>Web Speech API</option>
                        <option value="custom" ${voiceConfig.speechSynthesisApi === 'custom' ? 'selected' : ''}>Ëá™ÂÆö‰πâAPI</option>
                    </select>
                `;
                voiceSection.appendChild(speechSynthesisApiSelect);
                
                // ËØ≠Èü≥ËØÜÂà´ËØ≠Ë®ÄÈÄâÊã©
                const languageSelect = document.createElement('div');
                languageSelect.style.marginBottom = '10px';
                languageSelect.innerHTML = `
                    <label style="display: block; font-size: 12px; color: #999; margin-bottom: 4px;">ËÆæÁΩÆËØÜÂà´ËØ≠Ë®Ä</label>
                    <select id="recognitionLanguage" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px; background-color: white;">
                        <option value="zh-CN" ${voiceConfig.recognitionLanguage === 'zh-CN' ? 'selected' : ''}>‰∏≠Êñá (zh-CN)</option>
                        <option value="en-US" ${voiceConfig.recognitionLanguage === 'en-US' ? 'selected' : ''}>Ëã±Êñá (en-US)</option>
                    </select>
                `;
                voiceSection.appendChild(languageSelect);
                
                // ‰øùÂ≠òËØ≠Èü≥ËÆæÁΩÆÊåâÈíÆ
                const saveVoiceBtn = document.createElement('button');
                saveVoiceBtn.style.width = '100%';
                saveVoiceBtn.style.padding = '12px';
                saveVoiceBtn.style.backgroundColor = '#ff69b4';
                saveVoiceBtn.style.border = 'none';
                saveVoiceBtn.style.borderRadius = '8px';
                saveVoiceBtn.style.color = 'white';
                saveVoiceBtn.style.fontSize = '16px';
                saveVoiceBtn.style.fontWeight = '500';
                saveVoiceBtn.style.cursor = 'pointer';
                saveVoiceBtn.textContent = '‰øùÂ≠òËØ≠Èü≥ËÆæÁΩÆ';
                saveVoiceBtn.onclick = function() {
                    const config = {
                        ...voiceConfig,
                        speechRecognitionApi: document.getElementById('speechRecognitionApi').value,
                        speechSynthesisApi: document.getElementById('speechSynthesisApi').value,
                        recognitionLanguage: document.getElementById('recognitionLanguage').value
                    };
                    localStorage.setItem('voiceConfig', JSON.stringify(config));
                    alert('ËØ≠Èü≥ËÆæÁΩÆÂ∑≤‰øùÂ≠òÔºÅ');
                };
                
                voiceSection.appendChild(saveVoiceBtn);
                content.appendChild(voiceSection);
                
                // Áî®Êà∑Ë¥¶Âè∑Á≥ªÁªüËÆæÁΩÆ
                const accountSection = document.createElement('div');
                accountSection.style.marginBottom = '20px';
                
                const accountSectionTitle = document.createElement('div');
                accountSectionTitle.style.fontSize = '14px';
                accountSectionTitle.style.fontWeight = '500';
                accountSectionTitle.style.marginBottom = '10px';
                accountSectionTitle.textContent = 'Ë¥¶Âè∑ËÆæÁΩÆ';
                
                accountSection.appendChild(accountSectionTitle);
                
                // Ëé∑ÂèñÂΩìÂâçË¥¶Âè∑ÈÖçÁΩÆ
                const accountConfig = JSON.parse(localStorage.getItem('accountConfig') || '{}');
                
                // Ë¥¶Âè∑‰ø°ÊÅØ
                const accountInfo = document.createElement('div');
                accountInfo.style.marginBottom = '10px';
                accountInfo.innerHTML = `
                    <div style="font-size: 14px; margin-bottom: 5px;">Ë¥¶Âè∑Áä∂ÊÄÅ: ${accountConfig.loggedIn ? 'Â∑≤ÁôªÂΩï' : 'Êú™ÁôªÂΩï'}</div>
                    <div style="font-size: 12px; color: #999; margin-bottom: 10px;">ÁôªÂΩïÂêéÂèØÂÆûÁé∞Êï∞ÊçÆÊåÅ‰πÖÂåñÂ≠òÂÇ®</div>
                `;
                accountSection.appendChild(accountInfo);
                
                // ÁôªÂΩï/Ê≥®ÂÜåÊåâÈíÆ
                const accountBtn = document.createElement('button');
                accountBtn.style.width = '100%';
                accountBtn.style.padding = '12px';
                accountBtn.style.backgroundColor = '#ff69b4';
                accountBtn.style.border = 'none';
                accountBtn.style.borderRadius = '8px';
                accountBtn.style.color = 'white';
                accountBtn.style.fontSize = '16px';
                accountBtn.style.fontWeight = '500';
                accountBtn.style.cursor = 'pointer';
                accountBtn.textContent = accountConfig.loggedIn ? 'ÈÄÄÂá∫ÁôªÂΩï' : 'ÁôªÂΩï/Ê≥®ÂÜå';
                accountBtn.onclick = function() {
                    if (accountConfig.loggedIn) {
                        if (confirm('Á°ÆÂÆöË¶ÅÈÄÄÂá∫ÁôªÂΩïÂêóÔºü')) {
                            localStorage.setItem('accountConfig', JSON.stringify({ loggedIn: false }));
                            alert('ÈÄÄÂá∫ÁôªÂΩïÊàêÂäü');
                            document.body.removeChild(panel);
                            showGeneralSettings();
                            // ÈÄÄÂá∫ÁôªÂΩïÂêéÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
                            reloadWechatData();
                        }
                    } else {
                        // ÊòæÁ§∫ÁôªÂΩï/Ê≥®ÂÜåË°®Âçï
                        showLoginRegisterForm(panel);
                    }
                };
                
                // ÁôªÂΩï/Ê≥®ÂÜåË°®Âçï
                function showLoginRegisterForm(panel) {
                    const formPanel = document.createElement('div');
                    formPanel.style.position = 'fixed';
                    formPanel.style.top = '0';
                    formPanel.style.left = '0';
                    formPanel.style.width = '100%';
                    formPanel.style.height = '100%';
                    formPanel.style.backgroundColor = 'rgba(0,0,0,0.5)';
                    formPanel.style.display = 'flex';
                    formPanel.style.alignItems = 'center';
                    formPanel.style.justifyContent = 'center';
                    formPanel.style.zIndex = '1002';
                    
                    const formContent = document.createElement('div');
                    formContent.style.backgroundColor = 'white';
                    formContent.style.borderRadius = '12px';
                    formContent.style.width = '90%';
                    formContent.style.maxWidth = '400px';
                    formContent.style.padding = '20px';
                    
                    let isRegister = false;
                    
                    function renderForm() {
                        formContent.innerHTML = `
                            <div style="text-align: center; margin-bottom: 20px;">
                                <h3 style="font-size: 18px; font-weight: 500; margin-bottom: 10px;">${isRegister ? 'Ê≥®ÂÜåË¥¶Âè∑' : 'ÁôªÂΩïË¥¶Âè∑'}</h3>
                                <div style="font-size: 12px; color: #999; margin-bottom: 20px;">
                                    ${isRegister ? 'ËØ∑Â°´ÂÜô‰ª•‰∏ã‰ø°ÊÅØÊ≥®ÂÜåË¥¶Âè∑' : 'ËØ∑ËæìÂÖ•Ë¥¶Âè∑‰ø°ÊÅØÁôªÂΩï'}
                                </div>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; font-size: 12px; color: #999; margin-bottom: 4px;">Áî®Êà∑Âêç</label>
                                <input type="text" id="loginUsername" placeholder="ËØ∑ËæìÂÖ•Áî®Êà∑Âêç" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                                <div style="font-size: 11px; color: #999; margin-top: 4px;">ÊîØÊåÅ‰∏≠Ëã±Êñá„ÄÅÊï∞Â≠óÔºåÈïøÂ∫¶3-20‰Ωç</div>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; font-size: 12px; color: #999; margin-bottom: 4px;">ÂØÜÁ†Å</label>
                                <input type="password" id="loginPassword" placeholder="ËØ∑ËæìÂÖ•ÂØÜÁ†Å" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                                <div style="font-size: 11px; color: #999; margin-top: 4px;">ÈïøÂ∫¶8-20‰ΩçÔºåÈúÄÂåÖÂê´Â§ßÂ∞èÂÜôÂ≠óÊØç„ÄÅÊï∞Â≠óÂíåÁâπÊÆäÁ¨¶Âè∑</div>
                            </div>
                            ${isRegister ? `
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; font-size: 12px; color: #999; margin-bottom: 4px;">Á°ÆËÆ§ÂØÜÁ†Å</label>
                                    <input type="password" id="loginConfirmPassword" placeholder="ËØ∑ÂÜçÊ¨°ËæìÂÖ•ÂØÜÁ†Å" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                                </div>
                            ` : ''}
                            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                                <button id="submitBtn" style="flex: 1; padding: 12px; background-color: #ff69b4; border: none; border-radius: 8px; color: white; font-size: 14px; cursor: pointer;">
                                    ${isRegister ? 'Ê≥®ÂÜå' : 'ÁôªÂΩï'}
                                </button>
                                <button id="cancelBtn" style="flex: 1; padding: 12px; background-color: #f0f0f0; border: none; border-radius: 8px; font-size: 14px; cursor: pointer;">ÂèñÊ∂à</button>
                            </div>
                            <div style="text-align: center;">
                                <button id="toggleBtn" style="background: none; border: none; font-size: 12px; color: #ff69b4; cursor: pointer;">
                                    ${isRegister ? 'Â∑≤ÊúâË¥¶Âè∑ÔºüÁÇπÂáªÁôªÂΩï' : 'Ê≤°ÊúâË¥¶Âè∑ÔºüÁÇπÂáªÊ≥®ÂÜå'}
                                </button>
                            </div>
                        `;
                    }
                    
                    renderForm();
                    
                    formPanel.appendChild(formContent);
                    document.body.appendChild(formPanel);
                    
                    // ÂàáÊç¢ÁôªÂΩï/Ê≥®ÂÜå
                    document.getElementById('toggleBtn').onclick = function() {
                        isRegister = !isRegister;
                        renderForm();
                        bindEvents();
                    };
                    
                    // ÂèñÊ∂àÊåâÈíÆ
                    document.getElementById('cancelBtn').onclick = function() {
                        document.body.removeChild(formPanel);
                    };
                    
                    // Êèê‰∫§ÊåâÈíÆ
                    function bindEvents() {
                        document.getElementById('submitBtn').onclick = function() {
                            const username = document.getElementById('loginUsername').value.trim();
                            const password = document.getElementById('loginPassword').value;
                            
                            if (!validateUsername(username)) {
                                alert('Áî®Êà∑Âêç‰∏çÁ¨¶ÂêàË¶ÅÊ±ÇÔºåÊîØÊåÅ‰∏≠Ëã±Êñá„ÄÅÊï∞Â≠óÔºåÈïøÂ∫¶3-20‰Ωç');
                                return;
                            }
                            
                            const passwordValidation = validatePassword(password);
                            if (!passwordValidation.valid) {
                                alert(passwordValidation.message);
                                return;
                            }
                            
                            if (isRegister) {
                                const confirmPassword = document.getElementById('loginConfirmPassword').value;
                                if (password !== confirmPassword) {
                                    alert('‰∏§Ê¨°ËæìÂÖ•ÁöÑÂØÜÁ†Å‰∏ç‰∏ÄËá¥ÔºåËØ∑ÈáçÊñ∞ËæìÂÖ•');
                                    return;
                                }
                                
                                // Ê≥®ÂÜåÈÄªËæë
                                registerUser(username, password);
                            } else {
                                // ÁôªÂΩïÈÄªËæë
                                loginUser(username, password);
                            }
                        };
                    }
                    
                    bindEvents();
                    
                    // È™åËØÅÁî®Êà∑Âêç
                    function validateUsername(username) {
                        // Áî®Êà∑ÂêçÈïøÂ∫¶3-20‰ΩçÔºåÊîØÊåÅ‰∏≠Ëã±Êñá„ÄÅÊï∞Â≠ó
                        const usernameRegex = /^[a-zA-Z0-9\u4e00-\u9fa5]{3,20}$/;
                        return usernameRegex.test(username);
                    }
                    
                    // È™åËØÅÂØÜÁ†Å
                    function validatePassword(password) {
                        // ÂØÜÁ†ÅÈïøÂ∫¶8-20‰ΩçÔºåÂåÖÂê´Â§ßÂ∞èÂÜôÂ≠óÊØç„ÄÅÊï∞Â≠óÂíåÁâπÊÆäÁ¨¶Âè∑
                        if (password.length < 8 || password.length > 20) {
                            return { valid: false, message: 'ÂØÜÁ†ÅÈïøÂ∫¶ÂøÖÈ°ªÂú®8-20‰Ωç‰πãÈó¥' };
                        }
                        
                        const hasUpper = /[A-Z]/.test(password);
                        const hasLower = /[a-z]/.test(password);
                        const hasNumber = /[0-9]/.test(password);
                        const hasSpecial = /[!@#$%^&*(),.?":{}|<>]/.test(password);
                        
                        if (!hasUpper) {
                            return { valid: false, message: 'ÂØÜÁ†ÅÂøÖÈ°ªÂåÖÂê´Â§ßÂÜôÂ≠óÊØç' };
                        }
                        if (!hasLower) {
                            return { valid: false, message: 'ÂØÜÁ†ÅÂøÖÈ°ªÂåÖÂê´Â∞èÂÜôÂ≠óÊØç' };
                        }
                        if (!hasNumber) {
                            return { valid: false, message: 'ÂØÜÁ†ÅÂøÖÈ°ªÂåÖÂê´Êï∞Â≠ó' };
                        }
                        if (!hasSpecial) {
                            return { valid: false, message: 'ÂØÜÁ†ÅÂøÖÈ°ªÂåÖÂê´ÁâπÊÆäÁ¨¶Âè∑' };
                        }
                        
                        return { valid: true };
                    }
                    
                    // Ê≥®ÂÜåÁî®Êà∑
                    function registerUser(username, password) {
                        // Ê£ÄÊü•Áî®Êà∑ÂêçÊòØÂê¶Â∑≤Â≠òÂú®
                        const existingUsers = JSON.parse(localStorage.getItem('registeredUsers') || '{}');
                        if (existingUsers[username]) {
                            alert('Áî®Êà∑ÂêçÂ∑≤Â≠òÂú®ÔºåËØ∑ÈÄâÊã©ÂÖ∂‰ªñÁî®Êà∑Âêç');
                            return;
                        }
                        
                        // ‰øùÂ≠òÁî®Êà∑‰ø°ÊÅØ
                        existingUsers[username] = password;
                        localStorage.setItem('registeredUsers', JSON.stringify(existingUsers));
                        
                        // Ëá™Âä®ÁôªÂΩï
                        localStorage.setItem('accountConfig', JSON.stringify({ loggedIn: true, username: username }));
                        alert('Ê≥®ÂÜåÊàêÂäüÔºÅÂ∑≤Ëá™Âä®ÁôªÂΩï');
                        document.body.removeChild(formPanel);
                        document.body.removeChild(panel);
                        // ÁôªÂΩïÂêéÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
                        reloadWechatData();
                        // ÈáçÊñ∞ÊòæÁ§∫ËÆæÁΩÆÈù¢Êùø‰ª•Êõ¥Êñ∞ÁôªÂΩïÁä∂ÊÄÅ
                        showGeneralSettings();
                    }
                    
                    // ÁôªÂΩïÁî®Êà∑
                    function loginUser(username, password) {
                        // È™åËØÅÁî®Êà∑‰ø°ÊÅØ
                        const existingUsers = JSON.parse(localStorage.getItem('registeredUsers') || '{}');
                        if (!existingUsers[username] || existingUsers[username] !== password) {
                            alert('Áî®Êà∑ÂêçÊàñÂØÜÁ†ÅÈîôËØØÔºåËØ∑ÈáçÊñ∞ËæìÂÖ•');
                            return;
                        }
                        
                        // ‰øùÂ≠òÁôªÂΩïÁä∂ÊÄÅ
                        localStorage.setItem('accountConfig', JSON.stringify({ loggedIn: true, username: username }));
                        alert('ÁôªÂΩïÊàêÂäüÔºÅ');
                        document.body.removeChild(formPanel);
                        document.body.removeChild(panel);
                        // ÁôªÂΩïÂêéÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
                        reloadWechatData();
                        // ÈáçÊñ∞ÊòæÁ§∫ËÆæÁΩÆÈù¢Êùø‰ª•Êõ¥Êñ∞ÁôªÂΩïÁä∂ÊÄÅ
                        showGeneralSettings();
                    }
                }
                

                
                accountSection.appendChild(accountBtn);
                content.appendChild(accountSection);
                
                panel.appendChild(content);
                document.body.appendChild(panel);
                
                // Ê∑ªÂä†ÂºÄÂÖ≥‰∫ã‰ª∂ÁõëÂê¨
                const speechEnabledCheckbox = document.getElementById('speechEnabled');
                if (speechEnabledCheckbox) {
                    speechEnabledCheckbox.addEventListener('change', function() {
                        const slider = this.nextElementSibling;
                        const knob = slider.nextElementSibling;
                        if (this.checked) {
                            slider.style.backgroundColor = '#ff69b4';
                            knob.style.left = '28px';
                        } else {
                            slider.style.backgroundColor = '#ccc';
                            knob.style.left = '2px';
                        }
                    });
                }
                
            } catch (error) {
                console.error("ÊòæÁ§∫ÈÄöÁî®ËÆæÁΩÆÂ§±Ë¥•Ôºö", error);
                alert('ËÆæÁΩÆÂäüËÉΩÂä†ËΩΩÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
            }
        }
        
        function logout() {
            if (confirm('Á°ÆÂÆöË¶ÅÈÄÄÂá∫ÁôªÂΩïÂêóÔºü')) {
                // Ê∏ÖÈô§ÁôªÂΩïÁä∂ÊÄÅ
                localStorage.setItem('accountConfig', JSON.stringify({ loggedIn: false }));
                alert('ÈÄÄÂá∫ÁôªÂΩïÊàêÂäü');
                // ÈÄÄÂá∫ÁôªÂΩïÂêéÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
                reloadWechatData();
            }
        }
        
        // ÈáçÊñ∞Âä†ËΩΩÂæÆ‰ø°Êï∞ÊçÆ
        function reloadWechatData() {
            loadWechatRoles();
            loadWechatSettings();
            loadMoments();
            renderMessageList();
            renderMomentsList();
            renderProfilePage();
        }
        
        // ==================== È°µÈù¢ÂàùÂßãÂåñ ====================
        window.addEventListener('DOMContentLoaded', function() {
            try {
                // ÂàùÂßãÂåñÂ£ÅÁ∫∏
                initWallpaperConfig();
                initTargetPageButtons();
                loadWallpaperGallery();
                
                // ÂàùÂßãÂåñAIÂäüËÉΩ
                initAIConfig();
                
                // ÂàùÂßãÂåñÂæÆ‰ø°Ê®°Âùó
                initWechat();
                
                // ÂàùÂßãÂåñÈîÅÂ±èÊó∂Èó¥
                updateLockTime();
                setInterval(updateLockTime, 1000);
                
                // ÈªòËÆ§ÊòæÁ§∫ÈîÅÂ±è
                goPage("lockScreen");
            } catch (error) {
                console.error("È°µÈù¢ÂàùÂßãÂåñÂ§±Ë¥•Ôºö", error);
                alert(`È°µÈù¢Âä†ËΩΩÂá∫ÈîôÔºö${error.message}`);
            }
        });
    </script>
</body>
</html>
